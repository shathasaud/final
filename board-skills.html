<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุฌุฏูู ุชูููู ุงูุทุงูุจุงุช</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet">
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Tajawal', 'Segoe UI', Tahoma, Arial, sans-serif;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      min-height: 100%;
      padding: 20px;
    }

    * {
      box-sizing: border-box;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: #ffffff;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Tajawal', 'Segoe UI', Tahoma, Arial, sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
    }

    .btn-primary:disabled {
      background: #bdbdbd;
      cursor: not-allowed;
      transform: none;
    }

    .btn-success {
      background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
      color: white;
      padding: 6px 12px;
      font-size: 10px;
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .evaluation-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1400px;
      font-size: 9px;
    }

    .evaluation-table th {
      background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
      color: white;
      padding: 8px 4px;
      font-size: 10px;
      font-weight: bold;
      text-align: center;
      border: 1px solid #1976d2;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .evaluation-table td {
      padding: 6px 4px;
      border: 1px solid #e0e0e0;
      text-align: center;
      font-size: 10px;
    }

    .evaluation-table tbody tr {
      transition: background-color 0.3s ease;
    }

    .evaluation-table tbody tr:hover {
      background: #e3f2fd;
    }

    .student-name-cell {
      font-weight: bold;
      color: #1565c0;
      text-align: right;
      min-width: 120px;
      max-width: 120px;
      position: sticky;
      right: 0;
      background: #fff;
      z-index: 5;
      font-size: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .evaluation-table tbody tr:hover .student-name-cell {
      background: #e3f2fd;
    }

    .select-field {
      width: 100%;
      padding: 4px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 9px;
      font-family: 'Tajawal', 'Segoe UI', Tahoma, Arial, sans-serif;
      transition: border-color 0.3s ease;
    }

    .select-field:focus {
      outline: none;
      border-color: #2196f3;
    }

    .level-innovation {
      background: #e8f5e9;
      color: #2e7d32;
      font-weight: bold;
    }

    .level-mastery {
      background: #e3f2fd;
      color: #1565c0;
      font-weight: bold;
    }

    .level-application {
      background: #fff3e0;
      color: #ef6c00;
      font-weight: bold;
    }

    .level-needs-support {
      background: #ffebee;
      color: #c62828;
      font-weight: bold;
    }

    .level-not-completed {
      background: #f5f5f5;
      color: #757575;
      font-weight: bold;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 24px;
      color: #1565c0;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: bold;
      color: #424242;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Tajawal', 'Segoe UI', Tahoma, Arial, sans-serif;
    }

    .form-input:focus {
      outline: none;
      border-color: #2196f3;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #757575;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .empty-state-text {
      font-size: 18px;
      margin-bottom: 25px;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #1565c0;
      font-size: 16px;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #e3f2fd;
      border-top-color: #1565c0;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><!-- Header Cards -->
   <div style="background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%); padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
    <div style="text-align: center; color: white;">
     <div style="font-size: 48px; margin-bottom: 10px;">
      ๐๐
     </div>
     <h1 style="margin: 0 0 8px 0; font-size: 28px; font-weight: 800;">ุฎุทุฉ ุชุนูู ููุชุงุจุนุฉ ุงูููุงุฑุงุช ุงูุนูููุฉ</h1>
     <h2 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 700;">ููุฑุฑ ุชูููุฉ ุฑูููุฉ 2</h2>
     <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 600;">ุฌุฏูู ุชูููู ุงูุทุงูุจุงุช</h3>
     <p style="margin: 0; font-size: 16px; opacity: 0.95;">ุจุฑูุฌุฉ ูุชูุฏูุฉ (HTML &amp; JavaScript) - ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู</p>
    </div>
   </div><!-- Skills Guide Card -->
   <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 20px; border-radius: 16px; margin-bottom: 25px; border-right: 6px solid #9c27b0; box-shadow: 0 6px 20px rgba(0,0,0,0.1);">
    <h3 style="color: #6a1b9a; font-size: 22px; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;"><span style="font-size: 32px;">๐ฏ</span> ุฏููู ุงูููุงุฑุงุช (9 ููุงุฑุงุช)</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
     <div style="background: white; padding: 12px; border-radius: 10px; border-right: 3px solid #9c27b0;"><strong style="color: #6a1b9a;">ุงูููุงุฑุฉ 1:</strong><br><span style="color: #424242; font-size: 14px;">ูุณูู ุชูุณูู ุงูุตูุฑุฉ</span>
     </div>
     <div style="background: white; padding: 12px; border-radius: 10px; border-right: 3px solid #9c27b0;"><strong style="color: #6a1b9a;">ุงูููุงุฑุฉ 2:</strong><br><span style="color: #424242; font-size: 14px;">ูุณูู ุชูุณูู ุงููุต</span>
     </div>
     <div style="background: white; padding: 12px; border-radius: 10px; border-right: 3px solid #9c27b0;"><strong style="color: #6a1b9a;">ุงูููุงุฑุฉ 3:</strong><br><span style="color: #424242; font-size: 14px;">ุชูุณูู ุงูุฃููุงุท ุงููุถููุฉ (Inline CSS)</span>
     </div>
     <div style="background: white; padding: 12px; border-radius: 10px; border-right: 3px solid #9c27b0;"><strong style="color: #6a1b9a;">ุงูููุงุฑุฉ 4:</strong><br><span style="color: #424242; font-size: 14px;">ุชูุณูู ุงูุฃููุงุท ุงูุฏุงุฎููุฉ (Internal CSS)</span>
     </div>
     <div style="background: white; padding: 12px; border-radius: 10px; border-right: 3px solid #9c27b0;"><strong style="color: #6a1b9a;">ุงูููุงุฑุฉ 5:</strong><br><span style="color: #424242; font-size: 14px;">ุชูุณูู ุงูุฃููุงุท ุงูุฎุงุฑุฌูุฉ (External CSS)</span>
     </div>
     <div style="background: white; padding: 12px; border-radius: 10px; border-right: 3px solid #9c27b0;"><strong style="color: #6a1b9a;">ุงูููุงุฑุฉ 6:</strong><br><span style="color: #424242; font-size: 14px;">ุชูุณูู ุงูุตูุญุฉ ุจุงุณุชุฎุฏุงู div</span>
     </div>
     <div style="background: white; padding: 12px; border-radius: 10px; border-right: 3px solid #9c27b0;"><strong style="color: #6a1b9a;">ุงูููุงุฑุฉ 7:</strong><br><span style="color: #424242; font-size: 14px;">ูุชุงุจุฉ ููุทุน JavaScript</span>
     </div>
     <div style="background: white; padding: 12px; border-radius: 10px; border-right: 3px solid #9c27b0;"><strong style="color: #6a1b9a;">ุงูููุงุฑุฉ 8:</strong><br><span style="color: #424242; font-size: 14px;">ุฏูุงู ุงูุชูุงุนู JavaScript</span>
     </div>
     <div style="background: white; padding: 12px; border-radius: 10px; border-right: 3px solid #9c27b0;"><strong style="color: #6a1b9a;">ุงูููุงุฑุฉ 9:</strong><br><span style="color: #424242; font-size: 14px;">ุฅูุดุงุก ุฌุฏูู HTML ูุงูู</span>
     </div>
    </div>
   </div><!-- Evaluation Criteria Card -->
   <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 16px; margin-bottom: 25px; border-right: 6px solid #4caf50; box-shadow: 0 6px 20px rgba(0,0,0,0.1);">
    <h3 style="color: #2e7d32; font-size: 22px; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;"><span style="font-size: 32px;">๐</span> ูุนุงููุฑ ูุณุชููุงุช ุงูุชูููู</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px;">
     <div style="background: white; padding: 15px; border-radius: 12px; border-right: 4px solid #9c27b0;">
      <div style="font-size: 24px; margin-bottom: 8px;">
       ๐
      </div><strong style="color: #6a1b9a; font-size: 18px;">ุงุจุชูุงุฑ</strong>
      <ul style="margin: 8px 0 0 0; padding-right: 20px; color: #424242; font-size: 13px; line-height: 1.7;">
       <li>ุชูุณุน ูู ุชูููุฐ ุงูููุงุฑุฉ</li>
       <li>ุฅุถุงูุฉ ุงุจุชูุงุฑุงุช ุฌุฏูุฏุฉ</li>
       <li>ุฏูุฌ ููุงุฑุงุช ูุชุนุฏุฏุฉ</li>
       <li>ุชูุฏูู ุญููู ุฅุจุฏุงุนูุฉ</li>
      </ul>
     </div>
     <div style="background: white; padding: 15px; border-radius: 12px; border-right: 4px solid #2196f3;">
      <div style="font-size: 24px; margin-bottom: 8px;">
       โ
      </div><strong style="color: #1565c0; font-size: 18px;">ุฅุชูุงู</strong>
      <ul style="margin: 8px 0 0 0; padding-right: 20px; color: #424242; font-size: 13px; line-height: 1.7;">
       <li>ุชูููุฐ ุตุญูุญ ููุชูู</li>
       <li>ุงุณุชููุงููุฉ ูุงููุฉ</li>
       <li>ููู ูุงุถุญ ููููุงููู</li>
       <li>ูุง ุฃุฎุทุงุก</li>
      </ul>
     </div>
     <div style="background: white; padding: 15px; border-radius: 12px; border-right: 4px solid #ff9800;">
      <div style="font-size: 24px; margin-bottom: 8px;">
       ๐
      </div><strong style="color: #ef6c00; font-size: 18px;">ุชุทุจูู</strong>
      <ul style="margin: 8px 0 0 0; padding-right: 20px; color: #424242; font-size: 13px; line-height: 1.7;">
       <li>ุชูููุฐ ุตุญูุญ ุฌุฒุฆูุงู</li>
       <li>ูุญุชุงุฌ ุจุนุถ ุงูุชุญุณูู</li>
       <li>ุฃุฎุทุงุก ุจุณูุทุฉ</li>
       <li>ุจุญุงุฌุฉ ููุฒูุฏ ูู ุงูููุงุฑุณุฉ</li>
      </ul>
     </div>
     <div style="background: white; padding: 15px; border-radius: 12px; border-right: 4px solid #f44336;">
      <div style="font-size: 24px; margin-bottom: 8px;">
       โ๏ธ
      </div><strong style="color: #c62828; font-size: 18px;">ูุญุชุงุฌ ุฏุนู</strong>
      <ul style="margin: 8px 0 0 0; padding-right: 20px; color: #424242; font-size: 13px; line-height: 1.7;">
       <li>ุฃุฎุทุงุก ูุซูุฑุฉ</li>
       <li>ุนุฏู ุฅููุงู ุงููููุฉ</li>
       <li>ุตุนูุจุฉ ูู ุงูููู</li>
       <li>ูุญุชุงุฌ ูุชุงุจุนุฉ ูุฑุฏูุฉ</li>
      </ul>
     </div>
    </div>
   </div>
   <div class="controls"><button class="btn btn-primary" id="addStudentBtn">โ ุฅุถุงูุฉ ุทุงูุจุฉ ุฌุฏูุฏุฉ</button> <button class="btn btn-primary" id="importExcelBtn">๐ฅ ุงุณุชูุฑุงุฏ ูู ุฅูุณู</button> <button class="btn btn-success" id="exportExcelBtn">๐ค ุชุตุฏูุฑ ุฅูู ุฅูุณู</button> <button class="btn btn-danger" id="clearAllBtn" style="background: linear-gradient(135deg, #ef5350 0%, #e53935 100%); padding: 12px 24px; font-size: 16px;">๐๏ธ ูุณุญ ุฌููุน ุงูุจูุงูุงุช</button> <input type="file" id="excelFileInput" accept=".xlsx, .xls" style="display: none;"> <button class="btn btn-success" id="addPredefinedBtn" style="display: none;">๐ ุฅุถุงูุฉ ุงูุทุงูุจุงุช ุงูุซุงุจุชุงุช (12 ุทุงูุจุฉ)</button>
    <div id="loadingIndicator" class="loading" style="display: none;">
     ุฌุงุฑู ุงูุญูุธ<span class="spinner"></span>
    </div>
   </div>
   <div id="tableContainer"></div>
  </div><!-- Modal for Adding Student -->
  <div class="modal" id="studentModal">
   <div class="modal-content">
    <h2 class="modal-title">ุฅุถุงูุฉ ุทุงูุจุฉ ุฌุฏูุฏุฉ</h2>
    <form id="studentForm">
     <div class="form-group"><label class="form-label" for="studentNameInput">ุงุณู ุงูุทุงูุจุฉ *</label> <input type="text" class="form-input" id="studentNameInput" required placeholder="ุฃุฏุฎู ุงุณู ุงูุทุงูุจุฉ ุงููุงูู">
     </div>
     <div class="form-actions"><button type="button" class="btn btn-primary" id="cancelBtn">ุฅูุบุงุก</button> <button type="submit" class="btn btn-success" id="saveStudentBtn">ุญูุธ</button>
     </div>
    </form>
   </div>
  </div>
  <script>
    const defaultConfig = {
      page_title: "ุฎุทุฉ ุชุนูู ููุชุงุจุนุฉ ุงูููุงุฑุงุช ุงูุนูููุฉ - ููุฑุฑ ุชูููุฉ ุฑูููุฉ 2 - ุฌุฏูู ุชูููู ุงูุทุงูุจุงุช",
      semester_info: "ุจุฑูุฌุฉ ูุชูุฏูุฉ (HTML & JavaScript) - ุงููุตู ุงูุฏุฑุงุณู ุงูุฃูู",
      background_color: "#6a11cb",
      card_color: "#ffffff",
      primary_color: "#1565c0",
      accent_color: "#42a5f5",
      text_color: "#424242"
    };

    let studentsData = [];
    let isLoading = false;

    const skills = [
      { id: 1, name: "ูุณูู ุงูุตูุฑุฉ", fullName: "ูุณูู ุชูุณูู ุงูุตูุฑุฉ" },
      { id: 2, name: "ูุณูู ุงููุต", fullName: "ูุณูู ุชูุณูู ุงููุต" },
      { id: 3, name: "ุฃููุงุท ูุถููุฉ", fullName: "ุชูุณูู ุงูุฃููุงุท ุงููุถููุฉ (Inline CSS)" },
      { id: 4, name: "ุฃููุงุท ุฏุงุฎููุฉ", fullName: "ุชูุณูู ุงูุฃููุงุท ุงูุฏุงุฎููุฉ (Internal CSS)" },
      { id: 5, name: "ุฃููุงุท ุฎุงุฑุฌูุฉ", fullName: "ุชูุณูู ุงูุฃููุงุท ุงูุฎุงุฑุฌูุฉ (External CSS)" },
      { id: 6, name: "ุชูุณูู div", fullName: "ุชูุณูู ุงูุตูุญุฉ ุจุงุณุชุฎุฏุงู div" },
      { id: 7, name: "JavaScript", fullName: "ูุชุงุจุฉ ููุทุน JavaScript" },
      { id: 8, name: "ุฏูุงู JS", fullName: "ุฏูุงู ุงูุชูุงุนู JavaScript" },
      { id: 9, name: "ุฌุฏูู HTML", fullName: "ุฅูุดุงุก ุฌุฏูู HTML ูุงูู" }
    ];

    const predefinedStudents = [
      "ุงููููู ุญุณูู",
      "ุจูู ุจุฏุฑ ุงูุนูุฑู",
      "ุฌูุงูุง ูุญูุฏ ุงูุญุฑุจู",
      "ุฏุนุงุก ููุฏ ุงูุญุฑุจู",
      "ุณุฌู ุฃุญูุฏ ุงูุญุงูุทู",
      "ุณููู ูุงูู ุงููุทูุฑู",
      "ุณูุง ุนูุงุก ุจุฑู",
      "ุนุฐุงุฑู ูุงูุฒ ุงูุญุฑุจู",
      "ุนุฑูุจ ููุฑ ุงูุนูุฑู",
      "ููุงู ุณุนุฏ ุงููุทูุฑู",
      "ููุนุงุฏ ูุฎููู ุงููู ุงูุญุฑุจู",
      "ูุฏู ูุงูู ุงูุญุฑุจู"
    ];

    let isRendering = false;

    const dataHandler = {
      onDataChanged(data) {
        if (isRendering) return;
        studentsData = data || [];
        renderTable();
        updatePredefinedButton();
      }
    };

    async function initializeApp() {
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        console.error("Failed to initialize data SDK");
        return;
      }
    }

    function updatePredefinedButton() {
      const btn = document.getElementById('addPredefinedBtn');
      if (!btn) return;

      const hasPredefined = studentsData.some(s => s.is_predefined === true);
      
      if (!hasPredefined && studentsData.length === 0) {
        btn.style.display = 'inline-block';
        btn.textContent = '๐ ุฅุถุงูุฉ ุงูุทุงูุจุงุช ุงูุซุงุจุชุงุช (12 ุทุงูุจุฉ)';
      } else if (!hasPredefined && studentsData.length > 0) {
        btn.style.display = 'inline-block';
        btn.textContent = '๐ ุฅุถุงูุฉ ุงููุงุฆูุฉ ุงูุซุงุจุชุฉ ุฃูุถุงู';
      } else {
        btn.style.display = 'none';
      }
    }

    async function addPredefinedStudents() {
      if (studentsData.length + predefinedStudents.length > 999) {
        showMessage("ูุง ูููู ุฅุถุงูุฉ ุฌููุน ุงูุทุงูุจุงุช - ุณูุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู 999");
        return;
      }

      setLoading(true);
      
      for (const studentName of predefinedStudents) {
        const newStudent = {
          student_name: studentName,
          is_predefined: true,
          created_at: new Date().toISOString()
        };

        skills.forEach(skill => {
          newStudent[`skill_${skill.id}_attendance`] = "";
          newStudent[`skill_${skill.id}_level`] = "";
        });

        const result = await window.dataSdk.create(newStudent);
        if (!result.isOk) {
          showMessage("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ: " + studentName);
          break;
        }
      }

      setLoading(false);
      showSuccessMessage("โ ุชู ุญูุธ ุฌููุน ุงูุทุงูุจุงุช ุงูุซุงุจุชุงุช (12 ุทุงูุจุฉ)");
    }

    function generateSmartLearningPlans(student) {
      let plans = [];
      let performanceScores = [];
      let attendanceScores = [];
      let completionScores = [];
      
      skills.forEach(skill => {
        const level = student[`skill_${skill.id}_level`];
        const attendance = student[`skill_${skill.id}_attendance`];
        
        if (level && level !== '' && level !== 'ูู ุชููุฐ') {
          if (level === 'ุงุจุชูุงุฑ') performanceScores.push(4);
          else if (level === 'ุฅุชูุงู') performanceScores.push(3);
          else if (level === 'ุชุทุจูู') performanceScores.push(2);
          else if (level === 'ูุญุชุงุฌ ุฏุนู') performanceScores.push(1);
        }
        
        if (attendance === 'ุญุงุถุฑุฉ') attendanceScores.push(1);
        if (level && level !== '' && level !== 'ูู ุชููุฐ') completionScores.push(1);
      });
      
      const avgPerformance = performanceScores.length > 0 ? 
        performanceScores.reduce((a, b) => a + b, 0) / performanceScores.length : 0;
      const attendanceRate = attendanceScores.length / skills.length;
      const completionRate = completionScores.length / skills.length;
      
      let learningStyle = '';
      let timeAllocation = '';
      let supportLevel = '';
      
      if (avgPerformance >= 3.5) {
        learningStyle = '๐ ูุชุนููุฉ ูุชูุฏูุฉ - ุชูุถู ุงูุชุญุฏูุงุช ูุงููุดุงุฑูุน ุงููุนูุฏุฉ';
        timeAllocation = 'โฑ๏ธ 30-45 ุฏูููุฉ ููููุงู ูููุดุงุฑูุน ุงูุฅุจุฏุงุนูุฉ';
        supportLevel = '๐ค ุชุนูู ุฐุงุชู + ููุงุฏุฉ ูุฌููุนุงุช';
      } else if (avgPerformance >= 2.5) {
        learningStyle = 'โ ูุชุนููุฉ ูุณุชูุฑุฉ - ุชุญุชุงุฌ ููุชุดุฌูุน ูุงูุชููุน';
        timeAllocation = 'โฑ๏ธ 20-30 ุฏูููุฉ ููููุงู ููููุงุฑุณุฉ ูุงูุชุทููุฑ';
        supportLevel = '๐ฅ ุชุนูู ุชุนุงููู + ุชูุฌูู ุฏูุฑู';
      } else if (avgPerformance >= 1.5) {
        learningStyle = '๐ ูุชุนููุฉ ุชุญุชุงุฌ ููุชูุฑุงุฑ ูุงูุชุจุณูุท';
        timeAllocation = 'โฑ๏ธ 15-25 ุฏูููุฉ ููููุงู ูุชุนุฒูุฒ ุงูุฃุณุงุณูุงุช';
        supportLevel = '๐ฅ ุฏุนู ูุฑุฏู + ุดุฑุญ ูุจุณุท';
      } else if (avgPerformance > 0) {
        learningStyle = '๐ ูุชุนููุฉ ุชุญุชุงุฌ ูุชุฏุฎู ููุฑู ูุฏุนู ููุซู';
        timeAllocation = 'โฑ๏ธ 10-15 ุฏูููุฉ ููููุงู ูุจูุงุก ุงูุซูุฉ';
        supportLevel = '๐ฅ ูุชุงุจุนุฉ ูุฑุฏูุฉ ููููุฉ + ุฃูุซูุฉ ุจุณูุทุฉ ุฌุฏุงู';
      }
      
      if (performanceScores.length === 0) {
        return '<div style="text-align: center; color: #9e9e9e; padding: 20px; font-size: 11px;">๐ง <strong>ุจุงูุชุธุงุฑ ุงูุชูููู</strong><br><br>ุณูุชู ุฅูุดุงุก ุฎุทุฉ ุชุนูู ูุฑูุฉ ูุฐููุฉ<br>ุจุนุฏ ุชูููู ุงูููุงุฑุงุช ุงูุฃููู</div>';
      }
      
      let planHTML = '<div style="background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-right: 5px solid #5c6bc0;">';
      planHTML += '<div style="font-weight: bold; color: #3949ab; margin-bottom: 10px; font-size: 13px;">๐ง ุงูุชุญููู ุงูุดุฎุตู ููุทุงูุจุฉ</div>';
      planHTML += '<div style="font-size: 11px; color: #283593; line-height: 1.8;">';
      planHTML += `<strong>๐ ูุนุฏู ุงูุฃุฏุงุก:</strong> ${(avgPerformance * 25).toFixed(0)}%<br>`;
      planHTML += `<strong>๐ ูุนุฏู ุงูุญุถูุฑ:</strong> ${(attendanceRate * 100).toFixed(0)}%<br>`;
      planHTML += `<strong>โ๏ธ ูุนุฏู ุงูุฅูุฌุงุฒ:</strong> ${(completionRate * 100).toFixed(0)}%<br><br>`;
      planHTML += `${learningStyle}<br>`;
      planHTML += `${timeAllocation}<br>`;
      planHTML += `${supportLevel}`;
      planHTML += '</div></div>';
      
      plans.push(planHTML);
      
      skills.forEach(skill => {
        const level = student[`skill_${skill.id}_level`];
        const attendance = student[`skill_${skill.id}_attendance`];
        
        if (!level || level === '') return;
        
        if (level === 'ูู ุชููุฐ') {
          let skillPlan = '<div style="margin-bottom: 12px; padding: 12px; border-radius: 8px; border-right: 4px solid #9e9e9e; background: #f5f5f5;">';
          skillPlan += `<div style="font-weight: bold; color: #616161; margin-bottom: 6px; font-size: 11px;">โธ๏ธ ู${skill.id}: ${skill.name}</div>`;
          skillPlan += '<div style="font-size: 10px; color: #757575; line-height: 1.6;">';
          skillPlan += '<strong>ูู ูุชู ุงูุชูููุฐ ุจุนุฏ</strong><br>';
          skillPlan += '๐ ุงูุฎุทุฉ ุงูููุชุฑุญุฉ:<br>';
          skillPlan += '1๏ธโฃ ุงูุจุฏุก ุจูุซุงู ุชูุถูุญู ุจุณูุท<br>';
          skillPlan += '2๏ธโฃ ูุชุงุจุนุฉ ุฎุทูุฉ ุจุฎุทูุฉ ูุน ุงููุนููุฉ<br>';
          skillPlan += '3๏ธโฃ ุชุฎุตูุต ููุช ููุชุทุจูู ุงูุนููู<br>';
          skillPlan += '4๏ธโฃ ุชูููู ุจุนุฏ ุงูุฅููุงู';
          skillPlan += '</div></div>';
          plans.push(skillPlan);
          return;
        }
        
        let skillPlan = '<div style="margin-bottom: 12px; padding: 12px; border-radius: 8px; border-right: 4px solid ';
        
        if (level === 'ุงุจุชูุงุฑ') {
          skillPlan += '#9c27b0; background: #f3e5f5;">';
          skillPlan += `<div style="font-weight: bold; color: #6a1b9a; margin-bottom: 6px; font-size: 11px;">๐ ู${skill.id}: ${skill.name}</div>`;
          skillPlan += '<div style="font-size: 10px; color: #4a148c; line-height: 1.6;">';
          skillPlan += '<strong>ูุณุงุฑ ุงูุฅุจุฏุงุน ุงููุชูุฏู:</strong><br>';
          skillPlan += '1๏ธโฃ ุชุตููู ูุดุฑูุน ุดุฎุตู ูุทุจู ูุฐู ุงูููุงุฑุฉ<br>';
          skillPlan += '2๏ธโฃ ุฏูุฌูุง ูุน 2-3 ููุงุฑุงุช ุฃุฎุฑู<br>';
          skillPlan += '3๏ธโฃ ุชูุฏูู ุนุฑุถ ุฃู ุดุฑุญ ููุตู<br>';
          skillPlan += '4๏ธโฃ ุงุณุชูุดุงู ููุฒุงุช ูุชูุฏูุฉ ุฐุงุชูุงู';
          skillPlan += '</div></div>';
        }
        else if (level === 'ุฅุชูุงู') {
          if (attendance === 'ุญุงุถุฑุฉ') {
            skillPlan += '#00897b; background: #e0f2f1;">';
            skillPlan += `<div style="font-weight: bold; color: #00695c; margin-bottom: 6px; font-size: 11px;">๐ฏ ู${skill.id}: ${skill.name}</div>`;
            skillPlan += '<div style="font-size: 10px; color: #004d40; line-height: 1.6;">';
            skillPlan += '<strong>ูุณุงุฑ ุงูุชุทููุฑ ูุญู ุงูุฅุจุฏุงุน:</strong><br>';
            skillPlan += 'โข ุญุงููู ุฅุถุงูุฉ ููุณุฉ ุฅุจุฏุงุนูุฉ ูู ุงููุดุฑูุน ุงููุงุฏู<br>';
            skillPlan += 'โข ุทุจูู ุงูููุงุฑุฉ ูู ุณูุงู ูุฎุชูู<br>';
            skillPlan += 'โข ุณุงุนุฏู ุฒูููุฉ ุชุญุชุงุฌ ุงูุฏุนู<br>';
            skillPlan += 'โข ุชุญุฏู: ุฃุถููู ููุฒุฉ ุฌุฏูุฏุฉ ูู ูุชุนูููุง';
            skillPlan += '</div></div>';
          } else {
            skillPlan += '#0288d1; background: #e1f5fe;">';
            skillPlan += `<div style="font-weight: bold; color: #01579b; margin-bottom: 6px; font-size: 11px;">โก ู${skill.id}: ${skill.name}</div>`;
            skillPlan += '<div style="font-size: 10px; color: #01579b; line-height: 1.6;">';
            skillPlan += '<strong>ุฎุทุฉ ุงูุชุซุจูุช:</strong><br>';
            if (attendance === 'ุบุงุฆุจุฉ') {
              skillPlan += 'โ๏ธ ุชุนููุถ ุงูุบูุงุจ: ูุฑุงุฌุนุฉ ุงูุดุฑุญ ุงููุณุฌู<br>';
            }
            skillPlan += 'โข ุชุทุจูู 2-3 ุฃูุซูุฉ ูุดุงุจูุฉ<br>';
            skillPlan += 'โข ุงูุงุณุชุนุฏุงุฏ ููุงูุชูุงู ูููุณุชูู ุงูุชุงูู';
            skillPlan += '</div></div>';
          }
        }
        else if (level === 'ุชุทุจูู') {
          skillPlan += '#f57c00; background: #fff3e0;">';
          skillPlan += `<div style="font-weight: bold; color: #e65100; margin-bottom: 6px; font-size: 11px;">๐ง ู${skill.id}: ${skill.name}</div>`;
          skillPlan += '<div style="font-size: 10px; color: #bf360c; line-height: 1.6;">';
          skillPlan += '<strong>ุฎุทุฉ ุงูุชุญุณูู ุงููุฑูุฉ:</strong><br>';
          
          if (avgPerformance >= 2.5) {
            skillPlan += 'โข ูุจุฏู ุฃู ุงูุจุงูู ุฌูุฏุ ุฑูุฒู ุนูู ูุฐู ุงูููุงุฑุฉ<br>';
            skillPlan += 'โข 3 ุชูุงุฑูู ุฅุถุงููุฉ ููุท<br>';
            skillPlan += 'โข ูุฑุงุฌุนุฉ ูุน ุฒูููุฉ ูุชูููุฉ<br>';
            skillPlan += 'โข ุฅุนุงุฏุฉ ุงูุชูููู ุจุนุฏ 3 ุฃูุงู';
          } else {
            skillPlan += 'โข ูุฏ ุชุญุชุงุฌูู ุฏุนูุงู ุดุงููุงู<br>';
            skillPlan += 'โข 5-7 ุชูุงุฑูู ุชุฏุฑูุฌูุฉ<br>';
            skillPlan += 'โข ุฌูุณุฉ ูุฑุงุฌุนุฉ ูุน ุงููุนููุฉ<br>';
            skillPlan += 'โข ูุชุงุจุนุฉ ุฃุณุจูุนูุฉ';
          }
          
          if (attendance === 'ุบุงุฆุจุฉ') {
            skillPlan += '<br>โ๏ธ ุงูุบูุงุจ ุณุจุจ ุฑุฆูุณู - ูุฌุจ ุงูุชุนููุถ';
          }
          skillPlan += '</div></div>';
        }
        else if (level === 'ูุญุชุงุฌ ุฏุนู') {
          skillPlan += '#d32f2f; background: #ffebee;">';
          skillPlan += `<div style="font-weight: bold; color: #b71c1c; margin-bottom: 6px; font-size: 11px;">๐ ู${skill.id}: ${skill.name}</div>`;
          skillPlan += '<div style="font-size: 10px; color: #b71c1c; line-height: 1.6;">';
          skillPlan += '<strong>ุฎุทุฉ ุงูุชุฏุฎู ุงูููุฑู ุงููุฎุตุตุฉ:</strong><br>';
          
          if (attendance === 'ุบุงุฆุจุฉ') {
            skillPlan += '๐ด <u>ุงูุณุจุจ ุงูุฑุฆูุณู: ุงูุบูุงุจ</u><br>';
            skillPlan += '1๏ธโฃ ุญุถูุฑ ุฌูุณุฉ ุชุนููุถูุฉ (20 ุฏูููุฉ)<br>';
            skillPlan += '2๏ธโฃ ูุดุงูุฏุฉ ููุฏูู ุชุนูููู ูุตูุฑ<br>';
          } else {
            skillPlan += '๐ด <u>ุงูุณุจุจ: ุตุนูุจุฉ ูู ุงูููู</u><br>';
            skillPlan += '1๏ธโฃ ุฅุนุงุฏุฉ ุงูุดุฑุญ ุจุทุฑููุฉ ูุฎุชููุฉ<br>';
            skillPlan += '2๏ธโฃ ุงุณุชุฎุฏุงู ุฃูุซูุฉ ุจุตุฑูุฉ<br>';
          }
          
          skillPlan += '3๏ธโฃ ุชูุฑูู ูุงุญุฏ ุจุณูุท ููููุงู (10 ุฏูุงุฆู)<br>';
          skillPlan += '4๏ธโฃ ูุชุงุจุนุฉ ููููุฉ ุญุชู ุงูุชุญุณู<br>';
          skillPlan += '5๏ธโฃ ุชูุงุตู ูุน ููู ุงูุฃูุฑ<br>';
          skillPlan += '๐ ุฅุนุงุฏุฉ ุงูุชูููู ุจุนุฏ 5 ุฃูุงู';
          skillPlan += '</div></div>';
        }
        
        plans.push(skillPlan);
      });
      
      let closingMessage = '<div style="background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%); padding: 12px; border-radius: 8px; border-right: 4px solid #fbc02d; margin-top: 10px;">';
      closingMessage += '<div style="font-size: 11px; color: #f57f17; line-height: 1.6;">';
      
      if (avgPerformance >= 3.5) {
        closingMessage += '๐ <strong>ุฑุณุงูุฉ ุชุญููุฒูุฉ:</strong><br>';
        closingMessage += 'ุฃุฏุงุคู ุฑุงุฆุน! ุงุณุชูุฑู ูู ุงูุชููุฒ ูุณุงุนุฏู ุฒูููุงุชู.';
      } else if (avgPerformance >= 2.5) {
        closingMessage += '๐ช <strong>ุฑุณุงูุฉ ุชุดุฌูุนูุฉ:</strong><br>';
        closingMessage += 'ูุณุชูุงู ุฌูุฏ! ุงููููู ูู ุงูุฌูุฏ ุณูุฌุนูู ูุชููุฒุฉ.';
      } else if (avgPerformance >= 1.5) {
        closingMessage += '๐ฑ <strong>ุฑุณุงูุฉ ุฃูู:</strong><br>';
        closingMessage += 'ูุง ุชุณุชุณููู! ูู ุฎุทูุฉ ููุฃูุงู ูู ุฅูุฌุงุฒ.';
      } else {
        closingMessage += '๐ <strong>ุฑุณุงูุฉ ุฏุนู:</strong><br>';
        closingMessage += 'ูุญู ูุนู! ุณููุฌุญ ูุนุงู ุฎุทูุฉ ุจุฎุทูุฉ.';
      }
      
      closingMessage += '</div></div>';
      plans.push(closingMessage);
      
      return plans.join('');
    }

    function generateLearningPlans(student) {
      let plans = [];
      
      skills.forEach(skill => {
        const level = student[`skill_${skill.id}_level`];
        
        if (!level || level === '') return;
        
        let planHTML = '<div style="margin-bottom: 15px; padding: 12px; border-radius: 8px; border-right: 4px solid ';
        
        if (level === 'ุงุจุชูุงุฑ') {
          planHTML += '#4caf50; background: #e8f5e9;">';
          planHTML += `<div style="font-weight: bold; color: #2e7d32; margin-bottom: 6px; font-size: 12px;">๐ ู${skill.id}: ${skill.fullName}</div>`;
          planHTML += '<div style="font-size: 10px; color: #1b5e20; line-height: 1.5;">';
          planHTML += '<strong>ุงููุณุชูู: ุงุจุชูุงุฑ ููุชุงุฒ!</strong><br>';
          planHTML += 'โ ุชูุณุน ูู ุชูููุฐ ุงูููุงุฑุฉ<br>';
          planHTML += 'โ ุชูููู ุจูุดุฑูุน ูุชูุฏู ูุฏูุฌ ูุฐู ุงูููุงุฑุฉ ูุน ููุงุฑุงุช ุฃุฎุฑู<br>';
          planHTML += 'โ ุชุดุฌูุนูุง ุนูู ูุณุงุนุฏุฉ ุฒูููุงุชูุง<br>';
          planHTML += 'โ ุนุฑุถ ุนูููุง ููููุฐุฌ ูููู ููุตู<br>';
          planHTML += 'โ ุชูููุฑ ุชุญุฏูุงุช ุฅุถุงููุฉ ูุชูููุฉ ุงูุฅุจุฏุงุน';
          planHTML += '</div></div>';
        } 
        else if (level === 'ุฅุชูุงู') {
          planHTML += '#2196f3; background: #e3f2fd;">';
          planHTML += `<div style="font-weight: bold; color: #1565c0; margin-bottom: 6px; font-size: 12px;">โ ู${skill.id}: ${skill.fullName}</div>`;
          planHTML += '<div style="font-size: 10px; color: #0d47a1; line-height: 1.5;">';
          planHTML += '<strong>ุงููุณุชูู: ุฅุชูุงู ุฌูุฏ</strong><br>';
          planHTML += 'โข ุชุดุฌูุน ุนูู ุฅุถุงูุฉ ููุณุงุช ุฅุจุฏุงุนูุฉ<br>';
          planHTML += 'โข ุชูููู ุจูุดุฑูุน ุชุทุจููู ุฃูุซุฑ ุชุนููุฏุงู<br>';
          planHTML += 'โข ูุดุงุฑูุฉ ุฃููุงุฑ ูุชูุฏูุฉ ูู ูุฐู ุงูููุงุฑุฉ<br>';
          planHTML += 'โข ุงูุงูุชูุงู ูููุณุชูู ุงูุชุงูู ูู ุงูุตุนูุจุฉ';
          planHTML += '</div></div>';
        }
        else if (level === 'ุชุทุจูู') {
          planHTML += '#ff9800; background: #fff3e0;">';
          planHTML += `<div style="font-weight: bold; color: #ef6c00; margin-bottom: 6px; font-size: 12px;">๐ ู${skill.id}: ${skill.fullName}</div>`;
          planHTML += '<div style="font-size: 10px; color: #e65100; line-height: 1.5;">';
          planHTML += '<strong>ุงููุณุชูู: ุชุทุจูู - ูุญุชุงุฌ ุชุญุณูู</strong><br>';
          planHTML += '๐ <u>ุงูุฎุทุฉ ุงูุนูุงุฌูุฉ:</u><br>';
          planHTML += 'โข ุชูููู ุจู 3-5 ุชูุงุฑูู ุฅุถุงููุฉ ูุดุงุจูุฉ<br>';
          planHTML += 'โข ูุฑุงุฌุนุฉ ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ ูุนูุง<br>';
          planHTML += 'โข ุชูููุฑ ุฃูุซูุฉ ูุงุถุญุฉ ููููุงุฑูุฉ<br>';
          planHTML += 'โข ูุชุงุจุนุฉ ุฃุณุจูุนูุฉ ุญุชู ุงููุตูู ููุฅุชูุงู<br>';
          planHTML += 'โฐ ุชุฎุตูุต 15 ุฏูููุฉ ููููุงุฑุณุฉ ููููุงู';
          planHTML += '</div></div>';
        }
        else if (level === 'ูุญุชุงุฌ ุฏุนู') {
          planHTML += '#f44336; background: #ffebee;">';
          planHTML += `<div style="font-weight: bold; color: #c62828; margin-bottom: 6px; font-size: 12px;">๐ ู${skill.id}: ${skill.fullName}</div>`;
          planHTML += '<div style="font-size: 10px; color: #b71c1c; line-height: 1.5;">';
          planHTML += '<strong>ุงููุณุชูู: ูุญุชุงุฌ ุฏุนู ููุซู</strong><br>';
          planHTML += '๐จ <u>ุฎุทุฉ ุชุฏุฎู ููุฑู:</u><br>';
          planHTML += '1๏ธโฃ ุฌูุณุฉ ูุฑุฏูุฉ (20-30 ุฏูููุฉ) ูุฅุนุงุฏุฉ ุงูุดุฑุญ<br>';
          planHTML += '2๏ธโฃ ุงุณุชุฎุฏุงู ููุฏูููุงุช ุชุนููููุฉ ูุจุณุทุฉ<br>';
          planHTML += '3๏ธโฃ ุชุทุจูู ุนููู ูุจุงุดุฑ ุฎุทูุฉ ุจุฎุทูุฉ<br>';
          planHTML += '4๏ธโฃ ุชูููู ุจูููุฉ ุจุณูุทุฉ ุฌุฏุงู ููุจุฏุงูุฉ<br>';
          planHTML += '5๏ธโฃ ูุชุงุจุนุฉ ููููุฉ ููุฏุฉ ุฃุณุจูุน<br>';
          planHTML += '6๏ธโฃ ุงูุชูุงุตู ูุน ููู ุงูุฃูุฑ ููุฏุนู ุงูููุฒูู<br>';
          planHTML += '๐ ุฅุนุงุฏุฉ ุงูุชูููู ุจุนุฏ ุฃุณุจูุน';
          planHTML += '</div></div>';
        }
        else if (level === 'ูู ุชููุฐ') {
          planHTML += '#9e9e9e; background: #f5f5f5;">';
          planHTML += `<div style="font-weight: bold; color: #616161; margin-bottom: 6px; font-size: 12px;">โธ๏ธ ู${skill.id}: ${skill.fullName}</div>`;
          planHTML += '<div style="font-size: 10px; color: #757575; line-height: 1.5;">';
          planHTML += '<strong>ุงููุณุชูู: ูู ุชููุฐ</strong><br>';
          planHTML += '๐ <u>ุงูุฎุทุฉ ุงูููุชุฑุญุฉ:</u><br>';
          planHTML += 'โข ุงูุจุฏุก ุจูุซุงู ุชูุถูุญู ุจุณูุท<br>';
          planHTML += 'โข ูุชุงุจุนุฉ ุฎุทูุฉ ุจุฎุทูุฉ ูุน ุงููุนููุฉ<br>';
          planHTML += 'โข ุชุฎุตูุต ููุช ูุงูู ููุชุทุจูู ุงูุนููู<br>';
          planHTML += 'โข ุฅุนุงุฏุฉ ุงูุชูููู ุจุนุฏ ุงูุฅููุงู';
          planHTML += '</div></div>';
        }
        
        plans.push(planHTML);
      });
      
      if (plans.length === 0) {
        return '<div style="text-align: center; color: #9e9e9e; padding: 20px; font-size: 11px;">ูู ูุชู ุชูููู ุฃู ููุงุฑุฉ ุจุนุฏ<br>ุณุชุธูุฑ ุงูุฎุทุท ุงูุชุนููููุฉ ุนูุฏ ุจุฏุก ุงูุชูููู</div>';
      }
      
      return plans.join('');
    }

    function generateMissingSkillsAlert(student) {
      let weakSkills = [];
      let criticalSkills = [];

      skills.forEach(skill => {
        const level = student[`skill_${skill.id}_level`];
        const skillName = skill.name;
        
        if (level === 'ูุญุชุงุฌ ุฏุนู') {
          criticalSkills.push({ id: skill.id, name: skillName });
        } else if (level === 'ุชุทุจูู') {
          weakSkills.push({ id: skill.id, name: skillName });
        }
      });

      if (criticalSkills.length === 0 && weakSkills.length === 0) {
        return '';
      }

      let alertHTML = '<div style="border: 2px solid #d32f2f; border-radius: 8px; padding: 12px; margin-bottom: 15px; background: #ffebee;">';
      
      if (criticalSkills.length > 0) {
        alertHTML += '<div style="display: flex; align-items: center; margin-bottom: 10px;">';
        alertHTML += '<span style="font-size: 20px; margin-left: 8px;">๐จ</span>';
        alertHTML += '<strong style="color: #c62828; font-size: 13px;">ุชูุจูู: ููุงุฑุงุช ุญุฑุฌุฉ ุชุญุชุงุฌ ุชุฏุฎู ููุฑู!</strong>';
        alertHTML += '</div>';
        alertHTML += '<ul style="margin: 8px 0; padding-right: 20px; color: #b71c1c; font-size: 11px;">';
        criticalSkills.forEach(skill => {
          alertHTML += `<li><strong>ู${skill.id}:</strong> ${skill.name} - <span style="color: #d32f2f;">ูุญุชุงุฌ ุฏุนู ููุซู</span></li>`;
        });
        alertHTML += '</ul>';
      }

      if (weakSkills.length > 0) {
        if (criticalSkills.length > 0) {
          alertHTML += '<hr style="border: none; border-top: 1px solid #ffcdd2; margin: 10px 0;">';
        }
        alertHTML += '<div style="display: flex; align-items: center; margin-bottom: 8px;">';
        alertHTML += '<span style="font-size: 18px; margin-left: 8px;">โ๏ธ</span>';
        alertHTML += '<strong style="color: #ef6c00; font-size: 12px;">ููุงุฑุงุช ุชุญุชุงุฌ ุชุญุณูู:</strong>';
        alertHTML += '</div>';
        alertHTML += '<ul style="margin: 5px 0; padding-right: 20px; color: #e65100; font-size: 11px;">';
        weakSkills.forEach(skill => {
          alertHTML += `<li><strong>ู${skill.id}:</strong> ${skill.name} - <span style="color: #ef6c00;">ุจุญุงุฌุฉ ููุฒูุฏ ูู ุงูููุงุฑุณุฉ</span></li>`;
        });
        alertHTML += '</ul>';
      }

      if (criticalSkills.length > 0) {
        alertHTML += '<div style="background: #fff; padding: 8px; border-radius: 6px; margin-top: 10px; border-right: 3px solid #f44336;">';
        alertHTML += '<strong style="color: #c62828; font-size: 11px;">๐ ุฅุฌุฑุงุกุงุช ููุชุฑุญุฉ:</strong>';
        alertHTML += '<ul style="margin: 5px 0; padding-right: 20px; font-size: 10px; color: #424242;">';
        alertHTML += '<li>ุฌูุณุฉ ูุฑุฏูุฉ ูุฅุนุงุฏุฉ ุงูุดุฑุญ</li>';
        alertHTML += '<li>ุฃูุซูุฉ ุชุทุจูููุฉ ูุจุณุทุฉ</li>';
        alertHTML += '<li>ูุชุงุจุนุฉ ููููุฉ ุญุชู ุงูุชุญุณู</li>';
        alertHTML += '<li>ุงูุชูุงุตู ูุน ููู ุงูุฃูุฑ</li>';
        alertHTML += '</ul>';
        alertHTML += '</div>';
      } else if (weakSkills.length > 0) {
        alertHTML += '<div style="background: #fff; padding: 8px; border-radius: 6px; margin-top: 10px; border-right: 3px solid #ff9800;">';
        alertHTML += '<strong style="color: #ef6c00; font-size: 11px;">๐ก ูุตูุญุฉ:</strong>';
        alertHTML += '<p style="margin: 5px 0; font-size: 10px; color: #424242;">ุชูููู ุจุชูุงุฑูู ุฅุถุงููุฉ ูู ูุฐู ุงูููุงุฑุงุช ูููุตูู ููุฅุชูุงู</p>';
        alertHTML += '</div>';
      }

      alertHTML += '</div>';
      return alertHTML;
    }

    function generateFeedback(student) {
      let feedback = [];
      let absentCount = 0;
      let notCompletedCount = 0;
      let needsSupportCount = 0;
      let masteryCount = 0;
      let innovationCount = 0;

      skills.forEach(skill => {
        const attendance = student[`skill_${skill.id}_attendance`];
        const level = student[`skill_${skill.id}_level`];

        if (attendance === 'ุบุงุฆุจุฉ') absentCount++;
        if (level === 'ูู ุชููุฐ') notCompletedCount++;
        if (level === 'ูุญุชุงุฌ ุฏุนู') needsSupportCount++;
        if (level === 'ุฅุชูุงู') masteryCount++;
        if (level === 'ุงุจุชูุงุฑ') innovationCount++;
      });

      if (absentCount >= 3) {
        feedback.push('โ๏ธ <strong>ุชูุจูู:</strong> ุงูุบูุงุจ ุงููุชูุฑุฑ ูุคุซุฑ ุนูู ุงูุชูุฏู. ูููุตุญ ุจุงูุชูุงุตู ูุน ููู ุงูุฃูุฑ ูุงูุชุนููุถ ูู ุฎูุงู ุฌูุณุฉ ูุฑุฏูุฉ.');
      }
      
      if (needsSupportCount >= 3) {
        feedback.push('๐ <strong>ุฅุฌุฑุงุก ููุฑู:</strong> ุชุญุชุงุฌ ุฏุนูุงู ููุซูุงู. ุงูุญููู:<br>โข ุฅุนุงุฏุฉ ุดุฑุญ ุงูููุงููู ุงูุฃุณุงุณูุฉ<br>โข ุชูุฏูู ุฃูุซูุฉ ูุจุณุทุฉ<br>โข ุชุฎุตูุต ููุช ุฅุถุงูู ููููุงุฑุณุฉ<br>โข ุงุณุชุฎุฏุงู ููุฏูููุงุช ุชุนููููุฉ ูุณุงุนุฏุฉ');
      } else if (needsSupportCount > 0) {
        feedback.push('๐ <strong>ุชูุตูุฉ:</strong> ุจุญุงุฌุฉ ูุชุนุฒูุฒ ูู ุจุนุถ ุงูููุงุฑุงุช. ููุตุญ ุจู:<br>โข ูุฑุงุฌุนุฉ ุงูุฃูุซูุฉ ุงููุดุฑูุญุฉ<br>โข ุงูุชุทุจูู ุงูุนููู ุงููุชูุฑุฑ<br>โข ุทูุจ ุงููุณุงุนุฏุฉ ุนูุฏ ุงูุญุงุฌุฉ');
      }

      if (notCompletedCount >= 3) {
        feedback.push('๐ <strong>ูุชุงุจุนุฉ:</strong> ุนุฏู ุฅููุงู ุงูููุงู ูุนูู ุงูุชูุฏู. ูููุชุฑุญ:<br>โข ูุถุน ุฌุฏูู ุฒููู ูุงุถุญ<br>โข ุชูุณูู ุงูููุงู ูุฃุฌุฒุงุก ุตุบูุฑุฉ<br>โข ุชุญููุฒ ุจูุธุงู ุงูููุงูุขุช');
      }

      if (innovationCount >= 3) {
        feedback.push('๐ <strong>ููุชุงุฒ:</strong> ุฃุฏุงุก ูุชููุฒ! ุงุณุชูุฑู ูู ุงูุฅุจุฏุงุน ูุณุงุนุฏู ุฒูููุงุชู.');
      } else if (masteryCount >= 5) {
        feedback.push('โ <strong>ุฌูุฏ ุฌุฏุงู:</strong> ูุณุชูู ูุชูู. ุญุงููู ุฅุถุงูุฉ ููุณุงุช ุฅุจุฏุงุนูุฉ ูู ุงููุดุงุฑูุน ุงููุงุฏูุฉ.');
      }

      if (feedback.length === 0) {
        feedback.push('๐ <strong>ุงูุจุฏุงูุฉ:</strong> ุงุณุชูุฑู ูู ุงูุญุถูุฑ ูุงูุชุทุจูู ุงูููุชุธู ูุชุญููู ูุชุงุฆุฌ ุฃูุถู.');
      }

      return feedback.join('<br><br>');
    }

    function generateAIPrediction(student) {
      let predictions = [];
      let attendanceRate = 0;
      let completionRate = 0;
      let performanceScores = [];
      let evaluatedCount = 0;

      skills.forEach(skill => {
        const attendance = student[`skill_${skill.id}_attendance`];
        const level = student[`skill_${skill.id}_level`];

        if (level && level !== '' && level !== 'ูู ุชููุฐ') {
          evaluatedCount++;
          
          if (attendance === 'ุญุงุถุฑุฉ') attendanceRate++;
          if (level !== 'ูู ุชููุฐ') completionRate++;
          
          if (level === 'ุงุจุชูุงุฑ') performanceScores.push(4);
          else if (level === 'ุฅุชูุงู') performanceScores.push(3);
          else if (level === 'ุชุทุจูู') performanceScores.push(2);
          else if (level === 'ูุญุชุงุฌ ุฏุนู') performanceScores.push(1);
        }
      });

      if (evaluatedCount === 0) {
        return '<div style="text-align: center; color: #9e9e9e; padding: 15px; font-size: 11px;">๐ค <strong>ุจุงูุชุธุงุฑ ุงูุชูููู</strong><br><br>ูู ูุชู ุชูููู ุฃู ููุงุฑุฉ ุจุนุฏ.<br>ุณูุชู ุงูุชูุจุค ุจุงูุฃุฏุงุก ุงููุณุชูุจูู<br>ุจุนุฏ ุชูููู ุงูููุงุฑุงุช.</div>';
      }

      attendanceRate = (attendanceRate / evaluatedCount) * 100;
      completionRate = (completionRate / evaluatedCount) * 100;
      const avgPerformance = performanceScores.length > 0 ? 
        performanceScores.reduce((a, b) => a + b, 0) / performanceScores.length : 0;

      predictions.push(`๐ค <strong>ุงูุชุญููู ุงูุฐูู (${evaluatedCount} ูู 9 ููุงุฑุงุช):</strong><br>`);

      if (attendanceRate < 60) {
        predictions.push('โข <span style="color: #d32f2f;">โ๏ธ ุงุญุชูุงููุฉ ุถุนู ุงูุฃุฏุงุก ุงููุณุชูุจูู: <strong>ุนุงููุฉ</strong></span><br>ุงูุณุจุจ: ูุนุฏู ุงูุญุถูุฑ ููุฎูุถ (' + Math.round(attendanceRate) + '%)');
      } else if (attendanceRate >= 90) {
        predictions.push('โข <span style="color: #388e3c;">โ ุงุญุชูุงููุฉ ุงููุฌุงุญ ุงููุชููุฒ: <strong>ูุฑุชูุนุฉ</strong></span><br>ุงูุณุจุจ: ุงูุญุถูุฑ ุงูููุชุธู (' + Math.round(attendanceRate) + '%)');
      }

      if (avgPerformance >= 3.5) {
        predictions.push('<br>โข <strong>ุงูุชููุน:</strong> ุณุชุญูู ูุณุชูู <span style="color: #2e7d32;">ุงุจุชูุงุฑ</span> ูู ุงูููุงุฑุงุช ุงููุงุฏูุฉ<br>โข <strong>ุงูุชูุตูุฉ:</strong> ุชุญุฏู ุงูุทุงูุจุฉ ุจูุดุงุฑูุน ูุชูุฏูุฉ');
      } else if (avgPerformance >= 2.5) {
        predictions.push('<br>โข <strong>ุงูุชููุน:</strong> ุณุชุญุงูุธ ุนูู ูุณุชูู <span style="color: #1565c0;">ุฅุชูุงู</span><br>โข <strong>ุงูุชูุตูุฉ:</strong> ุชุดุฌูุน ุงูุฅุจุฏุงุน ูุงูุชูุณุน');
      } else if (avgPerformance >= 1.5) {
        predictions.push('<br>โข <strong>ุงูุชููุน:</strong> ูุฏ ุชูุงุฌู ุตุนูุจุงุช ูู ุงูููุงุฑุงุช ุงููุชูุฏูุฉ<br>โข <strong>ุงูุชูุตูุฉ:</strong> ุชูููุฉ ุงูุฃุณุงุณูุงุช ูุจู ุงููุชุงุจุนุฉ');
      } else if (avgPerformance > 0) {
        predictions.push('<br>โข <strong>ุงูุชููุน:</strong> <span style="color: #c62828;">ุฎุทุฑ ุนุฏู ุฅููุงู ุงูููุฑุฑ</span><br>โข <strong>ุงูุชูุตูุฉ:</strong> ุชุฏุฎู ููุฑู ูุฏุนู ููุซู ูุทููุจ');
      }

      if (completionRate < 50 && evaluatedCount > 0) {
        predictions.push('<br><br>โณ <strong>ููุท ุงูุชูููุฐ:</strong> ุบูุฑ ููุชุธู<br>โข ููุชููุน ุชุฃุฎุฑ ูู ุฅูุฌุงุฒ ุงููุดุงุฑูุน ุงูููุงุฆูุฉ');
      }

      const recentSkills = performanceScores.slice(-3);
      if (recentSkills.length >= 3) {
        const trend = recentSkills[2] - recentSkills[0];
        if (trend > 0) {
          predictions.push('<br><br>๐ <strong>ุงููุณุงุฑ:</strong> ุชุญุณู ููุญูุธ - ุงุณุชูุฑู!');
        } else if (trend < 0) {
          predictions.push('<br><br>๐ <strong>ุงููุณุงุฑ:</strong> ุชุฑุงุฌุน ูู ุงูุฃุฏุงุก - ุชุญุชุงุฌ ูุชุงุจุนุฉ');
        }
      }

      return predictions.join('');
    }

    function getFeedbackColor(student) {
      let needsSupportCount = 0;
      let absentCount = 0;
      
      skills.forEach(skill => {
        if (student[`skill_${skill.id}_level`] === 'ูุญุชุงุฌ ุฏุนู') needsSupportCount++;
        if (student[`skill_${skill.id}_attendance`] === 'ุบุงุฆุจุฉ') absentCount++;
      });

      if (needsSupportCount >= 3 || absentCount >= 3) return '#ffebee';
      if (needsSupportCount > 0) return '#fff3e0';
      return '#f1f8e9';
    }

    function getPredictionColor(student) {
      let performanceScores = [];
      
      skills.forEach(skill => {
        const level = student[`skill_${skill.id}_level`];
        if (level === 'ุงุจุชูุงุฑ') performanceScores.push(4);
        else if (level === 'ุฅุชูุงู') performanceScores.push(3);
        else if (level === 'ุชุทุจูู') performanceScores.push(2);
        else if (level === 'ูุญุชุงุฌ ุฏุนู') performanceScores.push(1);
      });

      if (performanceScores.length === 0) return '#f5f5f5';

      const avgPerformance = performanceScores.reduce((a, b) => a + b, 0) / performanceScores.length;

      if (avgPerformance >= 3.5) return '#e8f5e9';
      if (avgPerformance >= 2.5) return '#e3f2fd';
      if (avgPerformance >= 1.5) return '#fff3e0';
      return '#ffebee';
    }

    function getSmartPlanColor(student) {
      let performanceScores = [];
      
      skills.forEach(skill => {
        const level = student[`skill_${skill.id}_level`];
        if (level && level !== '') {
          if (level === 'ุงุจุชูุงุฑ') performanceScores.push(4);
          else if (level === 'ุฅุชูุงู') performanceScores.push(3);
          else if (level === 'ุชุทุจูู') performanceScores.push(2);
          else if (level === 'ูุญุชุงุฌ ุฏุนู') performanceScores.push(1);
        }
      });

      if (performanceScores.length === 0) return '#fafafa';

      const avgPerformance = performanceScores.reduce((a, b) => a + b, 0) / performanceScores.length;

      if (avgPerformance >= 3.5) return '#f3e5f5';
      if (avgPerformance >= 2.5) return '#e0f2f1';
      if (avgPerformance >= 1.5) return '#fff8e1';
      return '#fce4ec';
    }

    function renderTable() {
      if (isRendering) return;
      isRendering = true;

      const container = document.getElementById('tableContainer');
      
      if (studentsData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">๐ฉโ๐</div>
            <div class="empty-state-text">ูุง ุชูุฌุฏ ุทุงูุจุงุช ูุณุฌูุงุช ุจุนุฏ</div>
            <button class="btn btn-primary" onclick="openStudentModal()">โ ุฅุถุงูุฉ ุฃูู ุทุงูุจุฉ</button>
          </div>
        `;
        isRendering = false;
        return;
      }

      let tableHTML = `
        <div class="table-wrapper">
          <table class="evaluation-table">
            <thead>
              <tr>
                <th rowspan="2" style="min-width: 150px;">ุงุณู ุงูุทุงูุจุฉ</th>
                ${skills.map(skill => `
                  <th colspan="2">ู${skill.id}<br><small>${skill.name}</small></th>
                `).join('')}
                <th rowspan="2" style="min-width: 200px;">๐ฏ ุชุบุฐูุฉ ููุฑูุฉ ูุนูุงุฌูุฉ</th>
                <th rowspan="2" style="min-width: 200px;">๐ค ุงูุชูุจุค ุงูุฐูู</th>
                <th rowspan="2" style="min-width: 250px;">๐ ุงูุฎุทุท ุงูุชุนููููุฉ</th>
                <th rowspan="2" style="min-width: 280px;">๐ง ุฎุทุท ุชุนูู ูุฑูุฉ ุฐููุฉ</th>
                <th rowspan="2" style="min-width: 80px;">ุฅุฌุฑุงุกุงุช</th>
              </tr>
              <tr>
                ${skills.map(() => `
                  <th>ุญุถูุฑ</th>
                  <th>ูุณุชูู</th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              ${studentsData.map(student => `
                <tr>
                  <td class="student-name-cell">${student.student_name}</td>
                  ${skills.map(skill => `
                    <td>
                      <select class="select-field" onchange="updateStudentField('${student.__backendId}', 'skill_${skill.id}_attendance', this.value)">
                        <option value="">-</option>
                        <option value="ุญุงุถุฑุฉ" ${student[`skill_${skill.id}_attendance`] === 'ุญุงุถุฑุฉ' ? 'selected' : ''}>ุญุงุถุฑุฉ</option>
                        <option value="ุบุงุฆุจุฉ" ${student[`skill_${skill.id}_attendance`] === 'ุบุงุฆุจุฉ' ? 'selected' : ''}>ุบุงุฆุจุฉ</option>
                      </select>
                    </td>
                    <td>
                      <select class="select-field ${getLevelClass(student[`skill_${skill.id}_level`])}" onchange="updateStudentField('${student.__backendId}', 'skill_${skill.id}_level', this.value)">
                        <option value="">-</option>
                        <option value="ุงุจุชูุงุฑ" ${student[`skill_${skill.id}_level`] === 'ุงุจุชูุงุฑ' ? 'selected' : ''}>ุงุจุชูุงุฑ</option>
                        <option value="ุฅุชูุงู" ${student[`skill_${skill.id}_level`] === 'ุฅุชูุงู' ? 'selected' : ''}>ุฅุชูุงู</option>
                        <option value="ุชุทุจูู" ${student[`skill_${skill.id}_level`] === 'ุชุทุจูู' ? 'selected' : ''}>ุชุทุจูู</option>
                        <option value="ูุญุชุงุฌ ุฏุนู" ${student[`skill_${skill.id}_level`] === 'ูุญุชุงุฌ ุฏุนู' ? 'selected' : ''}>ูุญุชุงุฌ ุฏุนู</option>
                        <option value="ูู ุชููุฐ" ${student[`skill_${skill.id}_level`] === 'ูู ุชููุฐ' ? 'selected' : ''}>ูู ุชููุฐ</option>
                      </select>
                    </td>
                  `).join('')}
                  <td style="background: ${getFeedbackColor(student)}; padding: 8px; text-align: right; font-size: 9px; line-height: 1.5;">
                    ${generateMissingSkillsAlert(student)}
                    ${generateFeedback(student)}
                  </td>
                  <td style="background: ${getPredictionColor(student)}; padding: 8px; text-align: right; font-size: 9px; line-height: 1.5;">
                    ${generateAIPrediction(student)}
                  </td>
                  <td style="background: #fafafa; padding: 8px; text-align: right; font-size: 9px; line-height: 1.5; max-height: 350px; overflow-y: auto;">
                    ${generateLearningPlans(student)}
                  </td>
                  <td style="background: ${getSmartPlanColor(student)}; padding: 8px; text-align: right; font-size: 9px; line-height: 1.5; max-height: 350px; overflow-y: auto;">
                    ${generateSmartLearningPlans(student)}
                  </td>
                  <td style="text-align: center;">
                    <button class="btn btn-danger" onclick="deleteStudent('${student.__backendId}')">ุญุฐู</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = tableHTML;
      
      setTimeout(() => {
        isRendering = false;
      }, 100);
    }

    function getLevelClass(level) {
      switch(level) {
        case 'ุงุจุชูุงุฑ': return 'level-innovation';
        case 'ุฅุชูุงู': return 'level-mastery';
        case 'ุชุทุจูู': return 'level-application';
        case 'ูุญุชุงุฌ ุฏุนู': return 'level-needs-support';
        case 'ูู ุชููุฐ': return 'level-not-completed';
        default: return '';
      }
    }

    async function addStudent(studentName) {
      if (studentsData.length >= 999) {
        showMessage("ุชู ุงููุตูู ููุญุฏ ุงูุฃูุตู (999 ุทุงูุจุฉ). ูุฑุฌู ุญุฐู ุจุนุถ ุงูุทุงูุจุงุช ุฃููุงู.");
        return;
      }

      setLoading(true);
      const newStudent = {
        student_name: studentName,
        created_at: new Date().toISOString()
      };

      skills.forEach(skill => {
        newStudent[`skill_${skill.id}_attendance`] = "";
        newStudent[`skill_${skill.id}_level`] = "";
      });

      const result = await window.dataSdk.create(newStudent);
      setLoading(false);

      if (result.isOk) {
        closeStudentModal();
        showSuccessMessage("โ ุชู ุญูุธ ุงูุทุงูุจุฉ ุจูุฌุงุญ");
      } else {
        showMessage("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงูุทุงูุจุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
      }
    }

    async function updateStudentField(backendId, field, value) {
      const student = studentsData.find(s => s.__backendId === backendId);
      if (!student) return;

      setLoading(true);
      const updatedStudent = { ...student, [field]: value };
      const result = await window.dataSdk.update(updatedStudent);
      setLoading(false);

      if (result.isOk) {
        showSuccessMessage("โ ุชู ุญูุธ ุงูุชุนุฏูู");
      } else {
        showMessage("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญุฏูุซ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
      }
    }

    async function deleteStudent(backendId) {
      const student = studentsData.find(s => s.__backendId === backendId);
      if (!student) return;

      if (student.is_predefined === true) {
        showMessage("ูุง ูููู ุญุฐู ุงูุทุงูุจุงุช ุงูุซุงุจุชุงุช ูู ุงููุงุฆูุฉ ุงูุฃุณุงุณูุฉ");
        return;
      }

      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center;';
      confirmDiv.innerHTML = `
        <p style="font-size: 18px; margin-bottom: 20px; color: #424242;">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุทุงูุจุฉ: <strong>${student.student_name}</strong>ุ</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">ุฅูุบุงุก</button>
          <button class="btn btn-danger" onclick="confirmDelete('${backendId}')">ุชุฃููุฏ ุงูุญุฐู</button>
        </div>
      `;
      document.body.appendChild(confirmDiv);
    }

    async function confirmDelete(backendId) {
      document.querySelectorAll('div').forEach(div => {
        if (div.textContent.includes('ูู ุฃูุช ูุชุฃูุฏ')) div.remove();
      });

      const student = studentsData.find(s => s.__backendId === backendId);
      if (!student) return;

      setLoading(true);
      const result = await window.dataSdk.delete(student);
      setLoading(false);

      if (result.isOk) {
        showSuccessMessage("โ ุชู ุญูุธ ุงูุญุฐู");
      } else {
        showMessage("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
      }
    }

    function openStudentModal() {
      document.getElementById('studentModal').classList.add('active');
      document.getElementById('studentNameInput').value = '';
      document.getElementById('studentNameInput').focus();
    }

    function closeStudentModal() {
      document.getElementById('studentModal').classList.remove('active');
    }

    function setLoading(loading) {
      isLoading = loading;
      const indicator = document.getElementById('loadingIndicator');
      const addBtn = document.getElementById('addStudentBtn');
      const addPredefinedBtn = document.getElementById('addPredefinedBtn');
      const saveBtn = document.getElementById('saveStudentBtn');
      
      if (loading) {
        indicator.style.display = 'block';
        if (addBtn) addBtn.disabled = true;
        if (addPredefinedBtn) addPredefinedBtn.disabled = true;
        if (saveBtn) saveBtn.disabled = true;
      } else {
        indicator.style.display = 'none';
        if (addBtn) addBtn.disabled = false;
        if (addPredefinedBtn) addPredefinedBtn.disabled = false;
        if (saveBtn) saveBtn.disabled = false;
      }
    }

    function showMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #323232; color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000;';
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);
      setTimeout(() => messageDiv.remove(), 3000);
    }

    function showSuccessMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%); color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4); z-index: 10000; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px;';
      messageDiv.innerHTML = `<span style="font-size: 18px;">โ</span><span>${message}</span>`;
      document.body.appendChild(messageDiv);
      setTimeout(() => {
        messageDiv.style.transition = 'opacity 0.3s ease';
        messageDiv.style.opacity = '0';
        setTimeout(() => messageDiv.remove(), 300);
      }, 2000);
    }

    async function handleExcelImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      setLoading(true);
      
      try {
        const data = await readExcelFile(file);
        await importStudentsFromExcel(data);
      } catch (error) {
        showMessage('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ุงูููู: ' + error.message);
      } finally {
        setLoading(false);
        event.target.value = '';
      }
    }

    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            resolve(jsonData);
          } catch (error) {
            reject(error);
          }
        };
        
        reader.onerror = () => reject(new Error('ูุดู ูู ูุฑุงุกุฉ ุงูููู'));
        reader.readAsArrayBuffer(file);
      });
    }

    async function importStudentsFromExcel(data) {
      if (data.length < 2) {
        throw new Error('ุงูููู ูุงุฑุบ ุฃู ูุง ูุญุชูู ุนูู ุจูุงูุงุช');
      }

      const headers = data[0];
      const studentNameIndex = headers.findIndex(h => 
        h && (h.toString().includes('ุงุณู') || h.toString().includes('ุงูุทุงูุจุฉ') || h.toString().includes('Student'))
      );

      if (studentNameIndex === -1) {
        throw new Error('ูู ูุชู ุงูุนุซูุฑ ุนูู ุนููุฏ ุงุณู ุงูุทุงูุจุฉ');
      }

      const skillColumns = [];
      headers.forEach((header, index) => {
        if (!header) return;
        const headerStr = header.toString();
        
        for (let i = 1; i <= 9; i++) {
          if (headerStr.includes(`ู${i}`) || headerStr.includes(`ุงูููุงุฑุฉ ${i}`)) {
            if (headerStr.includes('ุญุถูุฑ') || headerStr.includes('Attendance')) {
              skillColumns.push({ skillId: i, type: 'attendance', index });
            } else if (headerStr.includes('ูุณุชูู') || headerStr.includes('Level')) {
              skillColumns.push({ skillId: i, type: 'level', index });
            }
          }
        }
      });

      let importedCount = 0;
      let skippedCount = 0;

      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if (!row || row.length === 0) continue;

        const studentName = row[studentNameIndex];
        if (!studentName || studentName.toString().trim() === '') continue;

        if (studentsData.length + importedCount >= 999) {
          showMessage(`ุชู ุงููุตูู ููุญุฏ ุงูุฃูุตู. ุชู ุงุณุชูุฑุงุฏ ${importedCount} ุทุงูุจุฉ.`);
          break;
        }

        const newStudent = {
          student_name: studentName.toString().trim(),
          created_at: new Date().toISOString()
        };

        skills.forEach(skill => {
          newStudent[`skill_${skill.id}_attendance`] = "";
          newStudent[`skill_${skill.id}_level`] = "";
        });

        skillColumns.forEach(col => {
          const value = row[col.index];
          if (value) {
            const fieldName = `skill_${col.skillId}_${col.type}`;
            newStudent[fieldName] = value.toString().trim();
          }
        });

        const result = await window.dataSdk.create(newStudent);
        
        if (result.isOk) {
          importedCount++;
        } else {
          skippedCount++;
        }
      }

      if (importedCount === 0) {
        throw new Error('ูู ูุชู ุงุณุชูุฑุงุฏ ุฃู ุทุงูุจุฉ. ุชุฃูุฏู ูู ุตุญุฉ ุงูุจูุงูุงุช.');
      }

      showSuccessMessage(`โ ุชู ุญูุธ ${importedCount} ุทุงูุจุฉ ูู Excel${skippedCount > 0 ? ` (ุชู ุชุฎุทู ${skippedCount})` : ''}`);
    }

    function exportToExcel() {
      if (studentsData.length === 0) {
        showMessage('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุตุฏูุฑ');
        return;
      }

      const exportData = [];
      
      const headers = ['ุงุณู ุงูุทุงูุจุฉ'];
      skills.forEach(skill => {
        headers.push(`ู${skill.id} ุญุถูุฑ`);
        headers.push(`ู${skill.id} ูุณุชูู`);
      });
      headers.push('ุงูุชุบุฐูุฉ ุงูููุฑูุฉ');
      headers.push('ุงูุชูุจุค ุงูุฐูู');
      exportData.push(headers);

      studentsData.forEach(student => {
        const row = [student.student_name];
        
        skills.forEach(skill => {
          row.push(student[`skill_${skill.id}_attendance`] || '');
          row.push(student[`skill_${skill.id}_level`] || '');
        });
        
        const feedback = generateFeedbackText(student);
        const prediction = generatePredictionText(student);
        row.push(feedback);
        row.push(prediction);
        
        exportData.push(row);
      });

      const ws = XLSX.utils.aoa_to_sheet(exportData);
      
      const colWidths = [
        { wch: 25 },
        ...Array(18).fill({ wch: 12 }),
        { wch: 40 },
        { wch: 40 }
      ];
      ws['!cols'] = colWidths;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'ุชูููู ุงูุทุงูุจุงุช');

      const date = new Date();
      const fileName = `ุชูููู_ุงูุทุงูุจุงุช_${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}.xlsx`;
      
      XLSX.writeFile(wb, fileName);
      showMessage('โ ุชู ุชุตุฏูุฑ ุงูุจูุงูุงุช ุจูุฌุงุญ!');
    }

    function generateFeedbackText(student) {
      let needsSupportCount = 0;
      let absentCount = 0;
      let innovationCount = 0;
      let masteryCount = 0;

      skills.forEach(skill => {
        const attendance = student[`skill_${skill.id}_attendance`];
        const level = student[`skill_${skill.id}_level`];
        if (attendance === 'ุบุงุฆุจุฉ') absentCount++;
        if (level === 'ูุญุชุงุฌ ุฏุนู') needsSupportCount++;
        if (level === 'ุงุจุชูุงุฑ') innovationCount++;
        if (level === 'ุฅุชูุงู') masteryCount++;
      });

      let feedback = '';
      if (absentCount >= 3) feedback += 'ุชูุจูู: ุบูุงุจ ูุชูุฑุฑ. ';
      if (needsSupportCount >= 3) feedback += 'ูุญุชุงุฌ ุฏุนู ููุซู. ';
      if (innovationCount >= 3) feedback += 'ุฃุฏุงุก ูุชููุฒ! ';
      else if (masteryCount >= 5) feedback += 'ูุณุชูู ุฌูุฏ ุฌุฏุงู. ';
      
      return feedback || 'ุงุณุชูุฑู ูู ุงูุชูุฏู';
    }

    function generatePredictionText(student) {
      let performanceScores = [];
      let evaluatedCount = 0;

      skills.forEach(skill => {
        const level = student[`skill_${skill.id}_level`];
        if (level && level !== '' && level !== 'ูู ุชููุฐ') {
          evaluatedCount++;
          if (level === 'ุงุจุชูุงุฑ') performanceScores.push(4);
          else if (level === 'ุฅุชูุงู') performanceScores.push(3);
          else if (level === 'ุชุทุจูู') performanceScores.push(2);
          else if (level === 'ูุญุชุงุฌ ุฏุนู') performanceScores.push(1);
        }
      });

      if (evaluatedCount === 0) return 'ุจุงูุชุธุงุฑ ุงูุชูููู';

      const avgPerformance = performanceScores.reduce((a, b) => a + b, 0) / performanceScores.length;

      if (avgPerformance >= 3.5) return 'ุชููุน: ุฃุฏุงุก ูุชููุฒ ูุณุชูุฑ';
      if (avgPerformance >= 2.5) return 'ุชููุน: ูุณุชูู ุฌูุฏ';
      if (avgPerformance >= 1.5) return 'ุชููุน: ูุญุชุงุฌ ุชุญุณูู';
      return 'ุชููุน: ูุญุชุงุฌ ุฏุนู ุนุงุฌู';
    }

    async function clearAllData() {
      const confirmDiv = document.createElement('div');
      confirmDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center; max-width: 400px;';
      confirmDiv.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 15px;">โ๏ธ</div>
        <p style="font-size: 18px; margin-bottom: 15px; color: #424242; font-weight: bold;">ุชุญุฐูุฑ: ุนูููุฉ ุฎุทุฑุฉ!</p>
        <p style="font-size: 16px; margin-bottom: 20px; color: #666;">ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู <strong style="color: #d32f2f;">ุฌููุน ุงูุทุงูุจุงุช</strong> ูุจูุงูุงุชููุ<br><br>ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก!</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">ุฅูุบุงุก</button>
          <button class="btn btn-danger" onclick="confirmClearAll()">ุชุฃููุฏ ุงููุณุญ ุงููุงูู</button>
        </div>
      `;
      document.body.appendChild(confirmDiv);
    }

    async function confirmClearAll() {
      document.querySelectorAll('div').forEach(div => {
        if (div.textContent.includes('ุชุญุฐูุฑ: ุนูููุฉ ุฎุทุฑุฉ')) div.remove();
      });

      if (studentsData.length === 0) {
        showMessage('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุญุฐููุง');
        return;
      }

      setLoading(true);
      
      let deletedCount = 0;
      let failedCount = 0;

      for (const student of studentsData) {
        const result = await window.dataSdk.delete(student);
        if (result.isOk) {
          deletedCount++;
        } else {
          failedCount++;
        }
      }

      setLoading(false);

      if (failedCount === 0) {
        showSuccessMessage(`โ ุชู ุญูุธ ุงููุณุญ ุงููุงูู (${deletedCount} ุทุงูุจุฉ)`);
      } else {
        showMessage(`โ๏ธ ุชู ุญุฐู ${deletedCount} ุทุงูุจุฉุ ูุดู ุญุฐู ${failedCount}`);
      }
    }

    window.openStudentModal = openStudentModal;
    window.updateStudentField = updateStudentField;
    window.deleteStudent = deleteStudent;
    window.confirmDelete = confirmDelete;
    window.clearAllData = clearAllData;
    window.confirmClearAll = confirmClearAll;

    document.addEventListener('DOMContentLoaded', () => {
      const addStudentBtn = document.getElementById('addStudentBtn');
      const addPredefinedBtn = document.getElementById('addPredefinedBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      const importExcelBtn = document.getElementById('importExcelBtn');
      const exportExcelBtn = document.getElementById('exportExcelBtn');
      const clearAllBtn = document.getElementById('clearAllBtn');
      const excelFileInput = document.getElementById('excelFileInput');
      const studentForm = document.getElementById('studentForm');
      const studentModal = document.getElementById('studentModal');

      if (addStudentBtn) {
        addStudentBtn.addEventListener('click', openStudentModal);
      }

      if (addPredefinedBtn) {
        addPredefinedBtn.addEventListener('click', addPredefinedStudents);
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', closeStudentModal);
      }

      if (importExcelBtn) {
        importExcelBtn.addEventListener('click', () => {
          if (excelFileInput) excelFileInput.click();
        });
      }

      if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', exportToExcel);
      }

      if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllData);
      }

      if (excelFileInput) {
        excelFileInput.addEventListener('change', handleExcelImport);
      }

      if (studentForm) {
        studentForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const studentName = document.getElementById('studentNameInput').value.trim();
          if (studentName) {
            addStudent(studentName);
          }
        });
      }

      if (studentModal) {
        studentModal.addEventListener('click', (e) => {
          if (e.target.id === 'studentModal') {
            closeStudentModal();
          }
        });
      }
    });

    async function onConfigChange(config) {
      const backgroundColor = config.background_color || defaultConfig.background_color;
      const cardColor = config.card_color || defaultConfig.card_color;

      document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, #2575fc 100%)`;
      document.querySelector('.container').style.background = cardColor;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.card_color || defaultConfig.card_color,
            set: (value) => {
              config.card_color = value;
              window.elementSdk.setConfig({ card_color: value });
            }
          },
          {
            get: () => config.primary_color || defaultConfig.primary_color,
            set: (value) => {
              config.primary_color = value;
              window.elementSdk.setConfig({ primary_color: value });
            }
          },
          {
            get: () => config.accent_color || defaultConfig.accent_color,
            set: (value) => {
              config.accent_color = value;
              window.elementSdk.setConfig({ accent_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["page_title", config.page_title || defaultConfig.page_title],
        ["semester_info", config.semester_info || defaultConfig.semester_info]
      ]);
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

    initializeApp();

  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9abb291002f7ce00',t:'MTc2NTM1MzEyMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
