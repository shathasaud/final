<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ููุญุฉ ูุชุงุจุนุฉ ุงูุชูููู โ ุฏุฎูู</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&amp;display=swap" rel="stylesheet">
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
      --card: #ffffff;
      --soft: #f5f5f7;
      --text: #2d3748;
      --muted: #718096;
      --brand: #7986cb;
      --brand-2: #5c6bc0;
      --accent: #9fa8da;
      --danger: #ef9a9a;
      --success: #a5d6a7;
      --warning: #ffcc80;
      --info: #90caf9;
      --ring: rgba(121, 134, 203, 0.3);
    }

    body {
      box-sizing: border-box;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: inherit;
    }

    html, body {
      height: 100%;
      font-family: 'Tajawal', 'Noto Sans Arabic', 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      width: min(1100px, 94%);
      margin-inline: auto;
    }

    .site-header {
      background: linear-gradient(135deg, #9fa8da 0%, #7986cb 50%, #5c6bc0 100%);
      color: #ffffff;
      padding: 28px 0;
      margin-bottom: 24px;
      box-shadow: 0 10px 40px rgba(92, 107, 192, 0.25);
      border-bottom: 4px solid rgba(255, 255, 255, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .site-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
      border-radius: 50%;
    }
    
    .site-header::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -5%;
      width: 250px;
      height: 250px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }

    .site-header h1 {
      margin: 0;
      font-size: 26px;
      text-align: center;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 1;
    }

    .site-header .muted {
      margin: 8px 0 0;
      color: rgba(255, 255, 255, 0.95);
      font-size: 16px;
      text-align: center;
      font-weight: 600;
      position: relative;
      z-index: 1;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.15);
    }

    .card {
      background: var(--card);
      border: none;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
    }

    .section-title {
      margin: 0 0 10px;
      font-size: 18px;
      color: var(--text);
    }

    .menu {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
    }

    .menu-btn {
      width: 100%;
      text-align: right;
      padding: 18px 24px;
      border-radius: 16px;
      cursor: pointer;
      border: 3px solid transparent;
      background: linear-gradient(135deg, #9fa8da 0%, #7986cb 100%);
      color: #ffffff;
      font-weight: 700;
      font-size: 17px;
      transition: all 0.3s ease;
      box-shadow: 0 5px 20px rgba(121, 134, 203, 0.35);
      position: relative;
      overflow: hidden;
    }
    
    .menu-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .menu-btn:hover::before {
      left: 100%;
    }

    .menu-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(121, 134, 203, 0.5);
      border-color: #ffffff;
    }
    
    .menu-btn:nth-child(1) {
      background: linear-gradient(135deg, #b39ddb 0%, #9575cd 100%);
    }
    
    .menu-btn:nth-child(2) {
      background: linear-gradient(135deg, #a5d6a7 0%, #81c784 100%);
    }
    
    .menu-btn:nth-child(3) {
      background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%);
    }

    .login-card {
      margin-top: 12px;
      background: var(--soft);
      border: 1px dashed #d9e2ec;
      padding: 12px;
      border-radius: 12px;
    }

    .login-card h3 {
      font-size: 18px;
      color: var(--text);
      margin-bottom: 12px;
    }

    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }

    .row.wrap {
      flex-wrap: wrap;
    }

    .row.end {
      justify-content: flex-end;
      margin-top: 12px;
    }

    .row label {
      font-size: 14px;
      color: var(--muted);
      min-width: 120px;
    }

    .row input,
    .row select {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #dfe7f1;
      background: #fff;
      color: var(--text);
      outline: none;
      min-width: 200px;
    }

    .row input:focus,
    .row select:focus {
      box-shadow: 0 0 0 3px var(--ring);
    }

    .row button {
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.2px;
      background: linear-gradient(90deg, #7986cb, #5c6bc0);
      border: none;
      color: #ffffff;
      border-radius: 10px;
    }

    .row button.ghost {
      background: #fff;
      color: var(--text);
      border: 1px dashed #d9e2ec;
    }

    .row button.ghost:hover {
      background: var(--soft);
    }

    .hint {
      margin-top: 8px;
      font-size: 12px;
      color: #2a6b56;
    }

    .hidden {
      display: none !important;
    }

    .panel-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 10px 18px;
      border-radius: 25px;
      background: linear-gradient(135deg, #f8f9ff 0%, #e9ecff 100%);
      border: 2px solid rgba(102, 126, 234, 0.2);
      color: var(--brand);
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }
    
    .pill.active {
      outline: 3px solid var(--brand-2);
      box-shadow: 0 0 0 5px var(--ring), 0 4px 12px rgba(121, 134, 203, 0.4);
      transform: scale(1.05);
    }
    
    .pill.success {
      background: linear-gradient(135deg, #d4f4dd 0%, #b8f2c6 100%);
      border-color: rgba(72, 187, 120, 0.3);
      color: #22543d;
    }
    
    .pill.warning {
      background: linear-gradient(135deg, #fef5e7 0%, #fdecc8 100%);
      border-color: rgba(237, 137, 54, 0.3);
      color: #7c2d12;
    }
    
    .pill.info {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: rgba(66, 153, 225, 0.3);
      color: #1e3a8a;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-width: 220px;
    }

    .field label {
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }

    .field input,
    .field select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #dfe7f1;
      background: #fff;
      color: var(--text);
      outline: none;
    }

    .field input:focus,
    .field select:focus {
      box-shadow: 0 0 0 3px var(--ring);
    }

    .tools {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .tools button {
      padding: 10px 16px;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      color: #ffffff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .tools button.ghost {
      background: #fff;
      color: var(--text);
      border: 1px dashed #d9e2ec;
    }

    .tools button.danger {
      background: linear-gradient(90deg, var(--danger), #f7b0aa);
      color: #4b0e0c;
    }

    .table-wrap {
      overflow: auto;
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid #e8edf3;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
      background: var(--card);
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #f5f9fc;
      color: #3b4a5f;
      border-bottom: 1px solid #e6eef7;
      padding: 10px 8px;
      text-align: center;
      font-weight: 600;
    }

    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid #eef3f9;
      text-align: center;
    }

    tbody tr:hover {
      background: #f7fafc;
    }

    table input[type="number"],
    table input[type="text"] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #dfe7f1;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }

    table input:focus {
      box-shadow: 0 0 0 3px var(--ring) inset;
    }

    .card-soft {
      background: var(--soft);
      border: 1px dashed #d9e2ec;
      border-radius: 14px;
      padding: 12px;
      margin: 12px 0;
    }

    .summary .pill {
      margin: 5px;
    }

    .progress {
      height: 14px;
      border-radius: 999px;
      background: #e8eaf6;
      overflow: hidden;
      margin-top: 10px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress > span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, #7986cb 0%, #5c6bc0 100%);
      transition: width 0.5s ease;
      box-shadow: 0 2px 8px rgba(121, 134, 203, 0.4);
      position: relative;
      overflow: hidden;
    }
    
    .progress > span::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .split .card-soft {
      padding: 20px;
    }

    .split h3 {
      color: var(--text);
      margin-bottom: 12px;
      font-size: 16px;
    }

    #sDetails, #pSummary {
      margin: 12px 0;
      line-height: 1.8;
    }

    #sDetails p, #pSummary p {
      margin: 6px 0;
      font-size: 14px;
      color: var(--text);
    }

    .muted {
      color: var(--muted);
      font-size: 13px;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--text);
      color: white;
      padding: 14px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-content {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }

    .modal-content h3 {
      color: var(--text);
      margin-bottom: 16px;
      font-size: 18px;
    }

    .modal-content p {
      color: var(--muted);
      margin-bottom: 16px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      justify-content: flex-end;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
    }

    .modal-buttons .confirm {
      background: linear-gradient(90deg, var(--danger), #f7b0aa);
      color: #4b0e0c;
    }

    .modal-buttons .cancel {
      background: #fff;
      color: var(--text);
      border: 1px dashed #d9e2ec;
    }

    @media (max-width: 768px) {
      .site-header h1 {
        font-size: 18px;
      }

      .panel-head {
        flex-direction: column;
        align-items: flex-start;
      }

      .row {
        flex-direction: column;
        align-items: stretch;
      }

      .row label {
        min-width: auto;
      }

      .tools button {
        width: 100%;
      }

      .split {
        grid-template-columns: 1fr;
      }
    }

    /* ูุงูุฐุฉ ุงูุฎุทุฉ */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center; padding:16px; z-index:50}
    .modal.hidden{display:none}
    .modal__dialog{width:min(760px,96%); background:var(--card); border-radius:16px; border:1px solid #e6eef7; box-shadow:0 20px 50px rgba(0,0,0,.12)}
    .modal__head, .modal__foot{padding:12px 14px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eef3f9}
    .modal__foot{border-top:1px solid #eef3f9; border-bottom:none}
    .modal__body{padding:12px 14px}
    .modal__head h3{margin:0}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .grid label{display:flex; flex-direction:column; gap:6px}
    .grid textarea, .grid input, .grid select{width:100%}

    .plan-box{border:1px dashed #d9e2ec; border-radius:12px; padding:10px; background:var(--soft)}
    .plan-chip{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; margin:2px 4px 0 0; border:1px solid #dfe7f1; background:#fff}
    .plan-good{background:#e7f8ee; border-color:#bfe8cd; color:#165f32}
    .plan-partial{background:#fff8df; border-color:#fde68a; color:#7a5d08}
    .plan-need{background:#ffe7e7; border-color:#fecaca; color:#7a1313}
    
    .due-chip{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; margin:2px 4px 0 0; border:1px solid #dfe7f1; background:#fff; color:#233042}
    .due-soon{background:#fff8df; border-color:#fde68a; color:#7a5d08}
    .due-today{background:#e6f0ff; border-color:#bfdbfe; color:#1e40af}
    .due-overdue{background:#ffe7e7; border-color:#fecaca; color:#7a1313}
    .due-clear{background:#e7f8ee; border-color:#bfe8cd; color:#165f32}
    
    .pill-red{background:#ffe7e7; border-color:#fecaca; color:#7a1313}
    .pill-yellow{background:#fff8df; border-color:#fde68a; color:#7a5d08}
    .pill-blue{background:#e6f0ff; border-color:#bfdbfe; color:#1e40af}

    @media print {
      @page {
        size: A4;
        margin: 12mm;
      }
      .site-header, #loginMenu, #backToMenu1, #backToMenu2, #backToMenu3,
      #importBtn, #exportBtn, #demoBtn, #clearBtn,
      #printBtn, #printStudent, #printParent {
        display: none !important;
      }
      .card, .card-soft {
        box-shadow: none;
        border: none;
        background: white;
        color: black;
      }
      body {
        background: white;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <header class="site-header">
   <div class="container">
    <h1 id="mainTitle">ูุชุงุจุนุฉ ูุฃุฏุงุก ุงูุทุงูุจุฉ ูู ูุงุฏุฉ ุชูููุฉ ุฑูููุฉ _ ูุนุงู 1447 ูู</h1>
    <p class="muted" id="subtitle">ูุนููุฉ ุงููุงุฏุฉ / ุดุฐุง ุงูุฑุฏุงุฏู</p>
   </div>
  </header>
  <main class="container">
   <section id="loginMenu" class="card">
    <h2 class="section-title">ุณุฌูู ุฏุฎููู</h2>
    <ul class="menu">
     <li><button class="menu-btn" data-target="teacherLogin">๐ฉโ๐ซ <span id="teacherBtnText">ุฏุฎูู ุงููุนููุฉ</span></button></li>
     <li><button class="menu-btn" data-target="studentLogin">๐ง <span id="studentBtnText">ููุญุฉ ุงูุทุงูุจุฉ</span></button></li>
     <li><button class="menu-btn" data-target="parentLogin">๐จโ๐ฉโ๐ง <span id="parentBtnText">ููุญุฉ ูููู ุงูุฃูุฑ</span></button></li>
    </ul>
    <div id="teacherLogin" class="login-card hidden">
     <h3>ุฏุฎูู ุงููุนููุฉ</h3>
     <div class="row"><label for="teacherCode">ุงูุฑูู ุงูุณุฑู</label> <input id="teacherCode" type="password" inputmode="numeric" placeholder="****">
     </div>
     <div class="row"><button id="teacherEnter">ุฏุฎูู</button> <button class="ghost" data-close="teacherLogin">ุฅุบูุงู</button>
     </div>
    </div>
    <div id="studentLogin" class="login-card hidden">
     <h3>ุฏุฎูู ุงูุทุงูุจุฉ</h3>
     <div class="row"><label for="studentNameInput">ุงูุงุณู ุงูุซูุงุฆู ุฃู ุฑูู ุงูุณุฌู ุงููุฏูู</label> <input id="studentNameInput" type="text" placeholder="ูุซุงู: ุณุงุฑุฉ ูุญูุฏ ุฃู 1234567890">
     </div>
     <div class="row"><label for="studentClassSelect">ุงููุตู</label> <select id="studentClassSelect"></select>
     </div>
     <div class="row"><button id="studentEnter">ุนุฑุถ ุชูุฑูุฑู</button> <button class="ghost" data-close="studentLogin">ุฅุบูุงู</button>
     </div>
     <div class="hint">
      ๐ก ููููู ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู ุงูุงุณู ุงูุซูุงุฆู ุฃู ุฑูู ุงูุณุฌู ุงููุฏูู
     </div>
    </div>
    <div id="parentLogin" class="login-card hidden">
     <h3>ุฏุฎูู ูููู ุงูุฃูุฑ</h3>
     <div class="row"><label for="parentNameInput">ุงุณู ุงูุทุงูุจุฉ ุงูุซูุงุฆู ุฃู ุฑูู ุงูุณุฌู ุงููุฏูู</label> <input id="parentNameInput" type="text" placeholder="ูุซุงู: ุณุงุฑุฉ ูุญูุฏ ุฃู 1234567890">
     </div>
     <div class="row"><label for="parentClassSelect">ุงููุตู</label> <select id="parentClassSelect"></select>
     </div>
     <div class="row"><button id="parentEnter">ุนุฑุถ ุชูุฑูุฑ ูููู ุงูุฃูุฑ</button> <button class="ghost" data-close="parentLogin">ุฅุบูุงู</button>
     </div>
     <div class="hint">
      ๐ก ูููููู ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู ุงุณู ุงูุทุงูุจุฉ ุงูุซูุงุฆู ุฃู ุฑูู ุงูุณุฌู ุงููุฏูู
     </div>
    </div>
   </section><!-- ูุณู ุงูุฃุณุฑ ุงููุชูุงุนูุฉ -->
   <section id="activeFamiliesSection" class="card" style="background:linear-gradient(135deg, #f8f9ff 0%, #e9ecff 100%);border:3px solid rgba(102, 126, 234, 0.2);box-shadow:0 8px 30px rgba(102,126,234,0.15)">
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;padding:16px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin:-24px -24px 20px -24px;border-radius:20px 20px 0 0"><span style="font-size:32px">๐</span>
     <div>
      <h2 style="color:#ffffff;margin:0;font-size:20px;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,0.2)">ุงูุฃุณุฑ ุงูุฃูุซุฑ ุชูุงุนูุงู</h2>
      <p style="color:rgba(255,255,255,0.9);margin:4px 0 0;font-size:14px;font-weight:600">ุงูุฃุณุฑ ุงูุชู ุชุชุงุจุน ุฃุฏุงุก ุจูุงุชูุง ุจุงูุชุธุงู</p>
     </div>
    </div>
    <div id="activeFamilies" style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;min-height:120px;align-items:center">
     <div style="text-align:center;color:#718096;font-size:14px;padding:40px 20px;background:#f5f5f7;border-radius:16px;border:2px dashed #d9e2ec;width:100%"><span style="font-size:48px;display:block;margin-bottom:12px;opacity:0.6">๐ฅ</span>
      <p style="margin:0;font-weight:600">ูุง ุชูุฌุฏ ุจูุงูุงุช ุชูุงุนู ุจุนุฏ</p>
      <p style="margin:4px 0 0;font-size:12px;opacity:0.8">ุณุชุธูุฑ ุงูุฃุณุฑ ุงููุชูุงุนูุฉ ููุง ุนูุฏ ุฏุฎูููุง ูููุธุงู</p>
     </div>
    </div>
    <div style="margin-top:20px;padding:16px;background:rgba(102,126,234,0.05);border-radius:12px;border:1px solid rgba(102,126,234,0.1)">
     <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><span style="font-size:24px">๐</span>
      <h3 style="color:#5c6bc0;margin:0;font-size:16px;font-weight:700">ุฅุญุตุงุฆูุงุช ุงูุชูุงุนู</h3>
     </div>
     <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
      <div style="text-align:center;padding:16px;background:#ffffff;border-radius:12px;border:2px solid #e8eaf6;box-shadow:0 2px 8px rgba(121,134,203,0.08)">
       <div style="font-size:28px;font-weight:700;color:#7986cb;margin-bottom:4px" id="totalLogins">
        0
       </div>
       <div style="font-size:12px;color:#718096;font-weight:600">
        ุฅุฌูุงูู ูุฑุงุช ุงูุฏุฎูู
       </div>
      </div>
      <div style="text-align:center;padding:16px;background:#ffffff;border-radius:12px;border:2px solid #e8eaf6;box-shadow:0 2px 8px rgba(121,134,203,0.08)">
       <div style="font-size:28px;font-weight:700;color:#7986cb;margin-bottom:4px" id="activeFamiliesCount">
        0
       </div>
       <div style="font-size:12px;color:#718096;font-weight:600">
        ุนุฏุฏ ุงูุฃุณุฑ ุงููุชูุงุนูุฉ
       </div>
      </div>
      <div style="text-align:center;padding:16px;background:#ffffff;border-radius:12px;border:2px solid #e8eaf6;box-shadow:0 2px 8px rgba(121,134,203,0.08)">
       <div style="font-size:28px;font-weight:700;color:#7986cb;margin-bottom:4px" id="todayLogins">
        0
       </div>
       <div style="font-size:12px;color:#718096;font-weight:600">
        ุฏุฎูู ุงูููู
       </div>
      </div>
     </div>
    </div>
   </section><!-- ูุณู ุงูุทุงูุจุงุช ุงููุชููุฒุงุช -->
   <section id="excellentStudentsSection" class="card" style="background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border:3px solid rgba(14, 165, 233, 0.3);box-shadow:0 8px 30px rgba(14,165,233,0.15)">
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;padding:16px;background:linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);margin:-24px -24px 20px -24px;border-radius:20px 20px 0 0"><span style="font-size:32px">๐</span>
     <div>
      <h2 style="color:#ffffff;margin:0;font-size:20px;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,0.2)">ุงูุทุงูุจุงุช ุงูุฃูุซุฑ ุชููุฒุงู</h2>
      <p style="color:rgba(255,255,255,0.9);margin:4px 0 0;font-size:14px;font-weight:600">ุฃูุถู 5 ุทุงูุจุงุช ูู ูู ูุตู ุญุณุจ ูุนุงููุฑ ุงูุชููุฒ ุงูุดุงููุฉ</p>
     </div>
    </div>
    <div style="margin-bottom:20px;padding:16px;background:rgba(14,165,233,0.05);border-radius:12px;border:1px solid rgba(14,165,233,0.1)">
     <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><span style="font-size:24px">๐</span>
      <h3 style="color:#0284c7;margin:0;font-size:16px;font-weight:700">ูุนุงููุฑ ุงูุชูููู</h3>
     </div>
     <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;font-size:13px;color:#374151">
      <div style="padding:16px;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:14px;border:3px solid #0ea5e9;text-align:center;box-shadow:0 4px 12px rgba(14,165,233,0.15);transition:all 0.3s ease" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
       <div style="font-weight:700;color:#0284c7;margin-bottom:6px;font-size:15px">
        ๐ฏ ุงูุงุฎุชุจุงุฑุงุช
       </div>
       <div style="color:#64748b;font-weight:600">
        ุงูุญุฏ ุงูุฃูุตู: 30 ุฏุฑุฌุฉ
       </div>
      </div>
      <div style="padding:16px;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:14px;border:3px solid #0ea5e9;text-align:center;box-shadow:0 4px 12px rgba(14,165,233,0.15);transition:all 0.3s ease" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
       <div style="font-weight:700;color:#0284c7;margin-bottom:6px;font-size:15px">
        โก ุงูุชูููู ุงูุนููู
       </div>
       <div style="color:#64748b;font-weight:600">
        ุงูุญุฏ ุงูุฃูุตู: 30 ุฏุฑุฌุฉ
       </div>
      </div>
      <div style="padding:16px;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:14px;border:3px solid #0ea5e9;text-align:center;box-shadow:0 4px 12px rgba(14,165,233,0.15);transition:all 0.3s ease" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
       <div style="font-weight:700;color:#0284c7;margin-bottom:6px;font-size:15px">
        ๐ ุงููุงุฌุจุงุช
       </div>
       <div style="color:#64748b;font-weight:600">
        ุงูุญุฏ ุงูุฃูุตู: 15 ุฏุฑุฌุฉ
       </div>
      </div>
      <div style="padding:16px;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:14px;border:3px solid #0ea5e9;text-align:center;box-shadow:0 4px 12px rgba(14,165,233,0.15);transition:all 0.3s ease" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
       <div style="font-weight:700;color:#0284c7;margin-bottom:6px;font-size:15px">
        ๐ฌ ุงูููุงูุดุงุช
       </div>
       <div style="color:#64748b;font-weight:600">
        ุงูุญุฏ ุงูุฃูุตู: 15 ุฏุฑุฌุฉ
       </div>
      </div>
      <div style="padding:16px;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:14px;border:3px solid #0ea5e9;text-align:center;box-shadow:0 4px 12px rgba(14,165,233,0.15);transition:all 0.3s ease" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
       <div style="font-weight:700;color:#0284c7;margin-bottom:6px;font-size:15px">
        โญ ููุงุท ุงูุชููุฒ
       </div>
       <div style="color:#64748b;font-weight:600">
        ุนุฏุฏ ุงูููุงุท ุงููุญุตูุฉ
       </div>
      </div>
      <div style="padding:16px;background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:14px;border:3px solid #0ea5e9;text-align:center;box-shadow:0 4px 12px rgba(14,165,233,0.15);transition:all 0.3s ease" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
       <div style="font-weight:700;color:#0284c7;margin-bottom:6px;font-size:15px">
        ๐ช ููุงุท ุงูููุฉ
       </div>
       <div style="color:#64748b;font-weight:600">
        ุนุฏุฏ ุงูููุงุท ุงูุฅูุฌุงุจูุฉ
       </div>
      </div>
     </div>
     <div style="margin-top:12px;padding:12px;background:#fef3c7;border-radius:10px;border:2px solid #fbbf24;text-align:center"><span style="font-size:16px;margin-left:8px">โ๏ธ</span> <span style="color:#92400e;font-weight:700;font-size:14px">ููุงุท ุงูุถุนู ุชููู ูู ููุงุท ุงูุชููุฒ | ูุฌูุฏ ุฎุทุฉ ุนูุงุฌูุฉ ูููู ุงูููุงุท (ูุฃููุง ุชุนูู ูุฌูุฏ ุถุนู)</span>
     </div>
    </div>
    <div style="margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap"><label style="color:#0284c7;font-weight:700;font-size:15px">ุงุฎุชุฑ ุงููุตู:</label> <select id="excellenceClassSelect" style="padding:10px 16px;border:2px solid #0ea5e9;border-radius:12px;background:#ffffff;color:#0284c7;font-weight:600;cursor:pointer;min-width:150px"> <option value="">ุฌููุน ุงููุตูู</option> </select> <button id="refreshExcellence" style="padding:10px 16px;background:linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);color:#ffffff;border:none;border-radius:12px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 12px rgba(14,165,233,0.3);transition:all 0.3s ease">๐ ุชุญุฏูุซ</button>
    </div>
    <div id="excellentStudents" style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;min-height:120px;align-items:center">
     <div style="text-align:center;color:#718096;font-size:14px;padding:40px 20px;background:#f8fafc;border-radius:16px;border:2px dashed #cbd5e1;width:100%"><span style="font-size:48px;display:block;margin-bottom:12px;opacity:0.6">๐</span>
      <p style="margin:0;font-weight:600">ูุง ุชูุฌุฏ ุจูุงูุงุช ุทุงูุจุงุช ุจุนุฏ</p>
      <p style="margin:4px 0 0;font-size:12px;opacity:0.8">ุณุชุธูุฑ ุงูุทุงูุจุงุช ุงููุชููุฒุงุช ููุง ุนูุฏ ุฅุฏุฎุงู ุงูุจูุงูุงุช</p>
     </div>
    </div>
   </section>
   <section id="teacherPanel" class="card hidden" style="background:linear-gradient(135deg, #f5f5f7 0%, #e8eaf6 100%);border:3px solid #c5cae9;box-shadow:0 8px 30px rgba(121,134,203,0.15)">
    <div class="panel-head" style="background:linear-gradient(135deg, #9fa8da 0%, #7986cb 100%);margin:-24px -24px 24px -24px;padding:20px 24px;border-radius:20px 20px 0 0;box-shadow:0 4px 15px rgba(121,134,203,0.2)">
     <h2 class="section-title" style="color:#ffffff;font-size:22px;margin:0;text-shadow:2px 2px 4px rgba(0,0,0,0.2)">๐ฉโ๐ซ ูุงุฌูุฉ ุงููุนููุฉ</h2>
     <div class="row wrap" style="gap:12px">
      <div class="pill" style="background:#ffffff;color:#5c6bc0;border:2px solid #9fa8da;font-weight:700;box-shadow:0 2px 8px rgba(255,255,255,0.3)">
       ๐ ุฃูุงู ูุญูู
      </div><button id="backToMenu1" style="padding:12px 24px;background:#ffffff;color:#5c6bc0;border:2px solid #9fa8da;border-radius:12px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 12px rgba(255,255,255,0.4);transition:all 0.3s ease;">๐ ุนูุฏุฉ ูููุงุฆูุฉ</button>
     </div>
    </div>
    <div class="row wrap" style="gap:16px;background:#ffffff;padding:20px;border-radius:16px;border:2px solid #c5cae9;box-shadow:0 3px 12px rgba(121,134,203,0.08)">
     <div class="field"><label style="color:#5c6bc0;font-weight:700;font-size:15px">๐ ุงููุตู ุงูุฏุฑุงุณู</label> <select id="classSelect" style="border:2px solid #c5cae9;background:#f5f5f7;color:#3f51b5;font-weight:600;padding:12px;border-radius:10px"></select>
     </div>
     <div class="field"><label style="color:#5c6bc0;font-weight:700;font-size:15px">๐ ุจุญุซ ุนู ุทุงูุจุฉ</label> <input id="searchInput" type="search" placeholder="ุงูุชุจู ุงูุงุณูโฆ" style="border:2px solid #c5cae9;background:#f5f5f7;color:#3f51b5;padding:12px;border-radius:10px">
     </div>
    </div>
    <div class="tools" style="background:#ffffff;padding:16px;border-radius:14px;border:2px solid #c5cae9;box-shadow:0 3px 10px rgba(121,134,203,0.08)"><input id="csvFile" type="file" accept=".csv" class="hidden"> <input id="excelFile" type="file" accept=".xlsx,.xls" class="hidden"> <input id="plansExcelFile" type="file" accept=".xlsx,.xls" class="hidden"> <button id="importBtn" style="padding:12px 18px;background:linear-gradient(135deg, #9fa8da 0%, #7986cb 100%);color:#ffffff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 10px rgba(121,134,203,0.3);transition:all 0.3s ease">๐ฅ ุงุณุชูุฑุงุฏ CSV</button> <button id="importExcelBtn" style="padding:12px 18px;background:linear-gradient(135deg, #b39ddb 0%, #9575cd 100%);color:#ffffff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 10px rgba(149,117,205,0.3);transition:all 0.3s ease">๐ ุงุณุชูุฑุงุฏ Excel</button> <button id="importPlansExcelBtn" style="padding:12px 18px;background:linear-gradient(135deg, #ce93d8 0%, #ba68c8 100%);color:#ffffff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 10px rgba(206,147,216,0.3);transition:all 0.3s ease">๐ ุงุณุชูุฑุงุฏ ุฎุทุท Excel</button> <button id="saveAfterImport" style="padding:12px 18px;background:linear-gradient(135deg, #7986cb 0%, #5c6bc0 100%);color:#ffffff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;letter-spacing:0.2px;box-shadow:0 3px 10px rgba(121,134,203,0.35);transition:all 0.3s ease">๐พ ุญูุธ</button> <button id="exportBtn" style="padding:12px 18px;background:linear-gradient(135deg, #80cbc4 0%, #4db6ac 100%);color:#ffffff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 10px rgba(77,182,172,0.3);transition:all 0.3s ease">๐ค ุชุตุฏูุฑ CSV</button> <button id="exportFilteredBtn" style="padding:12px 18px;background:linear-gradient(135deg, #4db6ac 0%, #26a69a 100%);color:#ffffff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 10px rgba(77,182,172,0.3);transition:all 0.3s ease">๐ค ุชุตุฏูุฑ CSV (ุญุณุจ ุงูููุชุฑ)</button> <button id="demoBtn" style="padding:12px 18px;background:linear-gradient(135deg, #90caf9 0%, #64b5f6 100%);color:#ffffff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 10px rgba(100,181,246,0.3);transition:all 0.3s ease">๐ ุจูุงูุงุช ุชุฌุฑูุจูุฉ</button> <button id="clearBtn" style="padding:12px 18px;background:linear-gradient(135deg, #ef9a9a 0%, #e57373 100%);color:#ffffff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 10px rgba(239,154,154,0.3);transition:all 0.3s ease">๐งน ูุณุญ ูุญูู</button>
    </div>
    <div class="summary card-soft" style="background:linear-gradient(135deg, #f5f5f7 0%, #e8eaf6 100%);border:2px solid #c5cae9;border-radius:16px;padding:20px;box-shadow:0 3px 10px rgba(121,134,203,0.1)">
     <div class="row wrap">
      <div class="pill" style="background:#e8eaf6;border:2px solid #9fa8da;color:#5c6bc0">
       ุฅุฌูุงูู ุงูุทุงูุจุงุช: <strong id="countStudents">0</strong>
      </div>
      <div class="pill" style="background:#e8eaf6;border:2px solid #9fa8da;color:#5c6bc0">
       ูุนุฏู ุงููุตู: <strong id="classAvg">โ</strong>
      </div>
      <div class="pill" style="background:#e8eaf6;border:2px solid #9fa8da;color:#5c6bc0">
       ูุณุจุฉ ุงูุญุถูุฑ: <strong id="attRate">โ</strong>
      </div>
     </div>
     <div class="progress">
      <span id="classProgress" style="width:0%"></span>
     </div>
     <div class="row wrap" style="margin-top:16px;gap:10px"><button class="pill pill-red plan-filter" id="pillOver" data-filter="overdue" style="cursor:pointer;transition:all 0.3s ease;border:none">ุฎุทุท ูุชุฃุฎุฑุฉ ๐ด: <strong id="dueOver">0</strong></button> <button class="pill pill-yellow plan-filter" id="pillSoon" data-filter="soon" style="cursor:pointer;transition:all 0.3s ease;border:none">ูุณุชุญูุฉ ูุฑูุจูุง (โค3ุฃูุงู) ๐ก: <strong id="dueSoon">0</strong></button> <button class="pill pill-blue plan-filter" id="pillToday" data-filter="today" style="cursor:pointer;transition:all 0.3s ease;border:none">ูุณุชุญูุฉ ุงูููู ๐ต: <strong id="dueToday">0</strong></button> <button class="pill plan-filter-reset" id="pillReset" data-filter="all" style="cursor:pointer;transition:all 0.3s ease;background:linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);color:#424242;border:none;font-weight:700">ุฅูุบุงุก ุงูููุชุฑ โบ</button>
     </div>
    </div>
    <div class="table-wrap">
     <table id="table">
      <thead>
       <tr>
        <th style="background:linear-gradient(135deg, #9fa8da 0%, #7986cb 100%);color:#ffffff;font-weight:700">#</th>
        <th style="background:linear-gradient(135deg, #7986cb 0%, #5c6bc0 100%);color:#ffffff;font-weight:700">ุงูุณุฌู ุงููุฏูู</th>
        <th style="background:linear-gradient(135deg, #5c6bc0 0%, #3f51b5 100%);color:#ffffff;font-weight:700">ุงูุงุณู ุงูุซูุงุซู</th>
        <th style="background:linear-gradient(135deg, #b39ddb 0%, #9575cd 100%);color:#ffffff;font-weight:700">ุงูุงุฎุชุจุงุฑุงุช ุงูุชุญุฑูุฑูุฉ</th>
        <th style="background:linear-gradient(135deg, #90caf9 0%, #64b5f6 100%);color:#ffffff;font-weight:700">ุงูุชูููู ุงูุนููู</th>
        <th style="background:linear-gradient(135deg, #80cbc4 0%, #4db6ac 100%);color:#ffffff;font-weight:700">ุงููุงุฌุจุงุช ุงูุฑูููุฉ</th>
        <th style="background:linear-gradient(135deg, #a5d6a7 0%, #81c784 100%);color:#ffffff;font-weight:700">ุงูููุงูุดุงุช ุงูุตููุฉ</th>
        <th style="background:linear-gradient(135deg, #bcaaa4 0%, #a1887f 100%);color:#ffffff;font-weight:700">ุงูุญุถูุฑ ( ุนุฏุฏ ุฃูุงู ุงูุบูุงุจ )</th>
        <th style="background:linear-gradient(135deg, #ffcc80 0%, #ffb74d 100%);color:#ffffff;font-weight:700">ุงูุชุนุงูู ูุน ุงููุฌููุนุฉ</th>
        <th style="background:linear-gradient(135deg, #ffd54f 0%, #ffca28 100%);color:#ffffff;font-weight:700" title="ุงุณุชุฎุฏู ุงูุฃุฒุฑุงุฑ + ู - ูุฅุฏุงุฑุฉ ููุงุท ุงูุชููุฒ">ููุงุท ุงูุชููุฒ</th>
        <th style="background:linear-gradient(135deg, #81c784 0%, #66bb6a 100%);color:#ffffff;font-weight:700">ููุงุท ุงูููุฉ</th>
        <th style="background:linear-gradient(135deg, #ef9a9a 0%, #e57373 100%);color:#ffffff;font-weight:700">ููุงุท ุงูุถุนู</th>
        <th style="background:linear-gradient(135deg, #9fa8da 0%, #7986cb 100%);color:#ffffff;font-weight:700;font-size:15px">ุงููุฌููุน</th>
        <th style="background:linear-gradient(135deg, #9575cd 0%, #7e57c2 100%);color:#ffffff;font-weight:700">ุญุงูุฉ</th>
        <th style="background:linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);color:#ffffff;font-weight:700">ุฎุทุฉ ุฑูุน ุงููุณุชูู</th>
       </tr>
      </thead>
      <tbody></tbody>
     </table>
    </div>
    <div class="row end"><button id="saveGrades" style="padding:12px 20px;background:linear-gradient(90deg, #81c784, #66bb6a);color:#ffffff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;letter-spacing:0.2px;margin-left:10px;box-shadow:0 3px 10px rgba(129,199,132,0.3);">๐พ ุญูุธ ุงูุชุนุฏููุงุช</button> <button id="printBtn" style="padding:12px 20px;background:#fff;color:var(--text);border:1px dashed #d9e2ec;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;">๐จ๏ธ ุทุจุงุนุฉ ูุฎุชุตุฑุฉ</button>
    </div>
   </section>
   <section id="studentPanel" class="card hidden">
    <div class="panel-head">
     <h2 class="section-title">ููุญุฉ ุงูุทุงูุจุฉ</h2><button id="backToMenu2" style="padding:12px 20px;background:linear-gradient(135deg, #9fa8da 0%, #7986cb 100%);color:#ffffff;border:none;border-radius:12px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 12px rgba(121,134,203,0.3);transition:all 0.3s ease;">๐ ุนูุฏุฉ ูููุงุฆูุฉ</button>
    </div>
    <div id="studentReport" class="hidden">
     <div class="card-soft" style="background:linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);padding:20px;border-radius:16px;margin-bottom:20px;border:2px solid #a5d6a7;box-shadow:0 3px 10px rgba(0,0,0,0.05)">
      <div class="row wrap" style="gap:12px;justify-content:center">
       <div class="pill info" style="font-size:15px;background:#e3f2fd;color:#1565c0;border:2px solid #90caf9">
        ๐ง ุงูุทุงูุจุฉ: <strong id="sName" style="margin-right:8px"></strong>
       </div>
       <div class="pill info" style="font-size:15px;background:#fff3e0;color:#e65100;border:2px solid #ffcc80">
        ๐ ุงููุตู: <strong id="sClass" style="margin-right:8px"></strong>
       </div>
       <div class="pill" style="font-size:16px;background:linear-gradient(135deg, #81c784 0%, #66bb6a 100%);color:#fff;border:none;box-shadow:0 3px 10px rgba(129,199,132,0.3)">
        โญ ูุฌููุนู: <strong id="sTotal" style="margin-right:8px"></strong>
       </div>
      </div>
     </div>
     <div class="split">
      <div class="card-soft" style="background:#fafbfc;border:2px solid #e1e8ed;box-shadow:0 2px 8px rgba(0,0,0,0.04)">
       <canvas id="studentChart" height="220"></canvas>
      </div>
      <div class="card-soft" style="background:#fafbfc;border:2px solid #e1e8ed;box-shadow:0 2px 8px rgba(0,0,0,0.04)">
       <h3 style="color:#37474f;font-size:17px;margin-bottom:16px;border-bottom:2px solid #b0bec5;padding-bottom:8px">๐ ุชูุงุตูู ุงูุฃุฏุงุก</h3>
       <div id="sDetails"></div>
       <div class="progress">
        <span id="sProgress" style="width:0%"></span>
       </div>
       <p class="muted" style="margin-top:12px;padding:12px;background:#fff8e1;border-right:4px solid #ffc107;border-radius:8px">๐ก ูุตูุญุฉ: <span id="sTip"></span></p>
       <div class="card-soft" style="margin-top:16px;background:#f0f9ff;border:2px solid #90caf9">
        <h3 style="color:#1565c0;font-size:15px;margin-bottom:10px;display:flex;align-items:center;gap:8px">๐ ุฎุทุฉ ุฑูุน ุงููุณุชูู</h3>
        <div id="sPlanBox" class="plan-box muted">
         ูุง ุชูุฌุฏ ุฎุทุฉ ูุณุฌูุฉ ุจุนุฏ.
        </div>
       </div><button id="contactTeacherStudent" style="width:100%;padding:14px;background:linear-gradient(90deg, #25D366, #128C7E);color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:14px;font-weight:700;margin-top:16px;box-shadow:0 4px 12px rgba(37,211,102,0.3);transition:all 0.3s ease">๐ฒ ุชูุงุตู ูุน ุงููุนููุฉ</button> <button id="printStudent" style="width:100%;padding:14px;background:linear-gradient(90deg, #81c784, #66bb6a);color:#ffffff;border:none;border-radius:12px;cursor:pointer;font-size:14px;font-weight:700;margin-top:12px;box-shadow:0 4px 12px rgba(129,199,132,0.3);transition:all 0.3s ease">๐จ๏ธ ุทุจุงุนุฉ/ุญูุธ PDF</button>
      </div>
     </div>
     <div class="card-soft" style="margin-top:24px;background:linear-gradient(135deg, #f5f5f7 0%, #e8eaf6 100%);border:2px solid #c5cae9;border-radius:18px;padding:28px;box-shadow:0 4px 15px rgba(121,134,203,0.1)">
      <h3 style="color:#5c6bc0;margin-bottom:20px;font-size:19px;display:flex;align-items:center;gap:12px;border-bottom:3px solid #9fa8da;padding-bottom:12px;font-weight:700"><span style="font-size:26px">๐</span> <span>ุจุตูุชู ุทุงูุจุฉ ุดุงุฑูู ูุนููุชู</span></h3>
      <div class="field" style="margin-bottom:20px;"><label style="color:#3f51b5;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #7986cb">โจ ุตูุฉ ุฃุชุญูู ุจูุง</label> <input id="studentTrait" type="text" placeholder="ูุซุงู: ุฎุฌููุฉุ ุฌุฑูุฆุฉุ ูุชุณุฑุนุฉุ ุงููุนุงููุฉ..." style="background:#fff;border:2px solid #c5cae9;border-radius:12px;padding:14px;font-size:14px;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(121,134,203,0.08)">
      </div>
      <div class="field"><label style="color:#3f51b5;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #7986cb">๐ฏ ููุงุฑุฉ ุฃุชููุฒ ุจูุง</label> <input id="studentSkill" type="text" placeholder="ูุซุงู: ุงูุฑุณูุ ุงูุชุตูููุ ุญู ุงููุดููุงุช..." style="background:#fff;border:2px solid #c5cae9;border-radius:12px;padding:14px;font-size:14px;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(121,134,203,0.08)">
      </div>
     </div>
     <div class="card-soft" style="margin-top:24px;background:linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);border:2px solid #ce93d8;border-radius:18px;padding:28px;box-shadow:0 4px 15px rgba(156,39,176,0.1)">
      <h3 style="color:#7e57c2;margin-bottom:20px;font-size:19px;display:flex;align-items:center;gap:12px;border-bottom:3px solid #b39ddb;padding-bottom:12px;font-weight:700"><span style="font-size:26px">๐ก</span> <span>ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุนูู ุงูููุถูุฉ</span></h3>
      <p style="color:#5e35b1;font-size:14px;line-height:2;margin-bottom:20px;background:#fff;padding:18px;border-radius:12px;border-right:4px solid #9575cd;box-shadow:0 2px 8px rgba(149,117,205,0.08)">ูู ูุงุฏุฉ ุงูุชูููุฉ ุงูุฑูููุฉ ูุญุฑุต ุนูู ุชูููุฉ ููุงุฑุงุช ุงูุชูููุฑ ุงููุงูุฏ ูุงูุฅุจุฏุงุนู ูุญู ุงููุดููุงุช ูู ุฎูุงู ุชูุธูููุง ูู ุฃูุดุทุฉ ุชุนููููุฉ ุชุนุงูููุฉุ ูุฑุฏูุฉุ ุฑูููุฉ.</p>
      <div class="field"><label style="color:#7e57c2;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #9575cd">๐ ูู ููุงู ุทุฑููุฉ ูุนููุฉ (ุงุณุชุฑุงุชูุฌูุฉ ุชุนููููุฉ ูุญุฏุฏุฉ) ุชููููู ูู ุฎูุงููุง ุงูุฏุฑุณุ ุฅุฐุง ูุฌุฏุช ุดุงุฑูููุง</label> <input id="studentStrategy" type="text" placeholder="ูุซุงู: ุงูุชุนูู ุจุงููุดุงุฑูุนุ ุงูุชุนูู ุงูุชุนุงูููุ ุงูุชุนูู ุงูุฐุงุชู..." style="background:#fff;border:2px solid #ce93d8;border-radius:12px;padding:14px;font-size:14px;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(206,147,216,0.08)">
      </div>
      <div class="field" style="margin-top:20px"><label style="color:#7e57c2;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #9575cd">๐ ุชู ุงุณุชุนุฑุงุถ ุงูุฎุทุฉ ุงูุนูุงุฌูุฉ ูุงูุฅุซุฑุงุฆูุฉ ุงูุชู ููุฐุชูุง ุงููุนููุฉ ูู ูุธูุฑุช ุงููุชุงุฆุฌุ ูู ููุงู ุทุฑููุฉ ุฃุฎุฑู ุชุฑุบุจูู ูู ุฅุถุงูุชูุง ุฅุฐุง ูุงูุช ูู ุฌูุงูุจ ุถุนู ูุงูุดุชูุง ูุนููุชู ูุนู ูุณุจูุงูุ</label> <select id="studentAdditionalStrategy" style="background:#fff;border:2px solid #ce93d8;border-radius:12px;padding:14px;font-size:14px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(206,147,216,0.08)"> <option value="">ุงุฎุชุงุฑู ุฅุฌุงุจุฉ...</option> <option value="ูุง">ูุงุ ูุง ููุฌุฏ ูุฏู ุทุฑููุฉ</option> <option value="ูุนู">ูุนู ููุฌุฏ</option> </select>
      </div>
      <div class="field hidden" id="studentAdditionalStrategyText" style="margin-top:16px"><label style="color:#7e57c2;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #9575cd">โ๏ธ ุงูุชุจู ุงูุทุฑููุฉ ุงูุฅุถุงููุฉ ุงูุชู ุชุฑุบุจูู ูููุง</label> <textarea id="studentAdditionalStrategyDetail" rows="3" placeholder="ุงูุชุจู ุงูุทุฑููุฉ ุฃู ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุชู ุชูุถููููุง..." style="background:#fff;border:2px solid #ce93d8;border-radius:12px;padding:14px;font-size:14px;resize:vertical;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(206,147,216,0.08)"></textarea>
      </div>
     </div>
     <div class="card-soft" style="margin-top:24px;background:linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);border:2px solid #80cbc4;border-radius:18px;padding:28px;box-shadow:0 4px 15px rgba(0,150,136,0.1)">
      <h3 style="color:#00695c;margin-bottom:20px;font-size:19px;display:flex;align-items:center;gap:12px;border-bottom:3px solid #4db6ac;padding-bottom:12px;font-weight:700"><span style="font-size:26px">๐</span> <span>ุงุณุชุจูุงู ุณุฑูุน</span></h3>
      <div class="field" style="margin-bottom:20px;"><label style="color:#004d40;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #26a69a">โ ุฃูุง ุฃููู ุฏุงุฆูุงู ุจุฅุฎุจุงุฑ ููู/ูุฉ ุฃูุฑู ุจุชุญุตููู ุงูุฏุฑุงุณู ูู ูุงุฏุฉ ุงูุชูููุฉ ุงูุฑูููุฉ</label> <select id="studentAwareness" style="background:#fff;border:2px solid #80cbc4;border-radius:12px;padding:14px;font-size:14px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(0,150,136,0.08)"> <option value="">ุงุฎุชุงุฑู ุฅุฌุงุจุฉ...</option> <option value="ูุนู">ูุนู</option> <option value="ูุง">ูุง</option> <option value="ุฃุญูุงูุงู">ุฃุญูุงูุงู</option> </select>
      </div>
      <div class="field"><label style="color:#004d40;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #26a69a">โญ ูุง ูุฏู ุฑุถุงู ุนู ุขููุฉ ุงููุชุงุจุนุฉ ูุฐูุ</label> <select id="studentSatisfaction" style="background:#fff;border:2px solid #80cbc4;border-radius:12px;padding:14px;font-size:14px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(0,150,136,0.08)"> <option value="">ุงุฎุชุงุฑู ุฅุฌุงุจุฉ...</option> <option value="ูุนู ุฌูุฏุฉ">ูุนู ุฌูุฏุฉ</option> <option value="ุฃูุถู ูุญุงุฏุซุฉ ุงููุนููุฉ ูู ุงููุฏุฑุณุฉ">ุฃูุถู ูุญุงุฏุซุฉ ุงููุนููุฉ ูู ุงููุฏุฑุณุฉ</option> </select>
      </div><button id="submitStudentFeedback" style="width:100%;padding:16px;background:linear-gradient(135deg, #7986cb 0%, #5c6bc0 100%);color:#fff;border:none;border-radius:14px;cursor:pointer;font-size:16px;font-weight:700;margin-top:22px;box-shadow:0 4px 15px rgba(121,134,203,0.35);transition:all 0.3s ease">๐ค ุฅุฑุณุงู ุงูุงุณุชุจูุงู</button>
     </div>
    </div>
   </section>
   <section id="parentPanel" class="card hidden">
    <div class="panel-head">
     <h2 class="section-title">ููุญุฉ ูููู ุงูุฃูุฑ</h2><button id="backToMenu3" style="padding:12px 20px;background:linear-gradient(135deg, #9fa8da 0%, #7986cb 100%);color:#ffffff;border:none;border-radius:12px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 12px rgba(121,134,203,0.3);transition:all 0.3s ease;">๐ ุนูุฏุฉ ูููุงุฆูุฉ</button>
    </div>
    <div id="parentReport" class="hidden">
     <div class="card-soft" style="background:linear-gradient(135deg, #f0f4f8 0%, #e8eef5 100%);padding:24px;border-radius:18px;margin-bottom:24px;border:2px solid #d4dce6;box-shadow:0 4px 12px rgba(0,0,0,0.05)">
      <div class="row wrap" style="gap:14px;justify-content:center">
       <div class="pill info" style="font-size:15px;background:#e3f2fd;color:#1565c0;border:2px solid #90caf9">
        ๐ง ุงูุทุงูุจุฉ: <strong id="pName" style="margin-right:8px"></strong>
       </div>
       <div class="pill info" style="font-size:15px;background:#e8f5e9;color:#2e7d32;border:2px solid #a5d6a7">
        ๐ ุงููุตู: <strong id="pClass" style="margin-right:8px"></strong>
       </div>
       <div class="pill success" style="font-size:15px;background:#fff3e0;color:#e65100;border:2px solid #ffcc80">
        ๐๏ธ ูุธุฑุฉ ุนุงูุฉ
       </div>
      </div>
     </div>
     <div class="split">
      <div class="card-soft" style="background:#fafbfc;border:2px solid #e1e8ed;box-shadow:0 2px 8px rgba(0,0,0,0.04)">
       <canvas id="parentChart" height="220"></canvas>
      </div>
      <div class="card-soft" style="background:#fafbfc;border:2px solid #e1e8ed;box-shadow:0 2px 8px rgba(0,0,0,0.04)">
       <h3 style="color:#37474f;font-size:17px;margin-bottom:16px;border-bottom:2px solid #b0bec5;padding-bottom:8px">๐ ููุฎุต ูุฑุฆู</h3>
       <div id="pSummary"></div>
       <div class="card-soft" style="margin-top:16px;background:#f0f9ff;border:2px solid #90caf9">
        <h3 style="color:#1565c0;font-size:15px;margin-bottom:10px;display:flex;align-items:center;gap:8px">๐ ุฎุทุฉ ุฑูุน ุงููุณุชูู</h3>
        <div id="pPlanBox" class="plan-box muted">
         ูุง ุชูุฌุฏ ุฎุทุฉ ูุณุฌูุฉ ุจุนุฏ.
        </div>
       </div><button class="whatsapp-btn" id="contactTeacher" style="width:100%;padding:14px;background:linear-gradient(90deg, #25D366, #128C7E);color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:14px;font-weight:700;margin-top:16px;box-shadow:0 4px 12px rgba(37,211,102,0.3);transition:all 0.3s ease">๐ฒ ุชูุงุตู ูุน ุงููุนููุฉ ุนู ูุณุชูู ุงูุทุงูุจุฉ</button> <button id="printParent" style="width:100%;padding:14px;background:linear-gradient(90deg, #5e92f3, #4a7fd6);color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:14px;font-weight:700;margin-top:12px;box-shadow:0 4px 12px rgba(94,146,243,0.3);transition:all 0.3s ease">๐จ๏ธ ุทุจุงุนุฉ/ุญูุธ PDF</button>
      </div>
     </div>
     <div class="card-soft" style="margin-top:24px;background:linear-gradient(135deg, #f5f5f7 0%, #e8eaf6 100%);border:2px solid #c5cae9;border-radius:18px;padding:28px;box-shadow:0 4px 15px rgba(121,134,203,0.1)">
      <h3 style="color:#5c6bc0;margin-bottom:20px;font-size:19px;display:flex;align-items:center;gap:12px;border-bottom:3px solid #9fa8da;padding-bottom:12px;font-weight:700"><span style="font-size:26px">๐</span> <span>ุจุตูุชู ููู/ูุฉ ุฃูุฑ ุงูุทุงูุจุฉ ุดุงุฑู/ูู ูุนููุชูุง</span></h3>
      <div class="field" style="margin-bottom:20px;"><label style="color:#3f51b5;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #7986cb">โจ ุตูุฉ ุชุชุญูู ุจูุง ุงูุทุงูุจุฉ</label> <input id="parentTrait" type="text" placeholder="ูุซุงู: ุฎุฌููุฉุ ุฌุฑูุฆุฉุ ูุชุณุฑุนุฉุ ุงููุนุงููุฉ..." style="background:#fff;border:2px solid #c5cae9;border-radius:12px;padding:14px;font-size:14px;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(121,134,203,0.08)">
      </div>
      <div class="field"><label style="color:#3f51b5;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #7986cb">๐ฏ ููุงุฑุฉ ุชููุฑุฏ ูุชุชููุฒ ุจูุง</label> <input id="parentSkill" type="text" placeholder="ูุซุงู: ุงูุฑุณูุ ุงูุชุตูููุ ุญู ุงููุดููุงุช..." style="background:#fff;border:2px solid #c5cae9;border-radius:12px;padding:14px;font-size:14px;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(121,134,203,0.08)">
      </div>
     </div>
     <div class="card-soft" style="margin-top:24px;background:linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);border:2px solid #ce93d8;border-radius:18px;padding:28px;box-shadow:0 4px 15px rgba(156,39,176,0.1)">
      <h3 style="color:#7e57c2;margin-bottom:20px;font-size:19px;display:flex;align-items:center;gap:12px;border-bottom:3px solid #b39ddb;padding-bottom:12px;font-weight:700"><span style="font-size:26px">๐ก</span> <span>ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุนูู ุงูููุถูุฉ</span></h3>
      <p style="color:#5e35b1;font-size:14px;line-height:2;margin-bottom:20px;background:#fff;padding:18px;border-radius:12px;border-right:4px solid #9575cd;box-shadow:0 2px 8px rgba(149,117,205,0.08)">ูู ูุงุฏุฉ ุงูุชูููุฉ ุงูุฑูููุฉ ูุญุฑุต ุนูู ุชูููุฉ ููุงุฑุงุช ุงูุชูููุฑ ุงููุงูุฏ ูุงูุฅุจุฏุงุนู ูุญู ุงููุดููุงุช ูู ุฎูุงู ุชูุธูููุง ูู ุฃูุดุทุฉ ุชุนููููุฉ ุชุนุงูููุฉุ ูุฑุฏูุฉุ ุฑูููุฉ.</p>
      <div class="field"><label style="color:#7e57c2;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #9575cd">๐ ูู ููุงู ุทุฑููุฉ ูุนููุฉ (ุงุณุชุฑุงุชูุฌูุฉ ุชุนููููุฉ ูุญุฏุฏุฉ) ุชููู ุงูุทุงูุจุฉ ูู ุฎูุงููุง ุงูุฏุฑุณุ ุฅุฐุง ูุฌุฏุช ุดุงุฑูููุง</label> <input id="parentStrategy" type="text" placeholder="ูุซุงู: ุงูุชุนูู ุจุงููุดุงุฑูุนุ ุงูุชุนูู ุงูุชุนุงูููุ ุงูุชุนูู ุงูุฐุงุชู..." style="background:#fff;border:2px solid #ce93d8;border-radius:12px;padding:14px;font-size:14px;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(206,147,216,0.08)">
      </div>
      <div class="field" style="margin-top:20px"><label style="color:#7e57c2;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #9575cd">๐ ุชู ุงุณุชุนุฑุงุถ ุงูุฎุทุฉ ุงูุนูุงุฌูุฉ ูุงูุฅุซุฑุงุฆูุฉ ุงูุชู ููุฐุชูุง ุงููุนููุฉ ููุทุงูุจุฉ ูุธูุฑุช ุงููุชุงุฆุฌุ ูู ููุงู ุทุฑููุฉ ุฃุฎุฑู ุชุฑุบุจูู ูู ุฅุถุงูุชูุง ุฅุฐุง ูุงูุช ููุทุงูุจุฉ ุฌูุงูุจ ุถุนู ูุงูุดุชูุง ุงููุนููุฉ ูุนูู ูุณุจูุงูุ</label> <select id="parentAdditionalStrategy" style="background:#fff;border:2px solid #ce93d8;border-radius:12px;padding:14px;font-size:14px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(206,147,216,0.08)"> <option value="">ุงุฎุชุฑ ุฅุฌุงุจุฉ...</option> <option value="ูุง">ูุงุ ูุง ููุฌุฏ ูุฏููุง ุทุฑููุฉ</option> <option value="ูุนู">ูุนู ููุฌุฏ</option> </select>
      </div>
      <div class="field hidden" id="parentAdditionalStrategyText" style="margin-top:16px"><label style="color:#7e57c2;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #9575cd">โ๏ธ ุงูุชุจ ุงูุทุฑููุฉ ุงูุฅุถุงููุฉ ุงูุชู ุชุฑุบุจูู ูููุง</label> <textarea id="parentAdditionalStrategyDetail" rows="3" placeholder="ุงูุชุจ ุงูุทุฑููุฉ ุฃู ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุชู ุชูุถููููุง ููุทุงูุจุฉ..." style="background:#fff;border:2px solid #ce93d8;border-radius:12px;padding:14px;font-size:14px;resize:vertical;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(206,147,216,0.08)"></textarea>
      </div>
     </div>
     <div class="card-soft" style="margin-top:24px;background:linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);border:2px solid #80cbc4;border-radius:18px;padding:28px;box-shadow:0 4px 15px rgba(0,150,136,0.1)">
      <h3 style="color:#00695c;margin-bottom:20px;font-size:19px;display:flex;align-items:center;gap:12px;border-bottom:3px solid #4db6ac;padding-bottom:12px;font-weight:700"><span style="font-size:26px">๐</span> <span>ุงุณุชุจูุงู ุณุฑูุน</span></h3>
      <div class="field" style="margin-bottom:20px;"><label style="color:#004d40;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #26a69a">โ ูู ุงูุทุงูุจุฉ ุชูุทูุนูู ุฏุงุฆูุงู ุจุชุญุตูููุง ุงูุฏุฑุงุณู ูู ูุงุฏุฉ ุงูุชูููุฉ ุงูุฑูููุฉุ</label> <select id="parentAwareness" style="background:#fff;border:2px solid #80cbc4;border-radius:12px;padding:14px;font-size:14px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(0,150,136,0.08)"> <option value="">ุงุฎุชุฑ ุฅุฌุงุจุฉ...</option> <option value="ูุนู">ูุนู</option> <option value="ูุง">ูุง</option> <option value="ุฃุญูุงูุงู">ุฃุญูุงูุงู</option> </select>
      </div>
      <div class="field"><label style="color:#004d40;font-weight:700;font-size:15px;margin-bottom:10px;display:block;background:#fff;padding:10px 14px;border-radius:10px;border-right:4px solid #26a69a">โญ ูุง ูุฏู ุฑุถุงูู ุนู ุขููุฉ ุงููุชุงุจุนุฉ ูุฐูุ</label> <select id="parentSatisfaction" style="background:#fff;border:2px solid #80cbc4;border-radius:12px;padding:14px;font-size:14px;cursor:pointer;transition:all 0.3s ease;box-shadow:0 2px 8px rgba(0,150,136,0.08)"> <option value="">ุงุฎุชุฑ ุฅุฌุงุจุฉ...</option> <option value="ุฌูุฏุฉ">ุฌูุฏุฉ</option> <option value="ุฃูุถู ุงูุญุถูุฑ ูููุงูุดุฉ ุงูุฃูุฑ ูุน ุงููุนููุฉ">ุฃูุถู ุงูุญุถูุฑ ูููุงูุดุฉ ุงูุฃูุฑ ูุน ุงููุนููุฉ</option> </select>
      </div><button id="submitParentFeedback" style="width:100%;padding:16px;background:linear-gradient(135deg, #7986cb 0%, #5c6bc0 100%);color:#fff;border:none;border-radius:14px;cursor:pointer;font-size:16px;font-weight:700;margin-top:22px;box-shadow:0 4px 15px rgba(121,134,203,0.35);transition:all 0.3s ease">๐ค ุฅุฑุณุงู ุงูุงุณุชุจูุงู</button>
     </div>
    </div>
   </section>
  </main><!-- ูุงูุฐุฉ ุชุญุฑูุฑ ุฎุทุฉ ุฑูุน ุงููุณุชูู -->
  <div id="planModal" class="modal hidden" aria-hidden="true">
   <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="planTitle">
    <div class="modal__head">
     <h3 id="planTitle">ุฎุทุฉ ุฑูุน ุงููุณุชูู ุงูุชุญุตููู</h3><button class="ghost" id="closePlan" style="padding:8px 16px;border-radius:8px">ุฅุบูุงู โ</button>
    </div>
    <div class="modal__body">
     <div class="grid"><label style="color:#5c6bc0;font-weight:600">ุงููุดููุฉ ุงูุฃูุงุฏูููุฉ <textarea id="planProblem" rows="2" placeholder="ูุซุงู: ุถุนู ูู ุญู ุงููุณุงุฆู ุงูุชุทุจูููุฉ" style="padding:10px;border:2px solid #c5cae9;border-radius:10px;font-size:14px;resize:vertical"></textarea> </label> <label style="color:#5c6bc0;font-weight:600">ุงูุฅุฌุฑุงุก ุงูููุชุฑุญ <textarea id="planAction" rows="2" placeholder="ูุซุงู: ุชูุงุฑูู ุฃุณุจูุนูุฉ + ุฏุฑุณ ุชูููุฉ ูุฑุฏู" style="padding:10px;border:2px solid #c5cae9;border-radius:10px;font-size:14px;resize:vertical"></textarea> </label> <label style="color:#5c6bc0;font-weight:600">ูุฏุฉ ุงูุชูููุฐ <input id="planDuration" type="text" placeholder="ุฃุณุจูุนุงู / ุดูุฑ" style="padding:10px;border:2px solid #c5cae9;border-radius:10px;font-size:14px"> </label> <label style="color:#5c6bc0;font-weight:600">ุงููุชูุฌุฉ ุงููุชููุนุฉ <input id="planExpected" type="text" placeholder="ุฑูุน ูุชูุณุท ุงูุงุฎุชุจุงุฑุงุช ุฅูู 80%" style="padding:10px;border:2px solid #c5cae9;border-radius:10px;font-size:14px"> </label> <label style="color:#5c6bc0;font-weight:600">ูุชุงุจุนุฉ ุจุนุฏ ุฃุณุจูุนูู <textarea id="planFollowup" rows="2" placeholder="ูุชุงุฆุฌ ุงููุชุงุจุนุฉ ูุงูููุงุญุธุงุช" style="padding:10px;border:2px solid #c5cae9;border-radius:10px;font-size:14px;resize:vertical"></textarea> </label> <label style="color:#5c6bc0;font-weight:600">ุงูุญุงูุฉ <select id="planStatus" style="padding:10px;border:2px solid #c5cae9;border-radius:10px;font-size:14px;cursor:pointer"> <option value="good">ุชุญุณูู ูุงุถุญ โ</option> <option value="partial">ุชุญุณูู ุฌุฒุฆู โ๏ธ</option> <option value="need">ุจุญุงุฌุฉ ุฏุนู ๐ด</option> </select> </label> <label style="color:#5c6bc0;font-weight:600">ุชุฃุซูุฑ ุงูุฎุทุฉ ุนูู ุงููุฌููุน (%) <input id="planImpact" type="number" min="0" max="10" step="1" placeholder="0โ10%" style="padding:10px;border:2px solid #c5cae9;border-radius:10px;font-size:14px"> </label> <label style="color:#5c6bc0;font-weight:600">ููุนุฏ ุงููุฑุงุฌุนุฉ ุงููุงุฏูุฉ <input id="planNextReview" type="date" style="padding:10px;border:2px solid #c5cae9;border-radius:10px;font-size:14px"> </label>
     </div>
    </div>
    <div class="modal__foot"><button id="savePlan" style="padding:12px 20px;background:linear-gradient(135deg, #7986cb 0%, #5c6bc0 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 10px rgba(121,134,203,0.3)">๐พ ุญูุธ ุงูุฎุทุฉ</button> <button class="ghost" id="exportPlans" style="padding:12px 20px;border-radius:10px">๐ค ุชุตุฏูุฑ ุฎุทุท (CSV)</button>
    </div>
   </div>
  </div>
  <script>
    /* ================= ุฅุนุฏุงุฏ ุนุงู ================= */
    const STORAGE_KEY = "gradingData.v1";
    const TEACHER_PIN = "1234";

    const KEYS = ["exams","practical","homework","discussion","attendance","collaboration"];
    const HEADERS = {
      exams:"ุงูุงุฎุชุจุงุฑุงุช ุงูุชุญุฑูุฑูุฉ",
      practical:"ุงูุชูููู ุงูุนููู",
      homework:"ุงููุงุฌุจุงุช ุงูุฑูููุฉ",
      discussion:"ุงูููุงูุดุงุช ุงูุตููุฉ",
      attendance:"ุงูุญุถูุฑ ( ุนุฏุฏ ุฃูุงู ุงูุบูุงุจ )",
      collaboration:"ุงูุชุนุงูู ูุน ุงููุฌููุนุฉ"
    };
    
    const STRENGTH_OPTIONS = [
      "ุงูุชุนุงูู",
      "ุนุฏู ุงูุบูุงุจ",
      "ุงูุงูุชุฒุงู ุจุงูุญุถูุฑ ูู ุงูููุช ุงููุญุฏุฏ",
      "ููููุฉ ูููุฌููุนุฉ",
      "ูุงุฆุฏุฉ ูุชููุฒุฉ"
    ];
    
    const WEAKNESS_OPTIONS = [
      "ูุง ููุฌุฏ",
      "ูุซุฑุฉ ุงูุบูุงุจ",
      "ุงูุชุฃุฎุฑ ุนู ุงูุญุตุฉ",
      "ุนุฏู ุงูุชูุงุนู ูุน ุงููุฌููุนุฉ"
    ];

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { classes:[], studentsByClass:{} };
      try{ return JSON.parse(raw); }catch{ return { classes:[], studentsByClass:{} }; }
    }
    function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
    function ensureClass(d, cls){
      if(!d.classes.includes(cls)) d.classes.push(cls);
      if(!d.studentsByClass[cls]) d.studentsByClass[cls] = [];
    }
    
    function ensureStudentFields(student){
      if(!student.nationalId) student.nationalId = "";
      if(!student.excellencePoints) student.excellencePoints = 0;
      if(!student.strengths) student.strengths = [];
      if(!student.weaknesses) student.weaknesses = [];
      if(!student.plan) student.plan = null;
      return student;
    }
    
    function ensurePlanObject(st){
      if(!st.plan){
        st.plan = { problem:"", action:"", duration:"", expected:"", followup:"", status:"partial", impact:0, nextReview:"" };
      }else{
        // ุถูุงู ุงูุญููู ุงูุฌุฏูุฏุฉ ููู ูุฏููู ุฎุทุท ูุฏููุฉ
        st.plan.impact ??= 0;
        st.plan.nextReview ??= "";
      }
      return st.plan;
    }
    function normalizeName(n){
      return (n||"").trim().replace(/\s+/g," ").toLowerCase();
    }
    function totalOf(scores){ 
      // ุงูุญุถูุฑ ูุง ูุฏุฎู ูู ุงููุฌููุนุ ูุงูุชุนุงูู ูุตู
      return ["exams","practical","homework","discussion"].reduce((s,k)=> s + (Number(scores[k])||0), 0); 
    }
    function adjustedTotal(scores, plan){
      // ุงููุฌููุน ุงูุฃุตูู
      const base = totalOf(scores);
      const imp = plan ? Number(plan.impact||0) : 0; // 0โ10 (%)
      const bonus = base * (imp/100);
      return Math.round(Math.min(100, base + bonus)); // ุณูู 100
    }
    function adjustedStatus(adjTotal){
      if(adjTotal>=90) return "ููุชุงุฒุฉ";
      if(adjTotal>=80) return "ุฌูุฏุฉ ุฌุฏูุง";
      if(adjTotal>=70) return "ุฌูุฏุฉ";
      if(adjTotal>=60) return "ููุจููุฉ";
      return "ุจุญุงุฌุฉ ุฏุนู";
    }
    function avgOfClass(list){ if(!list.length) return 0; return (list.reduce((s,x)=> s+totalOf(x.scores),0)/list.length).toFixed(1); }
    function attendanceRate(list){ if(!list.length) return 0; return (list.reduce((s,x)=> s+(+x.scores.attendance||0),0)/list.length).toFixed(1); }
    function percentage(val, max=100){ val=+val||0; return Math.max(0, Math.min(100,(val/max)*100)); }

    function initIfEmpty(){
      if(state.classes.length===0){
        state.classes=["ุซุงูุซ 1", "ุซุงูุซ 2", "ุซุงูุซ 3", "ุซุงูุซ 4", "ุซุงูู ุฅุฏุงุฑุฉ"];
        state.classes.forEach(cls => {
          state.studentsByClass[cls] = [];
        });
        saveData(state);
      }
    }

    function findStudentByNameOrId(cls, input){
      const list = state.studentsByClass[cls]||[];
      const normalizedInput = input.trim();
      
      // ุฅุฐุง ูุงู ุงูุฅุฏุฎุงู ุฑูููุ ูุจุญุซ ุจุงูุณุฌู ุงููุฏูู
      if(/^\d+$/.test(normalizedInput)){
        return list.find(s=> (s.nationalId||"").trim() === normalizedInput);
      }
      
      // ุฅุฐุง ูุงู ูุตูุ ูุจุญุซ ุจุงูุงุณู ุงูุซูุงุฆู
      const searchName = normalizeName(normalizedInput);
      return list.find(s=> {
        const fullName = normalizeName(s.name);
        const twoNames = fullName.split(" ").slice(0, 2).join(" ");
        return twoNames === searchName;
      });
    }

    function renderClassSelectors(selected){
      // ุงููุฆู ููุงุฆู ุงููุตูู
      ["#classSelect","#studentClassSelect","#parentClassSelect"].forEach(sel=>{
        const el = $(sel); if(!el) return;
        el.innerHTML="";
        state.classes.forEach(c=>{
          const opt = document.createElement("option");
          opt.value=c; opt.textContent=c;
          el.appendChild(opt);
        });
        if(selected && state.classes.includes(selected)) el.value=selected;
      });
    }

    function backToMenu(){
      ["teacherPanel","studentPanel","parentPanel"].forEach(id=> $("#"+id).classList.add("hidden"));
      $("#loginMenu").classList.remove("hidden");
      // ุฅุธูุงุฑ ููุญุงุช ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ
      $("#activeFamiliesSection").classList.remove("hidden");
      $("#excellentStudentsSection").classList.remove("hidden");
      // ุทูู ููุงุฐุฌ ุงูุฏุฎูู
      $$(".login-card").forEach(c=> c.classList.add("hidden"));
    }

    function showToast(msg){
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=> t.remove(), 3000);
    }

    function showThankYouMessage(type, studentName, callback){
      const overlay = document.createElement("div");
      overlay.className = "modal-overlay";
      
      const title = type === "student" ? "ุดูุฑุงู ูู ุนุฒูุฒุชู ุงูุทุงูุจุฉ" : "ุดูุฑุงู ููู ุฃูููุงุก ุงูุฃููุฑ ุงููุฑุงู";
      const message = type === "student" ? 
        `ุนุฒูุฒุชู ุงูุทุงูุจุฉ ${studentName}` : 
        `ุฃูููุงุก ุฃููุฑ ุงูุทุงูุจุฉ ${studentName} ุงููุฑุงู`;
      
      overlay.innerHTML = `
        <div class="modal-content" style="max-width:600px;text-align:center;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border:3px solid #0ea5e9;box-shadow:0 20px 60px rgba(14,165,233,0.3)">
          <div style="background:linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);margin:-24px -24px 24px -24px;padding:24px;border-radius:16px 16px 0 0">
            <div style="font-size:64px;margin-bottom:16px;animation:bounce 2s infinite">๐</div>
            <h3 style="color:#ffffff;margin:0;font-size:24px;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,0.2)">${title}</h3>
          </div>
          
          <div style="padding:0 20px 20px">
            <div style="background:#ffffff;border-radius:16px;padding:24px;margin-bottom:20px;border:2px solid #0ea5e9;box-shadow:0 4px 15px rgba(14,165,233,0.1)">
              <p style="color:#0284c7;font-size:18px;font-weight:700;margin-bottom:16px;line-height:1.6">${message}</p>
              <p style="color:#374151;font-size:16px;line-height:1.8;margin-bottom:16px">
                ุชู ุฅุฑุณุงู ุฑุณุงูุชูู ูููุนููุฉ ุจูุฌุงุญ โ<br>
                ููุฏุฑ ููู ุชูุงุตููู ูุนูุง ูุณูุชู ุงูุฑุฏ ุนูููู ุจุฃูุฑุจ ููุช ุฅู ุดุงุก ุงููู
              </p>
              <div style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border:2px solid #f59e0b;border-radius:12px;padding:16px;margin-top:16px">
                <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:8px">
                  <span style="font-size:24px">๐ฑ</span>
                  <span style="color:#92400e;font-weight:700;font-size:16px">ุชูุจูู ููู</span>
                </div>
                <p style="color:#92400e;font-size:14px;font-weight:600;margin:0;line-height:1.6">
                  ูุฑุฌู ุงูุชูุงุตู ุนู ุทุฑูู ุงููุงุชุณุงุจ ููุท<br>
                  ูููุณ ุนู ุทุฑูู ุงูุงุชุตุงู ุงููุจุงุดุฑ
                </p>
              </div>
            </div>
            
            <button onclick="this.closest('.modal-overlay').remove()" style="width:100%;padding:16px;background:linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);color:#ffffff;border:none;border-radius:12px;cursor:pointer;font-size:16px;font-weight:700;box-shadow:0 4px 15px rgba(14,165,233,0.3);transition:all 0.3s ease">
              ุดูุฑุงู ููู ๐
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      overlay.onclick = (e)=>{ if(e.target===overlay) overlay.remove(); };
      
      // ูุชุญ ุงููุงุชุณุงุจ ุจุนุฏ 500 ูููู ุซุงููุฉ ููุท (ุจุฏูุงู ูู ุงูุชุฃุฎูุฑ ุงูุทููู)
      if(callback) {
        setTimeout(callback, 500);
      }
      
      // ุฅุถุงูุฉ ุงูุฃููููุดู
      if(!document.getElementById('bounce-animation')){
        const style = document.createElement('style');
        style.id = 'bounce-animation';
        style.textContent = `
          @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
          }
        `;
        document.head.appendChild(style);
      }
    }

    function showDeleteModal(onConfirm){
      const overlay = document.createElement("div");
      overlay.className = "modal-overlay";
      overlay.innerHTML = `
        <div class="modal-content">
          <h3>ุชุฃููุฏ ุงูุญุฐู</h3>
          <p>ูู ุฃูุชู ูุชุฃูุฏุฉ ูู ุญุฐู ูุฐู ุงูุทุงูุจุฉุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.</p>
          <div class="modal-buttons">
            <button class="cancel">ุฅูุบุงุก</button>
            <button class="confirm">ุญุฐู</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector(".cancel").onclick = ()=> overlay.remove();
      overlay.querySelector(".confirm").onclick = ()=>{ onConfirm(); overlay.remove(); };
      overlay.onclick = (e)=>{ if(e.target===overlay) overlay.remove(); };
    }
    
    function showMultiSelectModal(title, options, selected, onConfirm){
      const overlay = document.createElement("div");
      overlay.className = "modal-overlay";
      
      const checkboxesHTML = options.map((opt, idx)=>{
        const checked = selected.includes(opt) ? "checked" : "";
        return `
          <label style="display:flex;align-items:center;gap:10px;padding:12px;background:#f5f5f7;border-radius:10px;cursor:pointer;margin-bottom:8px;border:2px solid ${checked?'#7986cb':'#e0e0e0'};transition:all 0.3s ease">
            <input type="checkbox" value="${opt}" ${checked} style="width:20px;height:20px;cursor:pointer;accent-color:#7986cb">
            <span style="flex:1;font-size:14px;color:#2d3748;font-weight:600">${opt}</span>
          </label>
        `;
      }).join("");
      
      overlay.innerHTML = `
        <div class="modal-content" style="max-width:600px">
          <h3 style="color:#5c6bc0;margin-bottom:20px;font-size:20px;border-bottom:3px solid #9fa8da;padding-bottom:12px">${title}</h3>
          <div class="checkbox-container" style="max-height:400px;overflow-y:auto;padding:10px">
            ${checkboxesHTML}
          </div>
          <div class="modal-buttons" style="margin-top:20px">
            <button class="cancel" style="padding:12px 24px;background:#fff;color:#2d3748;border:2px solid #e0e0e0;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700">ุฅูุบุงุก</button>
            <button class="confirm" style="padding:12px 24px;background:linear-gradient(135deg, #7986cb 0%, #5c6bc0 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;box-shadow:0 3px 10px rgba(121,134,203,0.3)">ุญูุธ</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // ุชุญุฏูุซ ููู ุงูุญุฏูุฏ ุนูุฏ ุงูุชุบููุฑ
      overlay.querySelectorAll("input[type='checkbox']").forEach(cb=>{
        cb.addEventListener("change", (e)=>{
          const label = e.target.closest("label");
          if(e.target.checked){
            label.style.borderColor = "#7986cb";
            label.style.background = "#e8eaf6";
          } else {
            label.style.borderColor = "#e0e0e0";
            label.style.background = "#f5f5f7";
          }
        });
      });
      
      overlay.querySelector(".cancel").onclick = ()=> overlay.remove();
      overlay.querySelector(".confirm").onclick = ()=>{
        const selectedValues = Array.from(overlay.querySelectorAll("input[type='checkbox']:checked")).map(cb=>cb.value);
        onConfirm(selectedValues);
        overlay.remove();
      };
      overlay.onclick = (e)=>{ if(e.target===overlay) overlay.remove(); };
    }

    /* ================= ุญุงูุฉ ุงูุชุทุจูู ================= */
    let state = loadData();
    const chartRefs = {};
    let currentPlanStudent = null; // ุงูุทุงูุจุฉ ุงูุชู ูุชู ุชุญุฑูุฑ ุฎุทุชูุง
    initIfEmpty();
    renderClassSelectors();

    /* ================= ูุธุงู ุชุชุจุน ุงูุชูุงุนู ================= */
    const INTERACTION_KEY = "familyInteractions.v1";
    
    function loadInteractions(){
      const raw = localStorage.getItem(INTERACTION_KEY);
      if(!raw) return { families: {}, stats: { totalLogins: 0, todayLogins: 0 } };
      try{ return JSON.parse(raw); }catch{ return { families: {}, stats: { totalLogins: 0, todayLogins: 0 } }; }
    }
    
    function saveInteractions(data){ localStorage.setItem(INTERACTION_KEY, JSON.stringify(data)); }
    
    function recordFamilyInteraction(studentName, className, type = 'login'){
      const interactions = loadInteractions();
      const familyKey = `${normalizeName(studentName)}_${className}`;
      const today = new Date().toDateString();
      
      if(!interactions.families[familyKey]){
        interactions.families[familyKey] = {
          studentName,
          className,
          totalLogins: 0,
          lastLogin: null,
          loginDates: [],
          avatar: generateFamilyAvatar(studentName)
        };
      }
      
      const family = interactions.families[familyKey];
      family.totalLogins++;
      family.lastLogin = new Date().toISOString();
      
      // ุชุณุฌูู ุชุงุฑูุฎ ุงูููู ุฅุฐุง ูู ููู ูุณุฌูุงู
      if(!family.loginDates.includes(today)){
        family.loginDates.push(today);
      }
      
      // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ
      interactions.stats.totalLogins++;
      
      // ุญุณุงุจ ุฏุฎูู ุงูููู
      interactions.stats.todayLogins = Object.values(interactions.families)
        .filter(f => f.loginDates.includes(today)).length;
      
      saveInteractions(interactions);
      renderFamilyInteractions();
    }
    
    function generateFamilyAvatar(studentName){
      // ูุฌููุนุฉ ูู ุงูุฑููุฒ ุงูุชุนุจูุฑูุฉ ููุฃุณุฑ
      const avatars = [
        "๐จโ๐ฉโ๐ง", "๐ฉโ๐ฉโ๐ง", "๐จโ๐จโ๐ง", "๐จโ๐ฉโ๐งโ๐ฆ", "๐ฉโ๐ฉโ๐งโ๐ฆ", "๐จโ๐จโ๐งโ๐ฆ",
        "๐ช", "๐", "๐", "๐", "๐ธ", "๐บ", "๐ป", "๐ท", "๐น", "๐",
        "๐", "๐", "โจ", "โญ", "๐", "โ๏ธ", "๐", "๐ฆ", "๐ผ", "๐"
      ];
      
      // ุงุณุชุฎุฏุงู hash ุจุณูุท ูู ุงุณู ุงูุทุงูุจุฉ ูุงุฎุชูุงุฑ ุฑูุฒ ุซุงุจุช
      let hash = 0;
      for(let i = 0; i < studentName.length; i++){
        hash = ((hash << 5) - hash + studentName.charCodeAt(i)) & 0xffffffff;
      }
      return avatars[Math.abs(hash) % avatars.length];
    }
    
    function renderFamilyInteractions(){
      const interactions = loadInteractions();
      const container = $("#activeFamilies");
      const families = Object.values(interactions.families);
      
      // ุชุฑุชูุจ ุงูุฃุณุฑ ุญุณุจ ุนุฏุฏ ูุฑุงุช ุงูุฏุฎูู (ุงูุฃูุซุฑ ุชูุงุนูุงู ุฃููุงู)
      families.sort((a, b) => b.totalLogins - a.totalLogins);
      
      // ุนุฑุถ ุฃูุถู 12 ุฃุณุฑุฉ ููุท
      const topFamilies = families.slice(0, 12);
      
      if(topFamilies.length === 0){
        container.innerHTML = `
          <div style="text-align:center;color:#718096;font-size:14px;padding:40px 20px;background:#f5f5f7;border-radius:16px;border:2px dashed #d9e2ec;width:100%">
            <span style="font-size:48px;display:block;margin-bottom:12px;opacity:0.6">๐ฅ</span>
            <p style="margin:0;font-weight:600">ูุง ุชูุฌุฏ ุจูุงูุงุช ุชูุงุนู ุจุนุฏ</p>
            <p style="margin:4px 0 0;font-size:12px;opacity:0.8">ุณุชุธูุฑ ุงูุฃุณุฑ ุงููุชูุงุนูุฉ ููุง ุนูุฏ ุฏุฎูููุง ูููุธุงู</p>
          </div>
        `;
      } else {
        container.innerHTML = topFamilies.map((family, index) => {
          const isTopThree = index < 3;
          const lastLoginDate = family.lastLogin ? new Date(family.lastLogin) : null;
          const daysSinceLogin = lastLoginDate ? Math.floor((new Date() - lastLoginDate) / (1000 * 60 * 60 * 24)) : null;
          
          let activityStatus = "ูุดุท";
          let statusColor = "#4caf50";
          if(daysSinceLogin > 7){
            activityStatus = "ุบูุฑ ูุดุท";
            statusColor = "#ff9800";
          } else if(daysSinceLogin > 3){
            activityStatus = "ูุชูุณุท ุงููุดุงุท";
            statusColor = "#2196f3";
          }
          
          const rankBadge = isTopThree ? 
            `<div style="position:absolute;top:-8px;right:-8px;background:${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : '#cd7f32'};color:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,0.3)">${index + 1}</div>` : '';
          
          // ุนุฑุถ ุงุณู ุงูุทุงูุจุฉ (ุฃูู ูููุชูู ููุท ููุฎุตูุตูุฉ)
          const displayName = family.studentName.split(' ').slice(0, 2).join(' ');
          
          return `
            <div style="position:relative;display:flex;flex-direction:column;align-items:center;padding:24px;background:${isTopThree ? 'linear-gradient(135deg, #fef3c7 0%, #fbbf24 20%, #f59e0b 100%)' : 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)'};border-radius:20px;border:${isTopThree ? '4px solid #d97706' : '3px solid #e2e8f0'};box-shadow:0 ${isTopThree ? '12' : '8'}px ${isTopThree ? '32' : '24'}px rgba(${isTopThree ? '217,119,6' : '148,163,184'},0.${isTopThree ? '4' : '15'});transition:all 0.4s ease;cursor:pointer;min-width:180px;max-width:200px;overflow:hidden" onmouseover="this.style.transform='translateY(-8px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
              
              ${isTopThree ? `<div style="position:absolute;top:-20px;right:-20px;width:80px;height:80px;background:radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);border-radius:50%;animation:float 4s ease-in-out infinite"></div>` : ''}
              
              ${rankBadge}
              
              <div style="position:relative;margin-bottom:16px">
                <div style="font-size:56px;filter:drop-shadow(0 4px 12px rgba(0,0,0,0.2));animation:${isTopThree ? 'celebrate 3s infinite' : 'none'}">${family.avatar}</div>
                ${isTopThree ? `<div style="position:absolute;top:-8px;right:-8px;font-size:24px;animation:sparkle 2s infinite">โจ</div>` : ''}
              </div>
              
              <div style="text-align:center;width:100%;position:relative;z-index:2">
                <div style="font-size:16px;font-weight:800;color:${isTopThree ? '#92400e' : '#1e293b'};margin-bottom:6px;line-height:1.3;text-shadow:${isTopThree ? '1px 1px 2px rgba(146,64,14,0.3)' : 'none'}">ุฃุณุฑุฉ ${displayName}</div>
                
                <div style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:${isTopThree ? 'rgba(255,255,255,0.9)' : 'rgba(99,102,241,0.1)'};border-radius:12px;border:2px solid ${isTopThree ? '#f59e0b' : '#6366f1'};margin-bottom:12px">
                  <span style="font-size:12px;color:${isTopThree ? '#92400e' : '#4338ca'};font-weight:700">${family.className}</span>
                </div>
                
                <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:12px;padding:12px;background:${isTopThree ? 'rgba(255,255,255,0.95)' : 'rgba(248,250,252,0.8)'};border-radius:16px;border:2px solid ${isTopThree ? '#f59e0b' : '#e2e8f0'}">
                  <div style="text-align:center">
                    <div style="font-size:24px;font-weight:800;color:${isTopThree ? '#d97706' : '#7c3aed'};line-height:1">${family.totalLogins}</div>
                    <div style="font-size:10px;color:${isTopThree ? '#92400e' : '#64748b'};font-weight:600">ูุฑุฉ ุฏุฎูู</div>
                  </div>
                  <div style="font-size:20px;opacity:0.7">${isTopThree ? '๐' : '๐'}</div>
                </div>
                
                <div style="display:inline-flex;align-items:center;gap:6px;font-size:11px;color:${statusColor};font-weight:700;padding:6px 12px;background:rgba(${statusColor === '#4caf50' ? '76,175,80' : statusColor === '#2196f3' ? '33,150,243' : '255,152,0'},0.15);border-radius:16px;border:2px solid rgba(${statusColor === '#4caf50' ? '76,175,80' : statusColor === '#2196f3' ? '33,150,243' : '255,152,0'},0.4)">
                  <span style="font-size:14px">${statusColor === '#4caf50' ? '๐ข' : statusColor === '#2196f3' ? '๐ต' : '๐ก'}</span>
                  <span>${activityStatus}</span>
                </div>
              </div>
              
              ${isTopThree ? `
              <div style="position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);display:flex;gap:4px">
                <div style="width:8px;height:8px;background:#f59e0b;border-radius:50%;animation:bounce 1s infinite"></div>
                <div style="width:8px;height:8px;background:#f59e0b;border-radius:50%;animation:bounce 1s infinite 0.2s"></div>
                <div style="width:8px;height:8px;background:#f59e0b;border-radius:50%;animation:bounce 1s infinite 0.4s"></div>
              </div>` : ''}
            </div>
            <style>
              @keyframes celebrate {
                0%, 100% { transform: scale(1) rotate(0deg); }
                25% { transform: scale(1.05) rotate(-2deg); }
                75% { transform: scale(1.05) rotate(2deg); }
              }
              @keyframes sparkle {
                0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
                50% { transform: scale(1.3) rotate(180deg); opacity: 0.7; }
              }
              @keyframes float {
                0%, 100% { transform: translateY(0px) rotate(0deg); }
                50% { transform: translateY(-15px) rotate(180deg); }
              }
              @keyframes bounce {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-4px); }
              }
            </style>
          `;
        }).join("");
      }
      
      // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
      $("#totalLogins").textContent = interactions.stats.totalLogins;
      $("#activeFamiliesCount").textContent = families.length;
      $("#todayLogins").textContent = interactions.stats.todayLogins;
    }
    
    // ุนุฑุถ ุงูุชูุงุนูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    renderFamilyInteractions();

    /* ================= ูุธุงู ุงูุทุงูุจุงุช ุงููุชููุฒุงุช ================= */
    function calculateExcellenceScore(student) {
      ensureStudentFields(student);
      
      // ุงูุฏุฑุฌุงุช ุงูุฃุณุงุณูุฉ (ูู 100)
      const baseScore = totalOf(student.scores); // max 70 (30+20+10+10)
      
      // ููุงุท ุงูุชููุฒ (ูู ููุทุฉ = 2 ููุทุฉ ุฅุถุงููุฉ)
      const excellenceBonus = (student.excellencePoints || 0) * 2;
      
      // ููุงุท ุงูููุฉ (ูู ููุทุฉ ููุฉ = 3 ููุงุท ุฅุถุงููุฉ)
      const strengthsBonus = (student.strengths || []).length * 3;
      
      // ููุงุท ุงูุถุนู (ูู ููุทุฉ ุถุนู = -2 ููุทุฉ)
      const weaknessPenalty = (student.weaknesses || []).filter(w => w !== "ูุง ููุฌุฏ").length * -2;
      
      // ูุฌูุฏ ุฎุทุฉ ุนูุงุฌูุฉ (-5 ููุงุท ูุฃููุง ุชุนูู ูุฌูุฏ ุถุนู ูุญุชุงุฌ ุนูุงุฌ)
      const planPenalty = (student.plan && (student.plan.problem || student.plan.action)) ? -5 : 0;
      
      // ุงูุญุถูุฑ (ูู 1% ุญุถูุฑ = 0.1 ููุทุฉุ ุงูุญุฏ ุงูุฃูุตู 10 ููุงุท)
      const attendanceScore = Math.min(10, (student.scores.attendance || 0) * 0.1);
      
      // ุงูุชุนุงูู (ุชุญููู ูุตู ุฅูู ุฑููู)
      let collaborationScore = 0;
      const collab = student.scores.collaboration || "ููุชุงุฒ";
      if (collab === "ููุชุงุฒ") collaborationScore = 10;
      else if (collab === "ุฌูุฏ ุฌุฏุง") collaborationScore = 8;
      else if (collab === "ุฌูุฏ") collaborationScore = 6;
      else collaborationScore = 0; // ูุง ุชุชุนุงูู ูุน ูุฌููุนุชูุง
      
      // ุงููุฌููุน ุงูููุงุฆู
      const totalScore = baseScore + excellenceBonus + strengthsBonus + weaknessPenalty + planPenalty + attendanceScore + collaborationScore;
      
      return {
        totalScore: Math.max(0, totalScore), // ูุง ููู ุนู ุตูุฑ
        breakdown: {
          baseScore,
          excellenceBonus,
          strengthsBonus,
          weaknessPenalty,
          planPenalty,
          attendanceScore,
          collaborationScore
        }
      };
    }
    
    function getTopStudentsByClass(className, limit = 5) {
      const students = state.studentsByClass[className] || [];
      if (students.length === 0) return [];
      
      // ุญุณุงุจ ููุงุท ุงูุชููุฒ ููู ุทุงูุจุฉ
      const studentsWithScores = students.map(student => ({
        ...student,
        className,
        excellenceData: calculateExcellenceScore(student)
      }));
      
      // ุชุฑุชูุจ ุญุณุจ ููุงุท ุงูุชููุฒ (ุงูุฃุนูู ุฃููุงู)
      studentsWithScores.sort((a, b) => b.excellenceData.totalScore - a.excellenceData.totalScore);
      
      // ุฅุฑุฌุงุน ุฃูุถู 5 ุทุงูุจุงุช
      return studentsWithScores.slice(0, limit);
    }
    
    function getAllTopStudents(limit = 5) {
      const allTopStudents = [];
      
      state.classes.forEach(className => {
        const topStudents = getTopStudentsByClass(className, limit);
        allTopStudents.push(...topStudents);
      });
      
      // ุชุฑุชูุจ ุฌููุน ุงูุทุงูุจุงุช ุญุณุจ ููุงุท ุงูุชููุฒ
      allTopStudents.sort((a, b) => b.excellenceData.totalScore - a.excellenceData.totalScore);
      
      return allTopStudents;
    }
    
    function renderExcellentStudents() {
      const selectedClass = $("#excellenceClassSelect").value;
      const container = $("#excellentStudents");
      
      let topStudents = [];
      if (selectedClass) {
        topStudents = getTopStudentsByClass(selectedClass, 5);
      } else {
        // ุนุฑุถ ุฃูุถู 15 ุทุงูุจุฉ ูู ุฌููุน ุงููุตูู (3 ูู ูู ูุตู)
        state.classes.forEach(className => {
          const classTop = getTopStudentsByClass(className, 3);
          topStudents.push(...classTop);
        });
        topStudents.sort((a, b) => b.excellenceData.totalScore - a.excellenceData.totalScore);
        topStudents = topStudents.slice(0, 15);
      }
      
      if (topStudents.length === 0) {
        container.innerHTML = `
          <div style="text-align:center;color:#718096;font-size:14px;padding:40px 20px;background:#f8fafc;border-radius:16px;border:2px dashed #cbd5e1;width:100%">
            <span style="font-size:48px;display:block;margin-bottom:12px;opacity:0.6">๐</span>
            <p style="margin:0;font-weight:600">ูุง ุชูุฌุฏ ุจูุงูุงุช ุทุงูุจุงุช ุจุนุฏ</p>
            <p style="margin:4px 0 0;font-size:12px;opacity:0.8">ุณุชุธูุฑ ุงูุทุงูุจุงุช ุงููุชููุฒุงุช ููุง ุนูุฏ ุฅุฏุฎุงู ุงูุจูุงูุงุช</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = topStudents.map((student, index) => {
        const isTopThree = index < 3;
        const score = student.excellenceData.totalScore;
        const breakdown = student.excellenceData.breakdown;
        
        // ุชุญุฏูุฏ ููู ุงูุดุงุฑุฉ ุญุณุจ ุงููุฑุชุจุฉ
        let rankColor = '#64748b'; // ุฑูุงุฏู ูููุฑุงุชุจ ุงูุนุงุฏูุฉ
        let rankIcon = '๐';
        if (index === 0) {
          rankColor = '#fbbf24'; // ุฐูุจู ููุฃูู
          rankIcon = '๐ฅ';
        } else if (index === 1) {
          rankColor = '#9ca3af'; // ูุถู ููุซุงูู
          rankIcon = '๐ฅ';
        } else if (index === 2) {
          rankColor = '#f59e0b'; // ุจุฑููุฒู ููุซุงูุซ
          rankIcon = '๐ฅ';
        }
        
        const rankBadge = `<div style="position:absolute;top:-8px;right:-8px;background:${rankColor};color:#fff;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;box-shadow:0 3px 12px rgba(0,0,0,0.3);border:2px solid #fff">${index + 1}</div>`;
        
        // ุชุญุฏูุฏ ูุณุชูู ุงูุชููุฒ
        let excellenceLevel = "ูุชููุฒุฉ";
        let levelColor = "#0ea5e9";
        if (score >= 120) {
          excellenceLevel = "ูุชูููุฉ ุฌุฏุงู";
          levelColor = "#dc2626";
        } else if (score >= 100) {
          excellenceLevel = "ูุชูููุฉ";
          levelColor = "#ea580c";
        } else if (score >= 85) {
          excellenceLevel = "ููุชุงุฒุฉ";
          levelColor = "#16a34a";
        }
        
        return `
          <div style="position:relative;display:flex;flex-direction:column;padding:28px;background:${isTopThree ? 'linear-gradient(135deg, #fef3c7 0%, #fbbf24 30%, #f59e0b 100%)' : 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)'};border-radius:24px;border:${isTopThree ? '4px solid #d97706' : '3px solid #e2e8f0'};box-shadow:0 ${isTopThree ? '16' : '12'}px ${isTopThree ? '40' : '32'}px rgba(${isTopThree ? '217,119,6' : '148,163,184'},0.${isTopThree ? '4' : '2'});transition:all 0.4s ease;cursor:pointer;min-width:300px;max-width:340px;overflow:hidden" onmouseover="this.style.transform='translateY(-8px) scale(1.02)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
            
            ${isTopThree ? `
            <div style="position:absolute;top:-30px;right:-30px;width:120px;height:120px;background:radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);border-radius:50%;animation:float 6s ease-in-out infinite"></div>
            <div style="position:absolute;bottom:-20px;left:-20px;width:80px;height:80px;background:radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);border-radius:50%;animation:float 4s ease-in-out infinite reverse"></div>
            ` : ''}
            
            ${rankBadge}
            
            <div style="text-align:center;margin-bottom:20px;position:relative;z-index:2">
              <div style="position:relative;display:inline-block;margin-bottom:12px">
                <div style="font-size:48px;filter:drop-shadow(0 4px 12px rgba(0,0,0,0.3));animation:${isTopThree ? 'celebrate 3s infinite' : 'none'}">${rankIcon}</div>
                ${isTopThree ? `<div style="position:absolute;top:-8px;right:-8px;font-size:20px;animation:sparkle 2s infinite">โจ</div>` : ''}
              </div>
              <div style="font-size:18px;font-weight:800;color:${isTopThree ? '#92400e' : '#1e293b'};margin-bottom:8px;line-height:1.3;text-shadow:${isTopThree ? '1px 1px 2px rgba(146,64,14,0.3)' : 'none'}">${student.name}</div>
              <div style="display:inline-flex;align-items:center;gap:6px;padding:6px 16px;background:${isTopThree ? 'rgba(255,255,255,0.9)' : 'rgba(14,165,233,0.1)'};border-radius:16px;border:2px solid ${isTopThree ? '#f59e0b' : '#0ea5e9'};font-size:13px;color:${isTopThree ? '#92400e' : '#0284c7'};font-weight:700">
                <span style="font-size:16px">๐ซ</span>
                <span>${student.className}</span>
              </div>
            </div>
            
            <div style="background:${isTopThree ? 'rgba(255,255,255,0.95)' : '#ffffff'};border-radius:16px;padding:20px;margin-bottom:16px;border:3px solid ${isTopThree ? '#f59e0b' : '#e0f2fe'};position:relative;z-index:2">
              <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:16px">
                <div style="text-align:center">
                  <div style="font-size:32px;font-weight:800;color:${levelColor};line-height:1;text-shadow:1px 1px 2px rgba(0,0,0,0.1)">${score.toFixed(1)}</div>
                  <div style="font-size:12px;color:#64748b;font-weight:600;margin-top:2px">ููุทุฉ ุชููุฒ</div>
                </div>
                <div style="font-size:32px;opacity:0.8">${isTopThree ? '๐' : 'โญ'}</div>
              </div>
              <div style="text-align:center;padding:12px 20px;background:linear-gradient(135deg, ${levelColor} 0%, ${levelColor}dd 100%);color:#ffffff;border-radius:20px;font-size:14px;font-weight:800;box-shadow:0 4px 16px rgba(0,0,0,0.2);position:relative;overflow:hidden">
                <div style="position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);animation:shine 3s infinite"></div>
                <span style="position:relative;z-index:2">${excellenceLevel}</span>
              </div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:12px;margin-bottom:16px;position:relative;z-index:2">
              <div style="text-align:center;padding:12px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:12px;border:2px solid #0ea5e9;transition:all 0.3s ease" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-weight:800;color:#0284c7;margin-bottom:4px;font-size:14px">๐ฏ ุงุฎุชุจุงุฑุงุช</div>
                <div style="color:#374151;font-weight:700;font-size:16px">${student.scores.exams || 0}<span style="color:#64748b;font-size:12px">/30</span></div>
              </div>
              <div style="text-align:center;padding:12px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:12px;border:2px solid #0ea5e9;transition:all 0.3s ease" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-weight:800;color:#0284c7;margin-bottom:4px;font-size:14px">โก ุนููู</div>
                <div style="color:#374151;font-weight:700;font-size:16px">${student.scores.practical || 0}<span style="color:#64748b;font-size:12px">/30</span></div>
              </div>
              <div style="text-align:center;padding:12px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:12px;border:2px solid #0ea5e9;transition:all 0.3s ease" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-weight:800;color:#0284c7;margin-bottom:4px;font-size:14px">๐ ูุงุฌุจุงุช</div>
                <div style="color:#374151;font-weight:700;font-size:16px">${student.scores.homework || 0}<span style="color:#64748b;font-size:12px">/15</span></div>
              </div>
              <div style="text-align:center;padding:12px;background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);border-radius:12px;border:2px solid #0ea5e9;transition:all 0.3s ease" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-weight:800;color:#0284c7;margin-bottom:4px;font-size:14px">๐ฌ ููุงูุดุฉ</div>
                <div style="color:#374151;font-weight:700;font-size:16px">${student.scores.discussion || 0}<span style="color:#64748b;font-size:12px">/15</span></div>
              </div>
            </div>
            
            <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:16px;position:relative;z-index:2">
              ${student.excellencePoints > 0 ? `<div style="display:inline-flex;align-items:center;gap:6px;font-size:11px;padding:6px 12px;background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);color:#ffffff;border-radius:16px;font-weight:700;box-shadow:0 3px 12px rgba(251,191,36,0.4)"><span style="font-size:14px">โญ</span><span>${student.excellencePoints}</span></div>` : ''}
              ${(student.strengths || []).length > 0 ? `<div style="display:inline-flex;align-items:center;gap:6px;font-size:11px;padding:6px 12px;background:linear-gradient(135deg, #16a34a 0%, #15803d 100%);color:#ffffff;border-radius:16px;font-weight:700;box-shadow:0 3px 12px rgba(22,163,74,0.4)"><span style="font-size:14px">๐ช</span><span>${student.strengths.length}</span></div>` : ''}
              ${(student.weaknesses || []).filter(w => w !== "ูุง ููุฌุฏ").length > 0 ? `<div style="display:inline-flex;align-items:center;gap:6px;font-size:11px;padding:6px 12px;background:linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);color:#ffffff;border-radius:16px;font-weight:700;box-shadow:0 3px 12px rgba(220,38,38,0.4)"><span style="font-size:14px">๐ง</span><span>${student.weaknesses.filter(w => w !== "ูุง ููุฌุฏ").length}</span></div>` : ''}
              ${(student.plan && (student.plan.problem || student.plan.action)) ? `<div style="display:inline-flex;align-items:center;gap:6px;font-size:11px;padding:6px 12px;background:linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);color:#ffffff;border-radius:16px;font-weight:700;box-shadow:0 3px 12px rgba(124,58,237,0.4)"><span style="font-size:14px">๐</span><span>ุฎุทุฉ</span></div>` : ''}
            </div>
            
            <div style="padding:12px;background:${isTopThree ? 'rgba(255,255,255,0.8)' : 'rgba(248,250,252,0.8)'};border-radius:12px;font-size:10px;color:#64748b;text-align:center;line-height:1.5;position:relative;z-index:2">
              <div style="font-weight:700;color:#374151;margin-bottom:4px">ุชูุตูู ุงูููุงุท:</div>
              <div>ุฃุณุงุณู: ${breakdown.baseScore} | ุชููุฒ: +${breakdown.excellenceBonus} | ููุฉ: +${breakdown.strengthsBonus} | ุถุนู: ${breakdown.weaknessPenalty} | ุฎุทุฉ: ${breakdown.planPenalty}</div>
            </div>
            
            ${isTopThree ? `
            <div style="position:absolute;bottom:-12px;left:50%;transform:translateX(-50%);display:flex;gap:6px">
              <div style="width:10px;height:10px;background:#f59e0b;border-radius:50%;animation:bounce 1.5s infinite"></div>
              <div style="width:10px;height:10px;background:#f59e0b;border-radius:50%;animation:bounce 1.5s infinite 0.3s"></div>
              <div style="width:10px;height:10px;background:#f59e0b;border-radius:50%;animation:bounce 1.5s infinite 0.6s"></div>
            </div>` : ''}
          </div>
          <style>
            @keyframes celebrate {
              0%, 100% { transform: scale(1) rotate(0deg); }
              25% { transform: scale(1.1) rotate(-3deg); }
              75% { transform: scale(1.1) rotate(3deg); }
            }
            @keyframes sparkle {
              0%, 100% { transform: scale(1) rotate(0deg); opacity: 1; }
              50% { transform: scale(1.4) rotate(180deg); opacity: 0.6; }
            }
            @keyframes float {
              0%, 100% { transform: translateY(0px) rotate(0deg); }
              50% { transform: translateY(-20px) rotate(180deg); }
            }
            @keyframes shine {
              0% { transform: translateX(-100%) skewX(-15deg); }
              100% { transform: translateX(200%) skewX(-15deg); }
            }
            @keyframes bounce {
              0%, 100% { transform: translateY(0); }
              50% { transform: translateY(-6px); }
            }
          </style>
        `;
      }).join("");
    }
    
    function populateExcellenceClassSelect() {
      const select = $("#excellenceClassSelect");
      if (!select) return;
      
      // ุงูุงุญุชูุงุธ ุจุงููููุฉ ุงููุญุฏุฏุฉ ุญุงููุงู
      const currentValue = select.value;
      
      // ูุณุญ ุงูุฎูุงุฑุงุช ุงูุญุงููุฉ
      select.innerHTML = '<option value="">ุฌููุน ุงููุตูู</option>';
      
      // ุฅุถุงูุฉ ุงููุตูู
      state.classes.forEach(className => {
        const option = document.createElement("option");
        option.value = className;
        option.textContent = className;
        select.appendChild(option);
      });
      
      // ุงุณุชุนุงุฏุฉ ุงููููุฉ ุงููุญุฏุฏุฉ
      if (currentValue && state.classes.includes(currentValue)) {
        select.value = currentValue;
      }
    }
    
    // ุฑุจุท ุงูุฃุญุฏุงุซ
    $("#excellenceClassSelect").addEventListener("change", renderExcellentStudents);
    $("#refreshExcellence").addEventListener("click", () => {
      populateExcellenceClassSelect();
      renderExcellentStudents();
      showToast("ุชู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุทุงูุจุงุช ุงููุชููุฒุงุช โจ");
    });
    
    // ุชููุฆุฉ ุฃูููุฉ
    populateExcellenceClassSelect();
    renderExcellentStudents();

    /* ================= ูุงุฆูุฉ ุงูุฏุฎูู ================= */
    $("#loginMenu").addEventListener("click",(e)=>{
      const btn = e.target.closest(".menu-btn");
      if(btn){
        const id = btn.dataset.target;
        $$(".login-card").forEach(c=> c.classList.add("hidden"));
        $("#"+id).classList.remove("hidden");
      }
      const closeBtn = e.target.closest("[data-close]");
      if(closeBtn){
        $("#"+closeBtn.dataset.close).classList.add("hidden");
      }
    });

    $("#teacherEnter").onclick = ()=>{
      const code = $("#teacherCode").value.trim();
      if(code !== TEACHER_PIN){ showToast("ุงูุฑูู ุบูุฑ ุตุญูุญ."); return; }
      $("#loginMenu").classList.add("hidden");
      // ุฅุฎูุงุก ููุญุงุช ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ
      $("#activeFamiliesSection").classList.add("hidden");
      $("#excellentStudentsSection").classList.add("hidden");
      $("#teacherPanel").classList.remove("hidden");
      renderTable();
    };

    $("#studentEnter").onclick = ()=>{
      const input = $("#studentNameInput").value.trim();
      const cls = $("#studentClassSelect").value;
      if(!input || !cls){ showToast("ูุฑุฌู ุฅุฏุฎุงู ุงูุงุณู ุฃู ุฑูู ุงูุณุฌู ุงููุฏูู ูุงุฎุชูุงุฑ ุงููุตู."); return; }
      const found = findStudentByNameOrId(cls, input);
      if(!found){ 
        const isNumeric = /^\d+$/.test(input);
        const errorMsg = isNumeric ? "ูู ูุชู ุงูุนุซูุฑ ุนูู ุฑูู ุงูุณุฌู ุงููุฏูู ูู ูุฐุง ุงููุตู." : "ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุงุณู ูู ูุฐุง ุงููุตู.";
        showToast(errorMsg); 
        return; 
      }
      
      // ุชุณุฌูู ุชูุงุนู ุงูุฃุณุฑุฉ
      recordFamilyInteraction(found.name, cls, 'student_login');
      
      $("#loginMenu").classList.add("hidden");
      // ุฅุฎูุงุก ููุญุงุช ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ
      $("#activeFamiliesSection").classList.add("hidden");
      $("#excellentStudentsSection").classList.add("hidden");
      $("#studentPanel").classList.remove("hidden");
      renderStudent(found, cls);
    };

    $("#parentEnter").onclick = ()=>{
      const input = $("#parentNameInput").value.trim();
      const cls = $("#parentClassSelect").value;
      if(!input || !cls){ showToast("ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุทุงูุจุฉ ุฃู ุฑูู ุงูุณุฌู ุงููุฏูู ูุงุฎุชูุงุฑ ุงููุตู."); return; }
      const found = findStudentByNameOrId(cls, input);
      if(!found){ 
        const isNumeric = /^\d+$/.test(input);
        const errorMsg = isNumeric ? "ูู ูุชู ุงูุนุซูุฑ ุนูู ุฑูู ุงูุณุฌู ุงููุฏูู ูู ูุฐุง ุงููุตู." : "ูู ูุชู ุงูุนุซูุฑ ุนูู ุงุณู ุงูุทุงูุจุฉ ูู ูุฐุง ุงููุตู.";
        showToast(errorMsg); 
        return; 
      }
      
      // ุชุณุฌูู ุชูุงุนู ุงูุฃุณุฑุฉ
      recordFamilyInteraction(found.name, cls, 'parent_login');
      
      $("#loginMenu").classList.add("hidden");
      // ุฅุฎูุงุก ููุญุงุช ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ
      $("#activeFamiliesSection").classList.add("hidden");
      $("#excellentStudentsSection").classList.add("hidden");
      $("#parentPanel").classList.remove("hidden");
      renderParent(found, cls);
    };

    $("#backToMenu1").onclick = ()=> backToMenu();
    $("#backToMenu2").onclick = ()=> backToMenu();
    $("#backToMenu3").onclick = ()=> backToMenu();

    /* ================= ูุงุฌูุฉ ุงููุนููุฉ ================= */
    let PLAN_FILTER = "all"; // all | overdue | today | soon
    
    $("#classSelect").addEventListener("change", renderTable);
    $("#searchInput").addEventListener("input", renderTable);

    function dueClassOfStudent(st){
      const info = dueInfo(st?.plan?.nextReview);
      return info?.cls || "due-clear";
    }
    
    function renderTable(){
      const cls = $("#classSelect").value || state.classes[0];
      let list = (state.studentsByClass[cls]||[]).slice();
      const q = normalizeName($("#searchInput").value);
      list = q ? list.filter(s=> normalizeName(s.name).includes(q)) : list;
      
      // ุชุทุจูู ููุชุฑ ุงูููุนุฏ
      if(PLAN_FILTER !== "all"){
        list = list.filter(st=>{
          const dcls = dueClassOfStudent(st);
          if(PLAN_FILTER==="overdue") return dcls==="due-overdue";
          if(PLAN_FILTER==="today")   return dcls==="due-today";
          if(PLAN_FILTER==="soon")    return dcls==="due-soon";
          return true;
        });
      }
      
      const filtered = list;

      const tbody = $("#table tbody");
      tbody.innerHTML="";
      filtered.forEach((st, idx)=>{
        ensureStudentFields(st);
        const tr=document.createElement("tr");
        
        // ุจูุงุก ุงูุฎูุงูุง
        let cellsHTML = `
          <td>${idx+1}</td>
          <td contenteditable="true" class="cell-nationalid">${st.nationalId||""}</td>
          <td contenteditable="true" class="cell-name">${st.name}</td>
        `;
        
        KEYS.forEach(k=>{
          if(k === "collaboration"){
            const val = st.scores[k] || "ููุชุงุฒ";
            cellsHTML += `
              <td data-k="${k}">
                <select class="collab-select" style="width:100%;padding:6px;border:1px solid #dfe7f1;border-radius:8px;background:#fff;">
                  <option value="ููุชุงุฒ" ${val==="ููุชุงุฒ"?"selected":""}>ููุชุงุฒ</option>
                  <option value="ุฌูุฏ ุฌุฏุง" ${val==="ุฌูุฏ ุฌุฏุง"?"selected":""}>ุฌูุฏ ุฌุฏุง</option>
                  <option value="ุฌูุฏ" ${val==="ุฌูุฏ"?"selected":""}>ุฌูุฏ</option>
                  <option value="ูุง ุชุชุนุงูู ูุน ูุฌููุนุชูุง" ${val==="ูุง ุชุชุนุงูู ูุน ูุฌููุนุชูุง"?"selected":""}>ูุง ุชุชุนุงูู ูุน ูุฌููุนุชูุง</option>
                </select>
              </td>
            `;
          } else {
            cellsHTML += `<td contenteditable="true" data-k="${k}">${st.scores[k]??""}</td>`;
          }
        });
        
        // ููุงุท ุงูุชููุฒ - ุถุบุท ูุทูู ุนูู ุงููุฌูุฉ ููุท
        cellsHTML += `
          <td class="cell-excellence" style="text-align:center;padding:12px;position:relative">
            <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
              <div style="display:flex;align-items:center;gap:12px">
                <span class="star-icon interactive-star" style="color:${st.excellencePoints>0?'#ffd700':'#bdbdbd'};font-size:36px;transition:all 0.3s ease;cursor:pointer;user-select:none;position:relative;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.2))" title="ุงุถุบุท ููุฅุถุงูุฉ | ุงุถุบุท ูุทููุงู ููุญุฐู">
                  โญ
                  <div class="long-press-indicator" style="position:absolute;top:-4px;right:-4px;width:12px;height:12px;background:#ff4444;border-radius:50%;opacity:0;transform:scale(0);transition:all 0.3s ease;box-shadow:0 2px 6px rgba(255,68,68,0.4)"></div>
                </span>
                <span class="excellence-count" style="font-size:20px;font-weight:800;color:#f57c00;min-width:30px;text-shadow:1px 1px 2px rgba(0,0,0,0.1)">${st.excellencePoints||0}</span>
              </div>
              <div style="font-size:11px;color:#718096;text-align:center;line-height:1.3;margin-top:4px;padding:6px 12px;background:rgba(113,128,150,0.1);border-radius:12px;border:1px solid rgba(113,128,150,0.2)">
                ๐ก ุงุถุบุท ุนูู ุงููุฌูุฉ ููุฅุถุงูุฉ<br>
                โฑ๏ธ ุงุถุบุท ูุทููุงู ููุญุฐู
              </div>
            </div>
          </td>
        `;
        
        // ููุงุท ุงูููุฉ - ูุงุฆูุฉ ูุชุนุฏุฏุฉ ุงูุงุฎุชูุงุฑ
        const strengthsStr = (st.strengths||[]).join(", ");
        cellsHTML += `
          <td class="cell-strengths" style="cursor:pointer;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${strengthsStr}">
            ${strengthsStr || "ุงุถุบุท ููุฅุถุงูุฉ"}
          </td>
        `;
        
        // ููุงุท ุงูุถุนู - ูุงุฆูุฉ ูุชุนุฏุฏุฉ ุงูุงุฎุชูุงุฑ
        const weaknessesStr = (st.weaknesses||[]).join(", ");
        cellsHTML += `
          <td class="cell-weaknesses" style="cursor:pointer;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${weaknessesStr}">
            ${weaknessesStr || "ุงุถุบุท ููุฅุถุงูุฉ"}
          </td>
        `;
        
        // ุงููุฌููุน ูุงูุญุงูุฉ
        const currentTotal = totalOf(st.scores);
        cellsHTML += `
          <td class="cell-total">${currentTotal}</td>
          <td class="cell-status">${statusBadge(currentTotal)}</td>
        `;
        
        // ุฎุทุฉ ุฑูุน ุงููุณุชูู
        const hasPlan = st.plan && (st.plan.problem || st.plan.action);
        cellsHTML += `
          <td class="cell-plan" style="text-align:center;cursor:pointer;padding:8px">
            ${hasPlan ? `<span class="plan-chip ${st.plan.status==='good'?'plan-good':st.plan.status==='partial'?'plan-partial':'plan-need'}" title="ุงุถุบุท ููุชุนุฏูู">๐ ุฎุทุฉ</span>` : `<button class="plan-add-btn" style="padding:6px 12px;background:linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:700;transition:all 0.3s ease">โ ุฅุถุงูุฉ</button>`}
          </td>
        `;
        
        tr.innerHTML = cellsHTML;
        
        // ุญูุธ ุงูุณุฌู ุงููุฏูู
        tr.querySelector(".cell-nationalid").addEventListener("blur", (e)=>{
          st.nationalId = e.target.textContent.trim();
          saveData(state);
        });
        
        // ุญูุธ ุงูุงุณู
        tr.querySelector(".cell-name").addEventListener("blur", (e)=>{
          st.name = e.target.textContent.trim();
          saveData(state);
        });
        
        // ุญูุธ ุงูุชุนุงูู ูู ุงููุงุฆูุฉ
        const collabSelect = tr.querySelector(".collab-select");
        if(collabSelect){
          collabSelect.addEventListener("change", ()=>{
            st.scores.collaboration = collabSelect.value;
            saveData(state);
          });
        }
        
        // ุญูุธ ุงูุฏุฑุฌุงุช ุงูุฑูููุฉ
        tr.querySelectorAll("[data-k]:not(:has(select))").forEach(td=>{
          td.addEventListener("blur", ()=>{
            const k = td.dataset.k;
            const v = Number(td.textContent.replace(/[^\d.]/g,""));
            st.scores[k] = isNaN(v) ? 0 : v;
            saveData(state);
            tr.querySelector(".cell-total").textContent = totalOf(st.scores);
            tr.querySelector(".cell-status").innerHTML = statusBadge(totalOf(st.scores));
            renderClassStats();
          });
        });
        
        // ููุงุท ุงูุชููุฒ - ุถุบุท ูุทูู ุนูู ุงููุฌูุฉ ููุท
        const excellenceCell = tr.querySelector(".cell-excellence");
        const countSpan = excellenceCell.querySelector(".excellence-count");
        const starIcon = excellenceCell.querySelector(".star-icon");
        const longPressIndicator = excellenceCell.querySelector(".long-press-indicator");
        
        // ูุชุบูุฑุงุช ุงูุถุบุท ุงููุทูู
        let longPressTimer = null;
        let isLongPress = false;
        
        // ูุธุงุฆู ูุณุงุนุฏุฉ ูุฅุฏุงุฑุฉ ููุงุท ุงูุชููุฒ
        function addExcellencePoint() {
          st.excellencePoints = (st.excellencePoints || 0) + 1;
          countSpan.textContent = st.excellencePoints;
          starIcon.style.color = "#ffd700";
          
          saveData(state);
          showToast(`ุชู ุฅุถุงูุฉ ููุทุฉ ุชููุฒ! ุงููุฌููุน: ${st.excellencePoints} โญ`);
        }
        
        function removeExcellencePoint() {
          if(st.excellencePoints > 0){
            st.excellencePoints = st.excellencePoints - 1;
            countSpan.textContent = st.excellencePoints;
            
            if(st.excellencePoints === 0){
              starIcon.style.color = "#bdbdbd";
            }
            
            saveData(state);
            showToast(`ุชู ุชูููู ููุงุท ุงูุชููุฒ ุฅูู ${st.excellencePoints} โญ`);
          }
        }
        
        // ุงูุถุบุท ุงููุทูู ุนูู ุงููุฌูุฉ
        function startLongPress() {
          isLongPress = false;
          longPressIndicator.style.opacity = "1";
          longPressIndicator.style.transform = "scale(1)";
          
          longPressTimer = setTimeout(() => {
            isLongPress = true;
            // ุชุฃุซูุฑ ุจุตุฑู ููุถุบุท ุงููุทูู
            starIcon.style.transform = "scale(1.2)";
            starIcon.style.filter = "drop-shadow(0 0 8px #ff4444)";
            longPressIndicator.style.background = "#ff4444";
            longPressIndicator.style.animation = "pulse 0.5s infinite";
            
            // ุญุฐู ููุทุฉ ุชููุฒ
            removeExcellencePoint();
            
            // ุฅุนุงุฏุฉ ุชุนููู ุงูุชุฃุซูุฑุงุช ุจุนุฏ ูุชุฑุฉ
            setTimeout(() => {
              starIcon.style.transform = "scale(1)";
              starIcon.style.filter = "none";
              longPressIndicator.style.opacity = "0";
              longPressIndicator.style.transform = "scale(0)";
              longPressIndicator.style.animation = "none";
            }, 300);
          }, 800); // 800ms ููุถุบุท ุงููุทูู
        }
        
        function cancelLongPress() {
          if(longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
          longPressIndicator.style.opacity = "0";
          longPressIndicator.style.transform = "scale(0)";
          longPressIndicator.style.animation = "none";
        }
        
        // ุฃุญุฏุงุซ ุงููุฌูุฉ - ุงูููุณ ูุงููุงูุณ
        starIcon.addEventListener("mousedown", startLongPress);
        starIcon.addEventListener("touchstart", (e) => {
          e.preventDefault();
          startLongPress();
        });
        
        starIcon.addEventListener("mouseup", () => {
          if(!isLongPress && longPressTimer) {
            // ุถุบุทุฉ ุนุงุฏูุฉ - ุฅุถุงูุฉ ููุทุฉ
            addExcellencePoint();
            starIcon.style.transform = "scale(1.1)";
            setTimeout(() => starIcon.style.transform = "scale(1)", 150);
          }
          cancelLongPress();
        });
        
        starIcon.addEventListener("touchend", (e) => {
          e.preventDefault();
          if(!isLongPress && longPressTimer) {
            // ุถุบุทุฉ ุนุงุฏูุฉ - ุฅุถุงูุฉ ููุทุฉ
            addExcellencePoint();
            starIcon.style.transform = "scale(1.1)";
            setTimeout(() => starIcon.style.transform = "scale(1)", 150);
          }
          cancelLongPress();
        });
        
        starIcon.addEventListener("mouseleave", cancelLongPress);
        starIcon.addEventListener("touchcancel", cancelLongPress);
        
        // ููุงุท ุงูููุฉ - ูุชุญ ูุงูุฐุฉ ุงุฎุชูุงุฑ
        const strengthsCell = tr.querySelector(".cell-strengths");
        strengthsCell.addEventListener("click", ()=>{
          showMultiSelectModal("ููุงุท ุงูููุฉ", STRENGTH_OPTIONS, st.strengths||[], (selected)=>{
            st.strengths = selected;
            const str = selected.join(", ");
            strengthsCell.textContent = str || "ุงุถุบุท ููุฅุถุงูุฉ";
            strengthsCell.title = str;
            saveData(state);
          });
        });
        
        // ููุงุท ุงูุถุนู - ูุชุญ ูุงูุฐุฉ ุงุฎุชูุงุฑ
        const weaknessesCell = tr.querySelector(".cell-weaknesses");
        weaknessesCell.addEventListener("click", ()=>{
          showMultiSelectModal("ููุงุท ุงูุถุนู", WEAKNESS_OPTIONS, st.weaknesses||[], (selected)=>{
            st.weaknesses = selected;
            const str = selected.join(", ");
            weaknessesCell.textContent = str || "ุงุถุบุท ููุฅุถุงูุฉ";
            weaknessesCell.title = str;
            saveData(state);
          });
        });
        
        // ุฎุทุฉ ุฑูุน ุงููุณุชูู - ูุชุญ ูุงูุฐุฉ ุงูุชุญุฑูุฑ
        const planCell = tr.querySelector(".cell-plan");
        planCell.addEventListener("click", ()=>{
          currentPlanStudent = st;
          openPlanModal(st);
        });
        
        // ุฅุถุงูุฉ ุชูุจูู ููุนุฏ ุงููุฑุงุฌุนุฉ ุนูู ุฒุฑ ุงูุฎุทุฉ
        if(st.plan && st.plan.nextReview){
          const info = dueInfo(st.plan.nextReview);
          let mark = "๐ข";
          if(info.cls === "due-soon") mark = "๐ก";
          if(info.cls === "due-today") mark = "๐ต";
          if(info.cls === "due-overdue") mark = "๐ด";
          
          const planBtn = planCell.querySelector("button, .plan-chip");
          if(planBtn){
            if(planBtn.tagName === "BUTTON"){
              planBtn.textContent = `โ ุฅุถุงูุฉ ${mark}`;
            } else {
              planBtn.innerHTML = `๐ ุฎุทุฉ ${mark}`;
            }
            planBtn.title = `ููุนุฏ ุงููุฑุงุฌุนุฉ: ${info.label}`;
          }
        }
        
        tbody.appendChild(tr);
      });
      $("#countStudents").textContent=(state.studentsByClass[cls]||[]).length;
      renderClassStats();
      
      // ุชุญุฏูุซ ูุงุฆูุฉ ุงูุทุงูุจุงุช ุงููุชููุฒุงุช ุนูุฏ ุชุบููุฑ ุงูุจูุงูุงุช
      renderExcellentStudents();
    }

    function renderClassStats(){
      const cls = $("#classSelect").value || state.classes[0];
      const list = state.studentsByClass[cls]||[];
      $("#classAvg").textContent=avgOfClass(list);
      $("#attRate").textContent=attendanceRate(list) + "%";
      $("#classProgress").style.width = percentage(avgOfClass(list)).toFixed(1)+"%";
      renderDueCounters();
    }

    function statusBadge(t){
      if(t>=90) return `<span class="pill" style="background:linear-gradient(135deg, #81c784 0%, #66bb6a 100%);color:#ffffff;border:none;font-weight:700;box-shadow:0 2px 8px rgba(129,199,132,0.4)">โญ ููุชุงุฒ</span>`;
      if(t>=80) return `<span class="pill" style="background:linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);color:#ffffff;border:none;font-weight:700;box-shadow:0 2px 8px rgba(100,181,246,0.4)">โจ ุฌูุฏ ุฌุฏุง</span>`;
      if(t>=70) return `<span class="pill" style="background:linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);color:#ffffff;border:none;font-weight:700;box-shadow:0 2px 8px rgba(255,183,77,0.4)">๐ ุฌูุฏ</span>`;
      if(t>=60) return `<span class="pill" style="background:linear-gradient(135deg, #ffd54f 0%, #ffca28 100%);color:#ffffff;border:none;font-weight:700;box-shadow:0 2px 8px rgba(255,213,79,0.4)">โ๏ธ ููุจูู</span>`;
      return `<span class="pill" style="background:linear-gradient(135deg, #e57373 0%, #ef5350 100%);color:#ffffff;border:none;font-weight:700;box-shadow:0 2px 8px rgba(229,115,115,0.4)">โ๏ธ ุจุญุงุฌุฉ ุฅูู ูุชุงุจุนุฉ ูู ุงูุฃูู</span>`;
    }

    function getStatus(total){
      if(total>=90) return {text:"ููุชุงุฒ", color:"#48bb78"};
      if(total>=80) return {text:"ุฌูุฏ ุฌุฏุง", color:"#4299e1"};
      if(total>=70) return {text:"ุฌูุฏ", color:"#ed8936"};
      if(total>=60) return {text:"ููุจูู", color:"#ecc94b"};
      return {text:"ุจุญุงุฌุฉ ุฅูู ูุชุงุจุนุฉ ูู ุงูุฃูู", color:"#f56565"};
    }



    $("#importBtn").onclick = ()=> $("#csvFile").click();
    $("#csvFile").addEventListener("change", (e)=>{
      const file = e.target.files[0]; if(!file) return;
      Papa.parse(file, {
        header:true,
        complete: (res)=>{
          const data = loadData();
          res.data.forEach(row=>{
            const cls = (row["ุงููุตู"]||row["class"]||"ุซุงูุซ 1").toString().trim();
            const name = (row["ุงูุงุณู ุงูุซูุงุซู"]||row["name"]||"").toString().trim();
            if(!name) return;
            ensureClass(data, cls);
            const item = {
              name,
              nationalId: (row["ุงูุณุฌู ุงููุฏูู"]||row["nationalId"]||"").toString().trim(),
              scores:{
                exams: Number(row["ุงูุงุฎุชุจุงุฑุงุช"]||row["exams"]||0),
                practical: Number(row["ุงูุนููู"]||row["practical"]||0),
                homework: Number(row["ุงููุงุฌุจุงุช"]||row["homework"]||0),
                discussion: Number(row["ุงูููุงูุดุงุช"]||row["discussion"]||0),
                attendance: Number(row["ุงูุญุถูุฑ"]||row["attendance"]||0),
                collaboration: (row["ุงูุชุนุงูู"]||row["collaboration"]||"ููุชุงุฒ").toString(),
              },
              excellencePoints: Number(row["ููุงุท ุงูุชููุฒ"]||row["excellencePoints"]||0),
              strengths: (row["ููุงุท ุงูููุฉ"]||row["strengths"]||"").toString().split(",").map(s=>s.trim()).filter(s=>s),
              weaknesses: (row["ููุงุท ุงูุถุนู"]||row["weaknesses"]||"").toString().split(",").map(s=>s.trim()).filter(s=>s)
            };
            data.studentsByClass[cls].push(item);
          });
          saveData(data); state=data;
          renderClassSelectors($("#classSelect").value);
          renderTable();
          populateExcellenceClassSelect();
          renderExcellentStudents();
          showToast("ุชู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ โ");
        }
      });
    });

    $("#importExcelBtn").onclick = ()=> $("#excelFile").click();
    $("#excelFile").addEventListener("change", (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (event)=>{
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          const appData = loadData();
          jsonData.forEach(row=>{
            const cls = (row["ุงููุตู"]||row["class"]||"ุซุงูุซ 1").toString().trim();
            const name = (row["ุงูุงุณู ุงูุซูุงุซู"]||row["name"]||"").toString().trim();
            if(!name) return;
            ensureClass(appData, cls);
            const item = {
              name,
              nationalId: (row["ุงูุณุฌู ุงููุฏูู"]||row["nationalId"]||"").toString().trim(),
              scores:{
                exams: Number(row["ุงูุงุฎุชุจุงุฑุงุช"]||row["exams"]||0),
                practical: Number(row["ุงูุนููู"]||row["practical"]||0),
                homework: Number(row["ุงููุงุฌุจุงุช"]||row["homework"]||0),
                discussion: Number(row["ุงูููุงูุดุงุช"]||row["discussion"]||0),
                attendance: Number(row["ุงูุญุถูุฑ"]||row["attendance"]||0),
                collaboration: (row["ุงูุชุนุงูู"]||row["collaboration"]||"ููุชุงุฒ").toString(),
              },
              excellencePoints: Number(row["ููุงุท ุงูุชููุฒ"]||row["excellencePoints"]||0),
              strengths: (row["ููุงุท ุงูููุฉ"]||row["strengths"]||"").toString().split(",").map(s=>s.trim()).filter(s=>s),
              weaknesses: (row["ููุงุท ุงูุถุนู"]||row["weaknesses"]||"").toString().split(",").map(s=>s.trim()).filter(s=>s)
            };
            appData.studentsByClass[cls].push(item);
          });
          saveData(appData); state=appData;
          renderClassSelectors($("#classSelect").value);
          renderTable();
          populateExcellenceClassSelect();
          renderExcellentStudents();
          showToast("ุชู ุงุณุชูุฑุงุฏ ููู Excel ุจูุฌุงุญ โ");
        } catch(err) {
          showToast("ุฎุทุฃ ูู ูุฑุงุกุฉ ููู Excel โ");
          console.error(err);
        }
      };
      reader.readAsArrayBuffer(file);
    });

    $("#importPlansExcelBtn").onclick = ()=> $("#plansExcelFile").click();
    $("#plansExcelFile").addEventListener("change", (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (event)=>{
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          
          const appData = loadData();
          let importedCount = 0;
          let notFoundCount = 0;
          
          jsonData.forEach(row=>{
            const cls = (row["ุงููุตู"]||row["class"]||"").toString().trim();
            const name = (row["ุงูุงุณู ุงูุซูุงุซู"]||row["name"]||"").toString().trim();
            
            if(!cls || !name) return;
            
            // ุงูุจุญุซ ุนู ุงูุทุงูุจุฉ ูู ุงูุจูุงูุงุช
            const studentList = appData.studentsByClass[cls];
            if(!studentList) {
              notFoundCount++;
              return;
            }
            
            const student = studentList.find(s => normalizeName(s.name) === normalizeName(name));
            if(!student) {
              notFoundCount++;
              return;
            }
            
            // ุฅูุดุงุก ุฃู ุชุญุฏูุซ ุงูุฎุทุฉ
            ensurePlanObject(student);
            
            // ุงุณุชูุฑุงุฏ ุจูุงูุงุช ุงูุฎุทุฉ
            if(row["ุงููุดููุฉ ุงูุฃูุงุฏูููุฉ"] || row["problem"]) {
              student.plan.problem = (row["ุงููุดููุฉ ุงูุฃูุงุฏูููุฉ"]||row["problem"]||"").toString().trim();
            }
            if(row["ุงูุฅุฌุฑุงุก ุงูููุชุฑุญ"] || row["action"]) {
              student.plan.action = (row["ุงูุฅุฌุฑุงุก ุงูููุชุฑุญ"]||row["action"]||"").toString().trim();
            }
            if(row["ูุฏุฉ ุงูุชูููุฐ"] || row["duration"]) {
              student.plan.duration = (row["ูุฏุฉ ุงูุชูููุฐ"]||row["duration"]||"").toString().trim();
            }
            if(row["ุงููุชูุฌุฉ ุงููุชููุนุฉ"] || row["expected"]) {
              student.plan.expected = (row["ุงููุชูุฌุฉ ุงููุชููุนุฉ"]||row["expected"]||"").toString().trim();
            }
            if(row["ูุชุงุจุนุฉ ุจุนุฏ ุฃุณุจูุนูู"] || row["followup"]) {
              student.plan.followup = (row["ูุชุงุจุนุฉ ุจุนุฏ ุฃุณุจูุนูู"]||row["followup"]||"").toString().trim();
            }
            
            // ุญุงูุฉ ุงูุฎุทุฉ
            const statusText = (row["ุงูุญุงูุฉ"]||row["ุญุงูุฉ ุงูุฎุทุฉ"]||row["status"]||"").toString().trim();
            if(statusText.includes("ุชุญุณูู ูุงุถุญ") || statusText.includes("โ") || statusText === "good") {
              student.plan.status = "good";
            } else if(statusText.includes("ุจุญุงุฌุฉ ุฏุนู") || statusText.includes("๐ด") || statusText === "need") {
              student.plan.status = "need";
            } else if(statusText.includes("ุชุญุณูู ุฌุฒุฆู") || statusText.includes("โ๏ธ") || statusText === "partial") {
              student.plan.status = "partial";
            }
            
            // ุชุฃุซูุฑ ุงูุฎุทุฉ
            const impactValue = row["ุชุฃุซูุฑ ุงูุฎุทุฉ (%)"]||row["ุชุฃุซูุฑ ุงูุฎุทุฉ"]||row["impact"];
            if(impactValue !== undefined && impactValue !== null && impactValue !== "") {
              const impact = Number(impactValue.toString().replace(/[^\d.]/g, ""));
              if(!isNaN(impact)) {
                student.plan.impact = Math.max(0, Math.min(10, impact));
              }
            }
            
            // ููุนุฏ ุงููุฑุงุฌุนุฉ
            if(row["ููุนุฏ ุงููุฑุงุฌุนุฉ"] || row["nextReview"]) {
              const dateStr = (row["ููุนุฏ ุงููุฑุงุฌุนุฉ"]||row["nextReview"]||"").toString().trim();
              // ูุญุงููุฉ ุชุญููู ุงูุชุงุฑูุฎ ุฅูู ุตูุบุฉ YYYY-MM-DD
              if(dateStr) {
                try {
                  const dateObj = new Date(dateStr);
                  if(!isNaN(dateObj.getTime())) {
                    const year = dateObj.getFullYear();
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    student.plan.nextReview = `${year}-${month}-${day}`;
                  }
                } catch(err) {
                  // ุฅุฐุง ูุดู ุงูุชุญูููุ ูุญุงูู ุงุณุชุฎุฏุงู ุงููููุฉ ููุง ูู
                  student.plan.nextReview = dateStr;
                }
              }
            }
            
            importedCount++;
          });
          
          saveData(appData); 
          state = appData;
          renderTable();
          
          let message = `โ ุชู ุงุณุชูุฑุงุฏ ${importedCount} ุฎุทุฉ ุจูุฌุงุญ`;
          if(notFoundCount > 0) {
            message += ` | โ๏ธ ${notFoundCount} ุทุงูุจุฉ ุบูุฑ ููุฌูุฏุฉ`;
          }
          showToast(message);
          
        } catch(err) {
          showToast("โ ุฎุทุฃ ูู ูุฑุงุกุฉ ููู ุงูุฎุทุท");
          console.error(err);
        }
      };
      reader.readAsArrayBuffer(file);
    });

    $("#exportBtn").onclick = ()=>{
      const rows = [];
      state.classes.forEach(cls=>{
        (state.studentsByClass[cls]||[]).forEach(st=>{
          ensureStudentFields(st);
          rows.push({
            "ุงููุตู": cls,
            "ุงูุณุฌู ุงููุฏูู": st.nationalId||"",
            "ุงูุงุณู ุงูุซูุงุซู": st.name,
            "ุงูุงุฎุชุจุงุฑุงุช": st.scores.exams||0,
            "ุงูุนููู": st.scores.practical||0,
            "ุงููุงุฌุจุงุช": st.scores.homework||0,
            "ุงูููุงูุดุงุช": st.scores.discussion||0,
            "ุงูุญุถูุฑ": st.scores.attendance||0,
            "ุงูุชุนุงูู": st.scores.collaboration||"",
            "ููุงุท ุงูุชููุฒ": st.excellencePoints||0,
            "ููุงุท ุงูููุฉ": (st.strengths||[]).join(", "),
            "ููุงุท ุงูุถุนู": (st.weaknesses||[]).join(", "),
            "ุงููุฌููุน": totalOf(st.scores)
          });
        });
      });
      const csv = Papa.unparse(rows);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      saveAs(blob, "ุชูุงุฑูุฑ_ุงูุชูููู.csv");
      showToast("ุชู ุชุตุฏูุฑ ุงูุจูุงูุงุช");
    };
    
    $("#exportFilteredBtn").onclick = ()=>{
      const cls = $("#classSelect").value || state.classes[0];
      let list = (state.studentsByClass[cls]||[]).slice();
      const q = normalizeName($("#searchInput").value);
      list = q ? list.filter(s=> normalizeName(s.name).includes(q)) : list;
      
      // ุชุทุจูู ููุชุฑ ุงูููุนุฏ
      if(PLAN_FILTER !== "all"){
        list = list.filter(st=>{
          const dcls = dueClassOfStudent(st);
          if(PLAN_FILTER==="overdue") return dcls==="due-overdue";
          if(PLAN_FILTER==="today")   return dcls==="due-today";
          if(PLAN_FILTER==="soon")    return dcls==="due-soon";
          return true;
        });
      }
      
      if(list.length === 0){
        showToast("โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุตุฏูุฑูุง ุญุณุจ ุงูููุชุฑ ุงูุญุงูู");
        return;
      }
      
      const rows = [];
      list.forEach(st=>{
        ensureStudentFields(st);
        const p = ensurePlanObject(st);
        const base = totalOf(st.scores);
        const adj = adjustedTotal(st.scores, p);
        const postStatus = adjustedStatus(adj);
        const dueLabel = dueLabelOfStudent(st);
        
        rows.push({
          "ุงููุตู": cls,
          "ุงูุณุฌู ุงููุฏูู": st.nationalId||"",
          "ุงูุงุณู ุงูุซูุงุซู": st.name,
          "ุงูุงุฎุชุจุงุฑุงุช": st.scores.exams||0,
          "ุงูุนููู": st.scores.practical||0,
          "ุงููุงุฌุจุงุช": st.scores.homework||0,
          "ุงูููุงูุดุงุช": st.scores.discussion||0,
          "ุงูุญุถูุฑ": st.scores.attendance||0,
          "ุงูุชุนุงูู": st.scores.collaboration||"",
          "ููุงุท ุงูุชููุฒ": st.excellencePoints||0,
          "ููุงุท ุงูููุฉ": (st.strengths||[]).join(", "),
          "ููุงุท ุงูุถุนู": (st.weaknesses||[]).join(", "),
          "ุงููุฌููุน ุงูุฃุตูู (ูู 100)": base,
          "ุงููุฌููุน ุจุนุฏ ุงูุฎุทุฉ (ูู 100)": adj,
          "ุงูุญุงูุฉ ุจุนุฏ ุงูุฎุทุฉ": postStatus,
          "ุงููุดููุฉ ุงูุฃูุงุฏูููุฉ": p.problem||"",
          "ุงูุฅุฌุฑุงุก ุงูููุชุฑุญ": p.action||"",
          "ูุฏุฉ ุงูุชูููุฐ": p.duration||"",
          "ุงููุชูุฌุฉ ุงููุชููุนุฉ": p.expected||"",
          "ูุชุงุจุนุฉ ุจุนุฏ ุฃุณุจูุนูู": p.followup||"",
          "ุญุงูุฉ ุงูุฎุทุฉ": p.status==="good"?"ุชุญุณูู ูุงุถุญ โ":p.status==="partial"?"ุชุญุณูู ุฌุฒุฆู โ๏ธ":p.status==="need"?"ุจุญุงุฌุฉ ุฏุนู ๐ด":"",
          "ุชุฃุซูุฑ ุงูุฎุทุฉ (%)": Number(p.impact||0),
          "ููุนุฏ ุงููุฑุงุฌุนุฉ": p.nextReview||"",
          "ุญุงูุฉ ุงูููุนุฏ": dueLabel
        });
      });
      
      const filterName = PLAN_FILTER === "all" ? "ุงููู" : 
                         PLAN_FILTER === "overdue" ? "ูุชุฃุฎุฑุฉ" :
                         PLAN_FILTER === "today" ? "ุงูููู" : "ูุฑูุจูุง";
      
      const csv = Papa.unparse(rows);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      saveAs(blob, `ุชุตุฏูุฑ_${cls}_${filterName}.csv`);
      showToast(`โ ุชู ุชุตุฏูุฑ ${rows.length} ุทุงูุจุฉ (${filterName})`);
    };
    
    function dueLabelOfStudent(st){
      const info = dueInfo(st?.plan?.nextReview);
      return info?.label || "ูุง ููุฌุฏ ููุนุฏ";
    }

    $("#demoBtn").onclick = ()=>{
      const demo = {
        classes: ["ุซุงูุซ 1", "ุซุงูุซ 2", "ุซุงูุซ 3", "ุซุงูุซ 4", "ุซุงูู ุฅุฏุงุฑุฉ"],
        studentsByClass:{
          "ุซุงูุซ 1":[
            {name:"ุณุงุฑุฉ ูุญูุฏ ุนูู", nationalId:"1234567890", scores:{exams:28, practical:18, homework:9, discussion:8, attendance:95, collaboration:"ููุชุงุฒ"}, excellencePoints:3, strengths:["ุงูุชุนุงูู","ุนุฏู ุงูุบูุงุจ"], weaknesses:[]},
            {name:"ุฑูู ุฎุงูุฏ ูุงุตุฑ", nationalId:"2345678901", scores:{exams:22, practical:15, homework:7, discussion:6, attendance:88, collaboration:"ุฌูุฏ"}, excellencePoints:1, strengths:["ุงูุงูุชุฒุงู ุจุงูุญุถูุฑ ูู ุงูููุช ุงููุญุฏุฏ"], weaknesses:["ุนุฏู ุงูุชูุงุนู ูุน ุงููุฌููุนุฉ"]},
            {name:"ุฌูุฏ ุนูุฑ ุตุงูุญ", nationalId:"3456789012", scores:{exams:25, practical:17, homework:8, discussion:7, attendance:92, collaboration:"ุฌูุฏ ุฌุฏุง"}, excellencePoints:2, strengths:["ูุงุฆุฏุฉ ูุชููุฒุฉ","ููููุฉ ูููุฌููุนุฉ"], weaknesses:[]}
          ],
          "ุซุงูุซ 2":[
            {name:"ููู ุนุงุฏู ููุฏ", nationalId:"4567890123", scores:{exams:29, practical:19, homework:10, discussion:9, attendance:98, collaboration:"ููุชุงุฒ"}, excellencePoints:5, strengths:["ุงูุชุนุงูู","ุนุฏู ุงูุบูุงุจ","ูุงุฆุฏุฉ ูุชููุฒุฉ"], weaknesses:[]},
            {name:"ููุง ูุงุฒู ููุตู", nationalId:"5678901234", scores:{exams:18, practical:13, homework:6, discussion:5, attendance:75, collaboration:"ูุง ุชุชุนุงูู ูุน ูุฌููุนุชูุง"}, excellencePoints:0, strengths:[], weaknesses:["ูุซุฑุฉ ุงูุบูุงุจ","ุนุฏู ุงูุชูุงุนู ูุน ุงููุฌููุนุฉ"]}
          ],
          "ุซุงูุซ 3":[],
          "ุซุงูุซ 4":[],
          "ุซุงูู ุฅุฏุงุฑุฉ":[]
        }
      };
      state = demo; saveData(state); renderClassSelectors("ุซุงูุซ 1"); renderTable();
      populateExcellenceClassSelect();
      renderExcellentStudents();
      showToast("ุชู ุชุญููู ุจูุงูุงุช ุชุฌุฑูุจูุฉ.");
    };

    $("#clearBtn").onclick = ()=>{
      showDeleteModal(()=>{
        localStorage.removeItem(STORAGE_KEY); state=loadData(); initIfEmpty(); renderClassSelectors(); renderTable();
        populateExcellenceClassSelect();
        renderExcellentStudents();
        showToast("ุชู ูุณุญ ุฌููุน ุงูุจูุงูุงุช");
      });
    };

    $("#saveAfterImport").onclick = ()=>{
      saveData(state);
      showToast("ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ โ");
    };

    $("#saveGrades").onclick = ()=>{
      saveData(state);
      showToast("ุชู ุญูุธ ุฌููุน ุงูุชุนุฏููุงุช โ");
    };

    $("#printBtn").onclick = ()=> window.print();
    $("#printStudent").onclick = ()=> window.print();
    $("#printParent").onclick = ()=> window.print();
    
    /* ================= ููุชุฑุฉ ุงูุฌุฏูู ุญุณุจ ููุนุฏ ุงููุฑุงุฌุนุฉ ================= */
    function bindPlanFilterPills(){
      $$(".plan-filter").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          PLAN_FILTER = btn.dataset.filter || "all";
          $$(".plan-filter, .plan-filter-reset").forEach(b=> b.classList.remove("active"));
          btn.classList.add("active");
          renderTable();
        });
      });
      
      $$(".plan-filter-reset").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          PLAN_FILTER = "all";
          $$(".plan-filter, .plan-filter-reset").forEach(b=> b.classList.remove("active"));
          btn.classList.add("active");
          renderTable();
        });
      });
    }
    
    // ุชูุนูู ุฒุฑ "ุฅูุบุงุก ุงูููุชุฑ" ุงูุชุฑุงุถููุง
    setTimeout(()=>{
      const resetBtn = $("#pillReset");
      if(resetBtn) resetBtn.classList.add("active");
      bindPlanFilterPills();
    }, 100);

    /* ================= ูุงูุฐุฉ ุฎุทุฉ ุฑูุน ุงููุณุชูู ================= */
    function openPlanModal(student){
      const modal = $("#planModal");
      modal.classList.remove("hidden");
      modal.setAttribute("aria-hidden", "false");
      
      const p = ensurePlanObject(student);
      
      // ุชุนุจุฆุฉ ุงูุญููู
      $("#planProblem").value = p.problem || "";
      $("#planAction").value = p.action || "";
      $("#planDuration").value = p.duration || "";
      $("#planExpected").value = p.expected || "";
      $("#planFollowup").value = p.followup || "";
      $("#planStatus").value = p.status || "partial";
      $("#planImpact").value = Number(p.impact||0);
      $("#planNextReview").value = p.nextReview || "";
    }

    function closePlanModal(){
      const modal = $("#planModal");
      modal.classList.add("hidden");
      modal.setAttribute("aria-hidden", "true");
      currentPlanStudent = null;
    }

    $("#closePlan").onclick = closePlanModal;
    $("#planModal").onclick = (e)=>{
      if(e.target.id === "planModal") closePlanModal();
    };

    $("#savePlan").onclick = ()=>{
      if(!currentPlanStudent){
        showToast("โ๏ธ ูู ูุชู ุชุญุฏูุฏ ุทุงูุจุฉ");
        return;
      }

      const problem = $("#planProblem").value.trim();
      const action = $("#planAction").value.trim();
      const duration = $("#planDuration").value.trim();
      const expected = $("#planExpected").value.trim();
      const followup = $("#planFollowup").value.trim();
      const status = $("#planStatus").value;
      const impact = Math.max(0, Math.min(10, Number($("#planImpact").value||0)));
      const nextReview = ($("#planNextReview").value||"").trim();

      if(!problem || !action || !duration || !expected){
        showToast("โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ุงูุญููู ุงูุฃุณุงุณูุฉ (ุงููุดููุฉุ ุงูุฅุฌุฑุงุกุ ุงููุฏุฉุ ุงููุชูุฌุฉ ุงููุชููุนุฉ)");
        return;
      }

      ensurePlanObject(currentPlanStudent);
      currentPlanStudent.plan.problem = problem;
      currentPlanStudent.plan.action = action;
      currentPlanStudent.plan.duration = duration;
      currentPlanStudent.plan.expected = expected;
      currentPlanStudent.plan.followup = followup;
      currentPlanStudent.plan.status = status;
      currentPlanStudent.plan.impact = impact;
      currentPlanStudent.plan.nextReview = nextReview;

      saveData(state);
      showToast("โ ุชู ุญูุธ ุงูุฎุทุฉ ุจูุฌุงุญ");
      closePlanModal();
      renderTable();
      
      // ุชุญุฏูุซ ุญูู ูููุญุงุช ุฅู ูุงูุช ููุชูุญุฉ
      tryRefreshStudentOrParentPlanIfVisible(currentPlanStudent, null);
    };

    $("#exportPlans").onclick = ()=>{
      const rows = [];
      state.classes.forEach(cls=>{
        (state.studentsByClass[cls]||[]).forEach(st=>{
          const p = ensurePlanObject(st);
          const base = totalOf(st.scores);
          const adj = adjustedTotal(st.scores, p);
          
          // ูุตุฏูุฑ ุฌููุน ุงูุทุงูุจุงุช ุญุชู ูู ูู ุชูู ูุฏููู ุฎุทุฉ
          rows.push({
            "ุงููุตู": cls,
            "ุงูุงุณู ุงูุซูุงุซู": st.name || "",
            "ุงููุดููุฉ ุงูุฃูุงุฏูููุฉ": p.problem || "",
            "ุงูุฅุฌุฑุงุก ุงูููุชุฑุญ": p.action || "",
            "ูุฏุฉ ุงูุชูููุฐ": p.duration || "",
            "ุงููุชูุฌุฉ ุงููุชููุนุฉ": p.expected || "",
            "ูุชุงุจุนุฉ ุจุนุฏ ุฃุณุจูุนูู": p.followup || "",
            "ุงูุญุงูุฉ": p.status === "good" ? "ุชุญุณูู ูุงุถุญ โ" : p.status === "partial" ? "ุชุญุณูู ุฌุฒุฆู โ๏ธ" : p.status === "need" ? "ุจุญุงุฌุฉ ุฏุนู ๐ด" : "",
            "ุชุฃุซูุฑ ุงูุฎุทุฉ (%)": Number(p.impact||0),
            "ููุนุฏ ุงููุฑุงุฌุนุฉ": p.nextReview || "",
            "ุงููุฌููุน ุงูุฃุตูู (ูู 100)": base,
            "ุงููุฌููุน ุจุนุฏ ุงูุฎุทุฉ (ูู 100)": adj,
            "ุงูุญุงูุฉ ุจุนุฏ ุงูุฎุทุฉ": adjustedStatus(adj)
          });
        });
      });

      if(rows.length === 0){
        showToast("โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ูุชุตุฏูุฑูุง");
        return;
      }

      const csv = Papa.unparse(rows);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      saveAs(blob, "ุฎุทุท_ุฑูุน_ุงููุณุชูู.csv");
      showToast("โ ุชู ุชุตุฏูุฑ ุงูุฎุทุท ุจูุฌุงุญ");
    };

    /* ================= ุฑุณูู ุจูุงููุฉ ================= */
    function renderChart(canvasId, scores, title){
      if(chartRefs[canvasId]) chartRefs[canvasId].destroy();
      const ctx = document.getElementById(canvasId).getContext("2d");
      
      // ุนุฑุถ ุงููุฌุงูุงุช ุงูุฑูููุฉ ููุท (ุจุฏูู ุงูุชุนุงูู ูุงูุญุถูุฑ)
      const numericKeys = ["exams","practical","homework","discussion"];
      
      // ุงูุญุฏูุฏ ุงููุตูู ููู ูุฌุงู
      const maxScores = {
        exams: 30,
        practical: 30,
        homework: 15,
        discussion: 15
      };
      
      // ุฃููุงู ุซุงุจุชุฉ ูุชุฏุฑุฌุฉ ููู ุนููุฏ
      const fixedColors = [
        {
          // ุงูุงุฎุชุจุงุฑุงุช ุงูุชุญุฑูุฑูุฉ - ุฃุฎุถุฑ ุฒูุฑุฏู ูุชุฏุฑุฌ
          bg: 'linear-gradient(135deg, rgba(16, 185, 129, 0.9) 0%, rgba(5, 150, 105, 0.9) 100%)',
          bgSolid: 'rgba(16, 185, 129, 0.85)',
          border: 'rgb(5, 150, 105)',
          hover: 'rgba(5, 150, 105, 1)'
        },
        {
          // ุงูุชูููู ุงูุนููู - ุฃุฒุฑู ุณูุงูู ูุชุฏุฑุฌ
          bg: 'linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%)',
          bgSolid: 'rgba(59, 130, 246, 0.85)',
          border: 'rgb(37, 99, 235)',
          hover: 'rgba(37, 99, 235, 1)'
        },
        {
          // ุงููุงุฌุจุงุช ุงูุฑูููุฉ - ุจููุณุฌู ูุชุฏุฑุฌ
          bg: 'linear-gradient(135deg, rgba(139, 92, 246, 0.9) 0%, rgba(124, 58, 237, 0.9) 100%)',
          bgSolid: 'rgba(139, 92, 246, 0.85)',
          border: 'rgb(124, 58, 237)',
          hover: 'rgba(124, 58, 237, 1)'
        },
        {
          // ุงูููุงูุดุงุช ุงูุตููุฉ - ุจุฑุชูุงูู ุฐูุจู ูุชุฏุฑุฌ
          bg: 'linear-gradient(135deg, rgba(251, 146, 60, 0.9) 0%, rgba(249, 115, 22, 0.9) 100%)',
          bgSolid: 'rgba(251, 146, 60, 0.85)',
          border: 'rgb(249, 115, 22)',
          hover: 'rgba(249, 115, 22, 1)'
        }
      ];
      
      // ูุญุต ุงูุฏุฑุฌุงุช ุงูุถุนููุฉ (ุฃูู ูู 70%)
      const weakScores = numericKeys.map((k, idx) => {
        const score = +scores[k] || 0;
        const maxScore = maxScores[k];
        const percentage = (score / maxScore) * 100;
        return percentage < 70;
      });
      
      // ุชุทุจูู ุงูููู ุงูุฃุญูุฑ ููุฏุฑุฌุงุช ุงูุถุนููุฉ
      const finalColors = fixedColors.map((color, idx) => {
        if(weakScores[idx]){
          return {
            bg: 'linear-gradient(135deg, rgba(244, 63, 94, 0.9) 0%, rgba(225, 29, 72, 0.9) 100%)',
            bgSolid: 'rgba(244, 63, 94, 0.85)',
            border: 'rgb(225, 29, 72)',
            hover: 'rgba(225, 29, 72, 1)',
            warning: true
          };
        }
        return color;
      });
      
      chartRefs[canvasId] = new Chart(ctx, {
        type:"bar",
        data:{
          labels: numericKeys.map(k=>HEADERS[k]),
          datasets:[{ 
            label:title, 
            data: numericKeys.map(k=> +scores[k]||0),
            backgroundColor: finalColors.map(c => c.bgSolid),
            borderColor: finalColors.map(c => c.border),
            borderWidth: 3,
            borderRadius: 12,
            hoverBackgroundColor: finalColors.map(c => c.hover)
          }]
        },
        options:{
          responsive:true,
          scales:{ 
            y:{ 
              suggestedMin:0, 
              suggestedMax:30, 
              ticks:{ 
                stepSize:5,
                color: '#718096',
                font: { size: 12, weight: '600' }
              },
              grid: {
                color: 'rgba(121, 134, 203, 0.1)',
                lineWidth: 1
              }
            },
            x: {
              ticks: {
                color: '#2d3748',
                font: { size: 11, weight: '700' }
              },
              grid: {
                display: false
              }
            }
          },
          plugins:{ 
            legend:{ display:false }, 
            tooltip:{ 
              intersect:false, 
              mode:"index",
              backgroundColor: 'rgba(45, 55, 72, 0.95)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(102, 187, 106, 0.5)',
              borderWidth: 2,
              padding: 12,
              cornerRadius: 8,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 13 },
              callbacks: {
                afterLabel: function(context) {
                  const key = numericKeys[context.dataIndex];
                  const score = +scores[key] || 0;
                  const max = maxScores[key];
                  const percentage = ((score / max) * 100).toFixed(1);
                  
                  let status = '';
                  if(percentage >= 90) status = 'โญ ููุชุงุฒ';
                  else if(percentage >= 80) status = 'โจ ุฌูุฏ ุฌุฏูุง';
                  else if(percentage >= 70) status = '๐ ุฌูุฏ';
                  else if(percentage >= 60) status = 'โ๏ธ ููุจูู';
                  else status = 'โ๏ธ ุจุญุงุฌุฉ ุฏุนู - ูุญุชุงุฌ ูุชุงุจุนุฉ!';
                  
                  return `${percentage}% - ${status}`;
                }
              }
            }
          }
        }
      });
      
      // ุฅุถุงูุฉ ุชูุจูู ุจุตุฑู ููุฏุฑุฌุงุช ุงูุถุนููุฉ (ุฃูู ูู 70%)
      const hasWeakScore = weakScores.some(w => w);
      if(hasWeakScore){
        const chartContainer = document.getElementById(canvasId).parentElement;
        let warningBadge = chartContainer.querySelector('.chart-warning-badge');
        if(!warningBadge){
          warningBadge = document.createElement('div');
          warningBadge.className = 'chart-warning-badge';
          warningBadge.innerHTML = 'โ๏ธ ููุฌุฏ ูุฌุงู ูุญุชุงุฌ ุฏุนู';
          warningBadge.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, rgba(244, 63, 94, 0.95) 0%, rgba(225, 29, 72, 0.95) 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(244, 63, 94, 0.4);
            animation: pulse-warning 2s infinite;
            z-index: 10;
          `;
          chartContainer.style.position = 'relative';
          chartContainer.appendChild(warningBadge);
          
          // ุฅุถุงูุฉ ุงูุฃููููุดู ุฅุฐุง ูู ููู ููุฌูุฏูุง
          if(!document.getElementById('chart-warning-animation')){
            const style = document.createElement('style');
            style.id = 'chart-warning-animation';
            style.textContent = `
              @keyframes pulse-warning {
                0%, 100% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.05); opacity: 0.9; }
              }
            `;
            document.head.appendChild(style);
          }
        }
      } else {
        // ุฅุฒุงูุฉ ุงูุชูุจูู ุฅุฐุง ูู ุชุนุฏ ููุงู ุฏุฑุฌุงุช ุถุนููุฉ
        const chartContainer = document.getElementById(canvasId).parentElement;
        const warningBadge = chartContainer.querySelector('.chart-warning-badge');
        if(warningBadge) warningBadge.remove();
      }
    }

    /* ================= ุฏูุงู ูุณุงุนุฏุฉ ูุนุฑุถ ุงูุฎุทุฉ ================= */
    function planChip(status){
      if(status==="good") return `<span class="plan-chip plan-good">ุชุญุณูู ูุงุถุญ โ</span>`;
      if(status==="need") return `<span class="plan-chip plan-need">ุจุญุงุฌุฉ ุฏุนู ๐ด</span>`;
      return `<span class="plan-chip plan-partial">ุชุญุณูู ุฌุฒุฆู โ๏ธ</span>`;
    }
    
    function daysUntil(dateStr){
      if(!dateStr) return null;
      const target = new Date(dateStr);
      if(isNaN(target)) return null;
      const today = new Date();
      target.setHours(0,0,0,0); 
      today.setHours(0,0,0,0);
      const diff = Math.round((target - today) / (1000*60*60*24));
      return diff;
    }

    function dueInfo(dateStr){
      const d = daysUntil(dateStr);
      if(d === null) return {label:"ูุง ููุฌุฏ ููุนุฏ", cls:"due-clear", d:null};
      if(d < 0) return {label:`ูุชุฃุฎุฑ ุจู ${Math.abs(d)} ููู`, cls:"due-overdue", d};
      if(d === 0) return {label:"ุงูููู", cls:"due-today", d};
      if(d <= 3) return {label:`ุฎูุงู ${d} ููู`, cls:"due-soon", d};
      return {label:`ุจุนุฏ ${d} ููู`, cls:"due-clear", d};
    }

    function renderDueCounters(){
      const cls = $("#classSelect").value || state.classes[0];
      const list = state.studentsByClass[cls] || [];
      let over=0, soon=0, today=0;

      list.forEach(st=>{
        const p = (st && st.plan) ? st.plan : null;
        if(!p || !p.nextReview) return;
        const info = dueInfo(p.nextReview);
        if(info.cls === "due-overdue") over++;
        else if(info.cls === "due-soon") soon++;
        else if(info.cls === "due-today") today++;
      });

      const byId = id => document.getElementById(id);
      if(byId("dueOver"))  byId("dueOver").textContent  = over;
      if(byId("dueSoon"))  byId("dueSoon").textContent  = soon;
      if(byId("dueToday")) byId("dueToday").textContent = today;
    }

    function renderPlanBox(containerId, st){
      const el = document.getElementById(containerId);
      if(!el) return;
      const p = ensurePlanObject(st);

      const hasAny = (p.problem || p.action || p.expected || p.duration || p.followup || p.nextReview || (p.impact&&p.impact>0));
      if(!hasAny){
        el.innerHTML = `<span class="muted">ูุง ุชูุฌุฏ ุฎุทุฉ ูุณุฌูุฉ ุจุนุฏ.</span>`;
        el.classList.add("muted");
        return;
      }

      const base = totalOf(st.scores);
      const adj  = adjustedTotal(st.scores, p);
      const info = dueInfo(p.nextReview);

      el.innerHTML = `
        <div style="display:grid; gap:10px">
          <div style="padding:10px;background:#fff;border-radius:8px;border-right:3px solid #1565c0"><strong style="color:#1565c0">ุงููุดููุฉ:</strong> <span style="color:#37474f">${p.problem||"-"}</span></div>
          <div style="padding:10px;background:#fff;border-radius:8px;border-right:3px solid #1565c0"><strong style="color:#1565c0">ุงูุฅุฌุฑุงุก:</strong> <span style="color:#37474f">${p.action||"-"}</span></div>
          <div style="padding:10px;background:#fff;border-radius:8px;border-right:3px solid #1565c0"><strong style="color:#1565c0">ุงููุฏุฉ:</strong> <span style="color:#37474f">${p.duration||"-"}</span></div>
          <div style="padding:10px;background:#fff;border-radius:8px;border-right:3px solid #1565c0"><strong style="color:#1565c0">ุงููุชูุฌุฉ ุงููุชููุนุฉ:</strong> <span style="color:#37474f">${p.expected||"-"}</span></div>
          ${p.followup ? `<div style="padding:10px;background:#fff;border-radius:8px;border-right:3px solid #1565c0"><strong style="color:#1565c0">ูุชุงุจุนุฉ:</strong> <span style="color:#37474f">${p.followup}</span></div>` : ''}
          ${p.nextReview ? `<div style="padding:10px;background:#fff;border-radius:8px;border-right:3px solid #1565c0"><strong style="color:#1565c0">ููุนุฏ ุงููุฑุงุฌุนุฉ:</strong> <span style="color:#37474f">${new Date(p.nextReview).toLocaleDateString('ar-SA')}</span></div>` : ''}
          ${p.impact>0 ? `<div style="padding:10px;background:#fff;border-radius:8px;border-right:3px solid #1565c0"><strong style="color:#1565c0">ุชุฃุซูุฑ ุงูุฎุทุฉ:</strong> <span style="color:#37474f">${Number(p.impact||0)}%</span></div>` : ''}
          <div style="padding:10px;background:#fff;border-radius:8px;text-align:center"><strong style="color:#1565c0">ุงูุญุงูุฉ:</strong> ${planChip(p.status||"partial")}</div>
          ${p.impact>0 ? `<div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
            <span class="plan-chip" style="background:#e3f2fd;color:#1565c0;border:2px solid #90caf9">ุงููุฌููุน ุงูุฃุตูู: ${base} / 100</span>
            <span class="plan-chip plan-good" style="font-weight:700">ุงููุฌููุน ุจุนุฏ ุงูุฎุทุฉ: ${adj} / 100</span>
            <span class="plan-chip" style="background:#e8f5e9;color:#2e7d32;border:2px solid #81c784;font-weight:700">${adjustedStatus(adj)}</span>
          </div>` : ''}
          <div style="margin-top:10px;text-align:center">
            <span class="due-chip ${info.cls}" style="font-weight:700;font-size:13px">๐ ููุนุฏ ุงููุฑุงุฌุนุฉ: ${info.label}</span>
          </div>
        </div>`;
      el.classList.remove("muted");
    }

    function tryRefreshStudentOrParentPlanIfVisible(st, cls){
      const sPanel = document.getElementById("studentPanel");
      const pPanel = document.getElementById("parentPanel");
      if(sPanel && !sPanel.classList.contains("hidden")){
        const currentName = document.getElementById("sName")?.textContent.trim();
        if(currentName === st.name){
          renderPlanBox("sPlanBox", st);
        }
      }
      if(pPanel && !pPanel.classList.contains("hidden")){
        const currentName = document.getElementById("pName")?.textContent.trim();
        if(currentName === st.name){
          renderPlanBox("pPlanBox", st);
        }
      }
    }

    /* ================= ููุญุฉ ุงูุทุงูุจุฉ ================= */
    function renderStudent(found, cls){
      $("#studentReport").classList.remove("hidden");
      $("#sName").textContent = found.name;
      $("#sClass").textContent = cls;
      const total = totalOf(found.scores);
      $("#sTotal").textContent = total;
      $("#sProgress").style.width = percentage(total).toFixed(1)+"%";

      // ุนุฑุถ ุงูุณุฌู ุงููุฏูู ูููุงุท ุงูุชููุฒ ูุงูููุฉ ูุงูุถุนู
      const nationalIdHTML = found.nationalId ? `
        <div class="row" style="align-items:center;margin:10px 0">
          <div class="pill info" style="min-width:220px;font-size:13px">ุงูุณุฌู ุงููุฏูู</div>
          <div class="pill" style="flex:1;font-weight:700;background:#e8eaf6;color:#5c6bc0">${found.nationalId}</div>
        </div>` : "";
      
      const excellenceHTML = `
        <div style="margin:20px 0;padding:32px;background:linear-gradient(135deg, #fef3c7 0%, #fbbf24 20%, #f59e0b 100%);border-radius:24px;border:4px solid #d97706;box-shadow:0 8px 32px rgba(217,119,6,0.4);position:relative;overflow:hidden">
          <div style="position:absolute;top:-30px;right:-30px;width:120px;height:120px;background:radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);border-radius:50%;animation:float 6s ease-in-out infinite"></div>
          <div style="position:absolute;bottom:-20px;left:-20px;width:80px;height:80px;background:radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);border-radius:50%;animation:float 4s ease-in-out infinite reverse"></div>
          
          <div style="display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:20px;position:relative;z-index:2">
            <div style="display:flex;align-items:center;gap:16px;padding:16px 24px;background:rgba(255,255,255,0.95);border-radius:20px;border:3px solid #f59e0b;box-shadow:0 6px 20px rgba(245,158,11,0.3)">
              <span style="font-size:36px;animation:sparkle 2s infinite">โญ</span>
              <h4 style="color:#92400e;font-size:20px;font-weight:800;margin:0;text-shadow:1px 1px 2px rgba(146,64,14,0.3)">ููุงุท ุงูุชููุฒ</h4>
              <span style="font-size:36px;animation:sparkle 2s infinite 0.5s">โจ</span>
            </div>
          </div>
          
          <div style="display:flex;align-items:center;justify-content:center;gap:24px;padding:28px;background:rgba(255,255,255,0.98);border-radius:20px;border:3px solid #f59e0b;box-shadow:0 8px 24px rgba(245,158,11,0.25);position:relative;z-index:2">
            <div style="position:relative">
              <span style="font-size:64px;filter:drop-shadow(0 4px 8px rgba(245,158,11,0.4));animation:bounce 3s infinite">๐</span>
              <div style="position:absolute;top:-8px;right:-8px;width:24px;height:24px;background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:700;animation:pulse 2s infinite">${found.excellencePoints||0}</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:56px;font-weight:800;color:#92400e;line-height:1;text-shadow:2px 2px 4px rgba(146,64,14,0.2);margin-bottom:8px">${found.excellencePoints||0}</div>
              <div style="font-size:16px;color:#92400e;font-weight:700;background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">ููุทุฉ ุชููุฒ</div>
            </div>
            <div style="position:relative">
              <span style="font-size:64px;filter:drop-shadow(0 4px 8px rgba(245,158,11,0.4));animation:bounce 3s infinite 1s">๐</span>
              <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.6) 50%, transparent 70%);animation:shine 3s infinite"></div>
            </div>
          </div>
          
          ${found.excellencePoints > 0 ? `
          <div style="margin-top:20px;text-align:center;position:relative;z-index:2">
            <div style="display:inline-flex;align-items:center;gap:12px;padding:12px 24px;background:rgba(16,185,129,0.95);color:white;border-radius:25px;font-size:15px;font-weight:700;box-shadow:0 4px 16px rgba(16,185,129,0.4);animation:glow 2s infinite alternate">
              <span style="font-size:20px">๐</span>
              <span>ุฃุญุณูุช! ุงุณุชูุฑู ูู ุงูุชููุฒ</span>
              <span style="font-size:20px">๐</span>
            </div>
          </div>` : ''}
        </div>
        <style>
          @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
          }
          @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
          }
          @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
          }
          @keyframes shine {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
          }
          @keyframes glow {
            0% { box-shadow: 0 4px 16px rgba(16,185,129,0.4); }
            100% { box-shadow: 0 6px 24px rgba(16,185,129,0.6); }
          }
          @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
          }
        </style>`;
      
      const strengthsHTML = (found.strengths && found.strengths.length > 0) ? `
        <div style="margin:20px 0;padding:28px;background:linear-gradient(135deg, #dcfce7 0%, #bbf7d0 50%, #86efac 100%);border-radius:20px;border:4px solid #22c55e;box-shadow:0 8px 32px rgba(34,197,94,0.3);position:relative;overflow:hidden">
          <div style="position:absolute;top:-20px;right:-20px;width:100px;height:100px;background:radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);border-radius:50%;animation:float 5s ease-in-out infinite"></div>
          
          <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px;position:relative;z-index:2">
            <div style="display:flex;align-items:center;gap:14px;padding:14px 28px;background:rgba(255,255,255,0.95);border-radius:18px;border:3px solid #22c55e;box-shadow:0 6px 20px rgba(34,197,94,0.25)">
              <span style="font-size:32px;animation:flex 2s infinite">๐ช</span>
              <h4 style="color:#15803d;font-size:19px;font-weight:800;margin:0;text-shadow:1px 1px 2px rgba(21,128,61,0.2)">ููุงุท ุงูููุฉ</h4>
              <span style="font-size:32px;animation:flex 2s infinite 0.5s">๐</span>
            </div>
          </div>
          
          <div style="display:flex;flex-wrap:wrap;gap:14px;justify-content:center;position:relative;z-index:2">
            ${found.strengths.map((s, index)=>`
              <div style="display:inline-flex;align-items:center;gap:12px;padding:14px 22px;background:linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);color:#15803d;border:3px solid #22c55e;border-radius:16px;font-size:15px;font-weight:700;box-shadow:0 6px 20px rgba(34,197,94,0.2);transition:all 0.3s ease;position:relative;overflow:hidden" onmouseover="this.style.transform='translateY(-4px) scale(1.05)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
                <div style="position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);animation:shimmer 3s infinite ${index * 0.5}s"></div>
                <span style="font-size:22px;filter:drop-shadow(0 2px 4px rgba(34,197,94,0.3));position:relative;z-index:2">โจ</span>
                <span style="position:relative;z-index:2">${s}</span>
                <div style="position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;animation:pulse 2s infinite">โญ</div>
              </div>
            `).join("")}
          </div>
          
          <div style="margin-top:20px;text-align:center;position:relative;z-index:2">
            <div style="display:inline-flex;align-items:center;gap:10px;padding:10px 20px;background:rgba(34,197,94,0.9);color:white;border-radius:20px;font-size:14px;font-weight:700;box-shadow:0 4px 16px rgba(34,197,94,0.4)">
              <span style="font-size:18px">๐ฏ</span>
              <span>ูุฐู ููุงุท ููุชู - ุงุณุชุซูุฑููุง!</span>
            </div>
          </div>
        </div>
        <style>
          @keyframes flex {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
          }
          @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
          }
        </style>` : "";
      
      const weaknessesHTML = (found.weaknesses && found.weaknesses.length > 0 && !found.weaknesses.every(w => w === "ูุง ููุฌุฏ")) ? `
        <div style="margin:20px 0;padding:28px;background:linear-gradient(135deg, #fef2f2 0%, #fecaca 50%, #fca5a5 100%);border-radius:20px;border:4px solid #ef4444;box-shadow:0 8px 32px rgba(239,68,68,0.3);position:relative;overflow:hidden">
          <div style="position:absolute;top:-20px;left:-20px;width:100px;height:100px;background:radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);border-radius:50%;animation:float 4s ease-in-out infinite reverse"></div>
          
          <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px;position:relative;z-index:2">
            <div style="display:flex;align-items:center;gap:14px;padding:14px 28px;background:rgba(255,255,255,0.95);border-radius:18px;border:3px solid #ef4444;box-shadow:0 6px 20px rgba(239,68,68,0.25)">
              <span style="font-size:32px;animation:attention 2s infinite">โ๏ธ</span>
              <h4 style="color:#dc2626;font-size:19px;font-weight:800;margin:0;text-shadow:1px 1px 2px rgba(220,38,38,0.2)">ููุงุท ุชุญุชุงุฌ ุชุทููุฑ</h4>
              <span style="font-size:32px;animation:attention 2s infinite 0.5s">๐ฏ</span>
            </div>
          </div>
          
          <div style="display:flex;flex-wrap:wrap;gap:14px;justify-content:center;position:relative;z-index:2">
            ${found.weaknesses.filter(w => w !== "ูุง ููุฌุฏ").map((w, index)=>`
              <div style="display:inline-flex;align-items:center;gap:12px;padding:14px 22px;background:linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);color:#dc2626;border:3px solid #ef4444;border-radius:16px;font-size:15px;font-weight:700;box-shadow:0 6px 20px rgba(239,68,68,0.2);transition:all 0.3s ease;position:relative;overflow:hidden" onmouseover="this.style.transform='translateY(-4px) scale(1.05)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
                <div style="position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);animation:shimmer 3s infinite ${index * 0.7}s"></div>
                <span style="font-size:22px;filter:drop-shadow(0 2px 4px rgba(239,68,68,0.3));position:relative;z-index:2">๐ง</span>
                <span style="position:relative;z-index:2">${w}</span>
                <div style="position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;animation:pulse 2s infinite">๐ก</div>
              </div>
            `).join("")}
          </div>
          
          <div style="margin-top:20px;text-align:center;position:relative;z-index:2">
            <div style="display:inline-flex;align-items:center;gap:10px;padding:10px 20px;background:rgba(59,130,246,0.9);color:white;border-radius:20px;font-size:14px;font-weight:700;box-shadow:0 4px 16px rgba(59,130,246,0.4)">
              <span style="font-size:18px">๐ช</span>
              <span>ูุฑุต ููููู ูุงูุชุทููุฑ - ููููู ุชุญุณูููุง!</span>
            </div>
          </div>
        </div>
        <style>
          @keyframes attention {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
          }
        </style>` : "";

      $("#sDetails").innerHTML = nationalIdHTML + excellenceHTML + strengthsHTML + weaknessesHTML + Object.entries(HEADERS).map(([k,label])=>{
        if(k === "collaboration"){
          return `
            <div class="row" style="align-items:center;margin:10px 0">
              <div class="pill info" style="min-width:220px;font-size:13px">${label}</div>
              <div class="pill success" style="flex:1;font-weight:700">${found.scores[k]||"ููุชุงุฒ"}</div>
            </div>`;
        } else if(k === "attendance"){
          return `
            <div class="row" style="align-items:center;margin:10px 0">
              <div class="pill info" style="min-width:220px;font-size:13px">${label}</div>
              <div class="pill warning" style="flex:1;font-weight:700">${found.scores[k]||0}%</div>
            </div>`;
        } else {
          return `
            <div class="row" style="align-items:center;margin:10px 0">
              <div class="pill info" style="min-width:220px;font-size:13px">${label}</div>
              <div class="progress" style="flex:1;height:16px"><span style="width:${(found.scores[k]||0)*3.33}%"></span></div>
              <div class="pill" style="min-width:80px;font-weight:700;font-size:15px">${found.scores[k]||0}</div>
            </div>`;
        }
      }).join("");

      // ุฅูุฌุงุฏ ุฃุถุนู ูุฌุงู (ูู ุงููุฌุงูุงุช ุงูุฑูููุฉ ููุท)
      const numericKeys = ["exams","practical","homework","discussion"];
      const minKey = numericKeys.reduce((m,k)=> (found.scores[k]||0) < (found.scores[m]||0) ? k : m, numericKeys[0]);
      const tips = {
        exams:"ุฑุงุฌุนู ุจูู ุงูุฃุณุฆูุฉ ูุทุจููู ููุงุฐุฌ ุณุงุจูุฉ.",
        practical:"ุฃูุซุฑู ูู ุงูุชุฏุฑูุจ ุงูุนููู ุงููุตุบูุฑ ูุจู ุงูุชุณููู.",
        homework:"ุงูุชุฒูู ุจุงูููุงุนูุฏ ูุฑุงุฌุนู ุงููุนุงููุฑ.",
        discussion:"ุดุงุฑูู ุจุณุคุงู ุฃู ุชูุฎูุต ูู ูู ุญุตุฉ."
      };
      $("#sTip").textContent = `ุฑููุฒู ุนูู: ${HEADERS[minKey]} โ ${tips[minKey]}`;
      
      // ุงูุฑุณู ุงูุจูุงูู ูุนุฑุถ ููุท ุงููุฌุงูุงุช ุงูุฑูููุฉ
      const chartScores = {
        exams: found.scores.exams||0,
        practical: found.scores.practical||0,
        homework: found.scores.homework||0,
        discussion: found.scores.discussion||0
      };
      renderChart("studentChart", chartScores, "ุฃุฏุงุฆู ุงูุชูุตููู");
      
      // ุฅุถุงูุฉ ูุฑุจุน ุงูุชููุฆุฉ ุจุนุฏ ุงูุฑุณู ุงูุจูุงูู ููุทุงูุจุงุช ุงููุชูููุงุช (95 ูุฃูุซุฑ)
      if(total >= 95) {
        const chartContainer = document.getElementById("studentChart").parentElement;
        let congratulationsDiv = chartContainer.querySelector('.student-congratulations');
        if(!congratulationsDiv) {
          congratulationsDiv = document.createElement('div');
          congratulationsDiv.className = 'student-congratulations';
          congratulationsDiv.innerHTML = `
            <div style="margin:20px 0;padding:28px;background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);border-radius:20px;border:4px solid #f59e0b;box-shadow:0 8px 25px rgba(245,158,11,0.4);position:relative;overflow:hidden">
              <div style="position:absolute;top:-20px;right:-20px;font-size:120px;opacity:0.1;transform:rotate(15deg)">๐</div>
              <div style="position:absolute;bottom:-20px;left:-20px;font-size:100px;opacity:0.1;transform:rotate(-15deg)">โญ</div>
              
              <div style="text-align:center;position:relative;z-index:2">
                <div style="font-size:48px;margin-bottom:16px;animation:celebration 3s infinite">๐</div>
                <h3 style="color:#92400e;font-size:24px;font-weight:700;margin-bottom:16px;text-shadow:2px 2px 4px rgba(146,64,14,0.3)">
                  ูุจุฑูู ุงูุชููู! ๐
                </h3>
                <div style="background:#ffffff;border-radius:16px;padding:20px;margin:16px 0;border:3px solid #f59e0b;box-shadow:0 4px 15px rgba(245,158,11,0.2)">
                  <p style="color:#92400e;font-size:18px;font-weight:700;margin-bottom:12px;line-height:1.6">
                    ุนุฒูุฒุชู ${found.name}
                  </p>
                  <p style="color:#374151;font-size:16px;line-height:1.8;margin-bottom:16px">
                    ุชูุงูููุง ูู ุนูู ูุฐุง ุงูุชููู ุงููููุฒ! ๐<br>
                    ุญุตููู ุนูู <strong style="color:#f59e0b">${total} ุฏุฑุฌุฉ</strong> ูุนูุณ ุงุฌุชูุงุฏู ูุชููุฒู<br>
                    ููุฎุฑ ุจู ููุชููู ูู ุงููุฒูุฏ ูู ุงูุชูุฏู ูุงููุฌุงุญ
                  </p>
                  <div style="display:flex;justify-content:center;gap:16px;flex-wrap:wrap;margin-top:16px">
                    <span style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:#ffffff;border-radius:25px;font-size:14px;font-weight:700;box-shadow:0 4px 12px rgba(245,158,11,0.3);animation:pulse 2s infinite">
                      <span style="font-size:20px">๐</span>
                      ุทุงูุจุฉ ูุชูููุฉ
                    </span>
                    <span style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:#ffffff;border-radius:25px;font-size:14px;font-weight:700;box-shadow:0 4px 12px rgba(16,185,129,0.3);animation:pulse 2s infinite 0.5s">
                      <span style="font-size:20px">โญ</span>
                      ูุซุงู ููุญุชุฐู ุจู
                    </span>
                  </div>
                </div>
                <p style="color:#92400e;font-size:14px;font-weight:600;font-style:italic;margin-top:16px">
                  "ุงููุฌุงุญ ููุณ ููุงูุฉ ุงููุทุงูุ ูุงููุดู ููุณ ูุงุชูุงูุ ุฅููุง ุงูุดุฌุงุนุฉ ูููุชุงุจุนุฉ ูู ุงูุชู ุชูู" ๐ช
                </p>
              </div>
            </div>
            <style>
              @keyframes celebration {
                0%, 100% { transform: scale(1) rotate(0deg); }
                25% { transform: scale(1.1) rotate(-5deg); }
                50% { transform: scale(1.2) rotate(5deg); }
                75% { transform: scale(1.1) rotate(-3deg); }
              }
              @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
              }
            </style>
          `;
          chartContainer.appendChild(congratulationsDiv);
        }
      } else {
        // ุฅุฒุงูุฉ ุงูุชููุฆุฉ ุฅุฐุง ูู ุชุนุฏ ุงูุทุงูุจุฉ ูุชูููุฉ
        const chartContainer = document.getElementById("studentChart").parentElement;
        const congratulationsDiv = chartContainer.querySelector('.student-congratulations');
        if(congratulationsDiv) congratulationsDiv.remove();
      }
      
      // ุนุฑุถ ุฎุทุฉ ุฑูุน ุงููุณุชูู ุจุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงููุญุณููุฉ
      ensurePlanObject(found);
      renderPlanBox("sPlanBox", found);
      
      // ุชูุฑูุบ ุงูุญููู ุนูุฏ ูุชุญ ุงูููุญุฉ
      $("#studentTrait").value = "";
      $("#studentSkill").value = "";
      $("#studentStrategy").value = "";
      $("#studentAdditionalStrategy").value = "";
      $("#studentAdditionalStrategyDetail").value = "";
      $("#studentAdditionalStrategyText").classList.add("hidden");
      $("#studentAwareness").value = "";
      $("#studentSatisfaction").value = "";
    }

    /* ================= ุฅุธูุงุฑ/ุฅุฎูุงุก ูุฑุจุน ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุฅุถุงููุฉ ================= */
    $("#studentAdditionalStrategy").addEventListener("change", (e)=>{
      const textField = $("#studentAdditionalStrategyText");
      if(e.target.value === "ูุนู"){
        textField.classList.remove("hidden");
      } else {
        textField.classList.add("hidden");
        $("#studentAdditionalStrategyDetail").value = "";
      }
    });

    $("#parentAdditionalStrategy").addEventListener("change", (e)=>{
      const textField = $("#parentAdditionalStrategyText");
      if(e.target.value === "ูุนู"){
        textField.classList.remove("hidden");
      } else {
        textField.classList.add("hidden");
        $("#parentAdditionalStrategyDetail").value = "";
      }
    });

    /* ================= ุฅุฑุณุงู ูููุฐุฌ ุงูุทุงูุจุฉ ================= */
    $("#submitStudentFeedback").onclick = ()=>{
      const name = $("#sName").textContent.trim();
      const cls = $("#sClass").textContent.trim();
      const trait = $("#studentTrait").value.trim();
      const skill = $("#studentSkill").value.trim();
      const strategy = $("#studentStrategy").value.trim();
      const awareness = $("#studentAwareness").value;
      const satisfaction = $("#studentSatisfaction").value;
      const additionalStrategy = $("#studentAdditionalStrategy").value;
      const additionalStrategyDetail = $("#studentAdditionalStrategyDetail").value.trim();

      if(!trait || !skill || !strategy || !awareness || !satisfaction || !additionalStrategy){
        showToast("โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู");
        return;
      }

      if(additionalStrategy === "ูุนู" && !additionalStrategyDetail){
        showToast("โ๏ธ ูุฑุฌู ูุชุงุจุฉ ุงูุทุฑููุฉ ุงูุฅุถุงููุฉ");
        return;
      }

      // ุญูุธ ุงูุจูุงูุงุช ูู localStorage
      const feedbackKey = `student_feedback_${normalizeName(name)}_${cls}`;
      const feedbackData = {
        studentName: name,
        class: cls,
        trait,
        skill,
        strategy,
        awareness,
        satisfaction,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem(feedbackKey, JSON.stringify(feedbackData));

      // ุฑุณุงูุฉ ูุงุชุณุงุจ ูููุนููุฉ
      let msg = `๐ ุงุณุชุจูุงู ุงูุทุงูุจุฉ\n\nุงูุทุงูุจุฉ: ${name}\nุงููุตู: ${cls}\n\nโจ ุตูุฉ ุฃุชุญูู ุจูุง: ${trait}\n๐ฏ ููุงุฑุฉ ุฃุชููุฒ ุจูุง: ${skill}\n๐ก ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุนูู ุงูููุถูุฉ: ${strategy}\n\n๐ ุทุฑููุฉ ุฅุถุงููุฉ ุจุนุฏ ุงูุฎุทุฉ ุงูุนูุงุฌูุฉ/ุงูุฅุซุฑุงุฆูุฉ: ${additionalStrategy}`;
      
      if(additionalStrategy === "ูุนู"){
        msg += `\nโ๏ธ ุงูุทุฑููุฉ ุงูุฅุถุงููุฉ: ${additionalStrategyDetail}`;
      }
      
      msg += `\n\n๐ ุงูุงุณุชุจูุงู:\nโข ูู ุฃูุฎุจุฑ ููู ุฃูุฑู ุจุชุญุตูููุ ${awareness}\nโข ูุฏู ุงูุฑุถุง ุนู ุงููุชุงุจุนุฉ: ${satisfaction}`;
      
      // ูุชุญ ุงููุงุชุณุงุจ ูุจุงุดุฑุฉ
      openWhatsApp(TEACHER_WHATSAPP, msg);
      showToast("โ ุชู ุฅุฑุณุงู ุงูุงุณุชุจูุงู ูููุนููุฉ");
      
      // ุชูุฑูุบ ุงูุญููู ุจุนุฏ ุงูุฅุฑุณุงู
      $("#studentTrait").value = "";
      $("#studentSkill").value = "";
      $("#studentStrategy").value = "";
      $("#studentAdditionalStrategy").value = "";
      $("#studentAdditionalStrategyDetail").value = "";
      $("#studentAdditionalStrategyText").classList.add("hidden");
      $("#studentAwareness").value = "";
      $("#studentSatisfaction").value = "";
    };

    /* ================= ุฒุฑ ุงูุชูุงุตู ูุน ุงููุนููุฉ - ุงูุทุงูุจุฉ ================= */
    $("#contactTeacherStudent").onclick = ()=>{
      const name = $("#sName").textContent.trim();
      const cls = $("#sClass").textContent.trim();
      const total = $("#sTotal").textContent.trim();

      // ุชุณุฌูู ุชูุงุนู ุฅุถุงูู ููุชูุงุตู
      recordFamilyInteraction(name, cls, 'contact_teacher');

      const msg = `ุงูุณูุงู ุนูููู ุฃุณุชุงุฐุชูุ ุฃูุง ุงูุทุงูุจุฉ: ${name} (ูุตู: ${cls}) | ุงููุฌููุน: ${total}/100. ุฃูุฏ ุงูุงุณุชูุณุงุฑ ุนู ุฃุฏุงุฆู ูู ุงููุงุฏุฉ.`;
      
      // ูุชุญ ุงููุงุชุณุงุจ ูุจุงุดุฑุฉ
      openWhatsApp(TEACHER_WHATSAPP, msg);
    };

    /* ================= ููุญุฉ ููู ุงูุฃูุฑ ================= */
    function renderParent(found, cls){
      $("#parentReport").classList.remove("hidden");
      $("#pName").textContent = found.name;
      $("#pClass").textContent = cls;
      const total = totalOf(found.scores);
      const status = total>=90 ? "ููุชุงุฒ" : total>=80 ? "ุฌูุฏ ุฌุฏุง" : total>=70 ? "ุฌูุฏ" : total>=60 ? "ููุจูู" : "ุจุญุงุฌุฉ ุฅูู ูุชุงุจุนุฉ ูู ุงูุฃูู";
      const att = found.scores.attendance||0;
      const collab = found.scores.collaboration||"ููุชุงุฒ";
      
      const nationalIdHTML = found.nationalId ? `
        <div class="row" style="margin:12px 0;gap:12px">
          <div class="pill info" style="flex:1;font-size:13px">ุงูุณุฌู ุงููุฏูู</div>
          <div class="pill" style="font-weight:700;background:#e8eaf6;color:#5c6bc0">${found.nationalId}</div>
        </div>` : "";
      
      const excellenceHTML = `
        <div style="margin:16px 0;padding:24px;background:linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);border-radius:18px;border:3px solid #ffc107;box-shadow:0 4px 15px rgba(255,193,7,0.25)">
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:14px;border-bottom:3px solid #ffb300;padding-bottom:12px">
            <span style="font-size:32px;animation:pulse 2s infinite">โญ</span>
            <h4 style="color:#f57c00;font-size:18px;font-weight:700;margin:0">ููุงุท ุงูุชููุฒ</h4>
          </div>
          <div style="display:flex;align-items:center;justify-content:center;gap:16px;padding:20px;background:#ffffff;border-radius:14px;border:2px solid #ffca28;box-shadow:0 3px 12px rgba(255,193,7,0.15)">
            <span style="font-size:48px">๐</span>
            <div style="text-align:center">
              <div style="font-size:42px;font-weight:700;color:#f57c00;line-height:1">${found.excellencePoints||0}</div>
              <div style="font-size:13px;color:#e65100;font-weight:600;margin-top:4px">ููุทุฉ ุชููุฒ</div>
            </div>
            <span style="font-size:48px">โจ</span>
          </div>
        </div>`;
      
      const strengthsHTML = (found.strengths && found.strengths.length > 0) ? `
        <div style="margin:20px 0;padding:28px;background:linear-gradient(135deg, #dcfce7 0%, #bbf7d0 50%, #86efac 100%);border-radius:20px;border:4px solid #22c55e;box-shadow:0 8px 32px rgba(34,197,94,0.3);position:relative;overflow:hidden">
          <div style="position:absolute;top:-20px;right:-20px;width:100px;height:100px;background:radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);border-radius:50%;animation:float 5s ease-in-out infinite"></div>
          
          <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px;position:relative;z-index:2">
            <div style="display:flex;align-items:center;gap:14px;padding:14px 28px;background:rgba(255,255,255,0.95);border-radius:18px;border:3px solid #22c55e;box-shadow:0 6px 20px rgba(34,197,94,0.25)">
              <span style="font-size:32px;animation:flex 2s infinite">๐ช</span>
              <h4 style="color:#15803d;font-size:19px;font-weight:800;margin:0;text-shadow:1px 1px 2px rgba(21,128,61,0.2)">ููุงุท ุงูููุฉ</h4>
              <span style="font-size:32px;animation:flex 2s infinite 0.5s">๐</span>
            </div>
          </div>
          
          <div style="display:flex;flex-wrap:wrap;gap:14px;justify-content:center;position:relative;z-index:2">
            ${found.strengths.map((s, index)=>`
              <div style="display:inline-flex;align-items:center;gap:12px;padding:14px 22px;background:linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);color:#15803d;border:3px solid #22c55e;border-radius:16px;font-size:15px;font-weight:700;box-shadow:0 6px 20px rgba(34,197,94,0.2);transition:all 0.3s ease;position:relative;overflow:hidden" onmouseover="this.style.transform='translateY(-4px) scale(1.05)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
                <div style="position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);animation:shimmer 3s infinite ${index * 0.5}s"></div>
                <span style="font-size:22px;filter:drop-shadow(0 2px 4px rgba(34,197,94,0.3));position:relative;z-index:2">โจ</span>
                <span style="position:relative;z-index:2">${s}</span>
                <div style="position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;animation:pulse 2s infinite">โญ</div>
              </div>
            `).join("")}
          </div>
          
          <div style="margin-top:20px;text-align:center;position:relative;z-index:2">
            <div style="display:inline-flex;align-items:center;gap:10px;padding:10px 20px;background:rgba(34,197,94,0.9);color:white;border-radius:20px;font-size:14px;font-weight:700;box-shadow:0 4px 16px rgba(34,197,94,0.4)">
              <span style="font-size:18px">๐ฏ</span>
              <span>ูุฐู ููุงุท ููุชู - ุงุณุชุซูุฑููุง!</span>
            </div>
          </div>
        </div>
        <style>
          @keyframes flex {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
          }
          @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
          }
        </style>` : "";
      
      const weaknessesHTML = (found.weaknesses && found.weaknesses.length > 0 && !found.weaknesses.every(w => w === "ูุง ููุฌุฏ")) ? `
        <div style="margin:20px 0;padding:28px;background:linear-gradient(135deg, #fef2f2 0%, #fecaca 50%, #fca5a5 100%);border-radius:20px;border:4px solid #ef4444;box-shadow:0 8px 32px rgba(239,68,68,0.3);position:relative;overflow:hidden">
          <div style="position:absolute;top:-20px;left:-20px;width:100px;height:100px;background:radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);border-radius:50%;animation:float 4s ease-in-out infinite reverse"></div>
          
          <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px;position:relative;z-index:2">
            <div style="display:flex;align-items:center;gap:14px;padding:14px 28px;background:rgba(255,255,255,0.95);border-radius:18px;border:3px solid #ef4444;box-shadow:0 6px 20px rgba(239,68,68,0.25)">
              <span style="font-size:32px;animation:attention 2s infinite">โ๏ธ</span>
              <h4 style="color:#dc2626;font-size:19px;font-weight:800;margin:0;text-shadow:1px 1px 2px rgba(220,38,38,0.2)">ููุงุท ุชุญุชุงุฌ ุชุทููุฑ</h4>
              <span style="font-size:32px;animation:attention 2s infinite 0.5s">๐ฏ</span>
            </div>
          </div>
          
          <div style="display:flex;flex-wrap:wrap;gap:14px;justify-content:center;position:relative;z-index:2">
            ${found.weaknesses.filter(w => w !== "ูุง ููุฌุฏ").map((w, index)=>`
              <div style="display:inline-flex;align-items:center;gap:12px;padding:14px 22px;background:linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);color:#dc2626;border:3px solid #ef4444;border-radius:16px;font-size:15px;font-weight:700;box-shadow:0 6px 20px rgba(239,68,68,0.2);transition:all 0.3s ease;position:relative;overflow:hidden" onmouseover="this.style.transform='translateY(-4px) scale(1.05)'" onmouseout="this.style.transform='translateY(0) scale(1)'">
                <div style="position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);animation:shimmer 3s infinite ${index * 0.7}s"></div>
                <span style="font-size:22px;filter:drop-shadow(0 2px 4px rgba(239,68,68,0.3));position:relative;z-index:2">๐ง</span>
                <span style="position:relative;z-index:2">${w}</span>
                <div style="position:absolute;top:-4px;right:-4px;width:16px;height:16px;background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;animation:pulse 2s infinite">๐ก</div>
              </div>
            `).join("")}
          </div>
          
          <div style="margin-top:20px;text-align:center;position:relative;z-index:2">
            <div style="display:inline-flex;align-items:center;gap:10px;padding:10px 20px;background:rgba(59,130,246,0.9);color:white;border-radius:20px;font-size:14px;font-weight:700;box-shadow:0 4px 16px rgba(59,130,246,0.4)">
              <span style="font-size:18px">๐ช</span>
              <span>ูุฑุต ููููู ูุงูุชุทููุฑ - ููููู ุชุญุณูููุง!</span>
            </div>
          </div>
        </div>
        <style>
          @keyframes attention {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
          }
        </style>` : "";
      
      $("#pSummary").innerHTML = nationalIdHTML + `
        <div class="row" style="margin:12px 0;gap:12px">
          <div class="pill info" style="flex:1;font-size:13px">ุงููุฌููุน ุงูููู</div>
          <div class="pill" style="font-weight:700;font-size:16px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:#fff;border:none"><strong>${total}</strong> / 100</div>
        </div>
        <div class="row" style="margin:12px 0;gap:12px">
          <div class="pill info" style="flex:1;font-size:13px">ุงูุญุงูุฉ</div>
          <div class="pill success" style="font-weight:700">${status}</div>
        </div>
        ` + excellenceHTML + strengthsHTML + weaknessesHTML + `
        <div class="row" style="margin:12px 0;gap:12px">
          <div class="pill info" style="flex:1;font-size:13px">ุงูุชุนุงูู</div>
          <div class="pill success" style="font-weight:700">${collab}</div>
        </div>
        <div class="row" style="margin:12px 0;gap:12px">
          <div class="pill info" style="flex:1;font-size:13px">ุงูุญุถูุฑ</div>
          <div class="pill warning" style="font-weight:700;font-size:15px"><strong>${att}%</strong></div>
        </div>
        <p class="muted" style="margin-top:16px;font-size:13px;text-align:center;color:#718096">๐ ุงูุฑุณู ููุถุญ ุชูุฒูุน ุงูุฃุฏุงุก ุนุจุฑ ุงูุฃุฏูุงุช ุงูุชูููููุฉ</p>
      `;
      
      // ุงูุฑุณู ุงูุจูุงูู ูุนุฑุถ ููุท ุงููุฌุงูุงุช ุงูุฑูููุฉ
      const chartScores = {
        exams: found.scores.exams||0,
        practical: found.scores.practical||0,
        homework: found.scores.homework||0,
        discussion: found.scores.discussion||0
      };
      renderChart("parentChart", chartScores, "ููู ุงูุฃุฏุงุก ูููููู");
      
      // ุฅุถุงูุฉ ูุฑุจุน ุงูุชููุฆุฉ ุจุนุฏ ุงูุฑุณู ุงูุจูุงูู ูุฃูููุงุก ุงูุฃููุฑ ููุทุงูุจุงุช ุงููุชูููุงุช (95 ูุฃูุซุฑ)
      if(total >= 95) {
        const chartContainer = document.getElementById("parentChart").parentElement;
        let congratulationsDiv = chartContainer.querySelector('.parent-congratulations');
        if(!congratulationsDiv) {
          congratulationsDiv = document.createElement('div');
          congratulationsDiv.className = 'parent-congratulations';
          congratulationsDiv.innerHTML = `
            <div style="margin:20px 0;padding:28px;background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);border-radius:20px;border:4px solid #4caf50;box-shadow:0 8px 25px rgba(76,175,80,0.4);position:relative;overflow:hidden">
              <div style="position:absolute;top:-20px;right:-20px;font-size:120px;opacity:0.1;transform:rotate(15deg)">๐จโ๐ฉโ๐ง</div>
              <div style="position:absolute;bottom:-20px;left:-20px;font-size:100px;opacity:0.1;transform:rotate(-15deg)">๐</div>
              
              <div style="text-align:center;position:relative;z-index:2">
                <div style="font-size:48px;margin-bottom:16px;animation:celebration 3s infinite">๐</div>
                <h3 style="color:#2e7d32;font-size:24px;font-weight:700;margin-bottom:16px;text-shadow:2px 2px 4px rgba(46,125,50,0.3)">
                  ูุจุฑูู ููู ุชููู ุงุจูุชูู! ๐
                </h3>
                <div style="background:#ffffff;border-radius:16px;padding:20px;margin:16px 0;border:3px solid #4caf50;box-shadow:0 4px 15px rgba(76,175,80,0.2)">
                  <p style="color:#2e7d32;font-size:18px;font-weight:700;margin-bottom:12px;line-height:1.6">
                    ุฃูููุงุก ุฃููุฑ ุงูุทุงูุจุฉ ${found.name} ุงููุฑุงู
                  </p>
                  <p style="color:#374151;font-size:16px;line-height:1.8;margin-bottom:16px">
                    ุชูุงูููุง ููู ุนูู ุชููู ุงุจูุชูู ุงููููุฒ! ๐<br>
                    ุญุตูููุง ุนูู <strong style="color:#4caf50">${total} ุฏุฑุฌุฉ</strong> ุซูุฑุฉ ุชุฑุจูุชูู ุงูุญุณูุฉ ููุชุงุจุนุชูู ุงููุณุชูุฑุฉ<br>
                    ูุดูุฑูู ุนูู ุฏุนููู ูุซูุชููุ ูููุฎุฑ ุจูุฐุง ุงูุชุนุงูู ุงููุซูุฑ
                  </p>
                  <div style="display:flex;justify-content:center;gap:16px;flex-wrap:wrap;margin-top:16px">
                    <span style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg, #4caf50 0%, #388e3c 100%);color:#ffffff;border-radius:25px;font-size:14px;font-weight:700;box-shadow:0 4px 12px rgba(76,175,80,0.3);animation:pulse 2s infinite">
                      <span style="font-size:20px">๐จโ๐ฉโ๐ง</span>
                      ุฃุณุฑุฉ ูุชููุฒุฉ
                    </span>
                    <span style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg, #ff9800 0%, #f57c00 100%);color:#ffffff;border-radius:25px;font-size:14px;font-weight:700;box-shadow:0 4px 12px rgba(255,152,0,0.3);animation:pulse 2s infinite 0.5s">
                      <span style="font-size:20px">๐</span>
                      ุดุฑุงูุฉ ูุงุฌุญุฉ
                    </span>
                  </div>
                </div>
                <p style="color:#2e7d32;font-size:14px;font-weight:600;font-style:italic;margin-top:16px">
                  "ูุฑุงุก ูู ุทุงูุจุฉ ูุชูููุฉ ุฃุณุฑุฉ ุฏุงุนูุฉ ููุชุงุจุนุฉ" ๐
                </p>
              </div>
            </div>
            <style>
              @keyframes celebration {
                0%, 100% { transform: scale(1) rotate(0deg); }
                25% { transform: scale(1.1) rotate(-5deg); }
                50% { transform: scale(1.2) rotate(5deg); }
                75% { transform: scale(1.1) rotate(-3deg); }
              }
              @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
              }
            </style>
          `;
          chartContainer.appendChild(congratulationsDiv);
        }
      } else {
        // ุฅุฒุงูุฉ ุงูุชููุฆุฉ ุฅุฐุง ูู ุชุนุฏ ุงูุทุงูุจุฉ ูุชูููุฉ
        const chartContainer = document.getElementById("parentChart").parentElement;
        const congratulationsDiv = chartContainer.querySelector('.parent-congratulations');
        if(congratulationsDiv) congratulationsDiv.remove();
      }
      
      // ุนุฑุถ ุฎุทุฉ ุฑูุน ุงููุณุชูู ุจุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงููุญุณููุฉ
      ensurePlanObject(found);
      renderPlanBox("pPlanBox", found);
      
      // ุชูุฑูุบ ุงูุญููู ุนูุฏ ูุชุญ ุงูููุญุฉ
      $("#parentTrait").value = "";
      $("#parentSkill").value = "";
      $("#parentStrategy").value = "";
      $("#parentAdditionalStrategy").value = "";
      $("#parentAdditionalStrategyDetail").value = "";
      $("#parentAdditionalStrategyText").classList.add("hidden");
      $("#parentAwareness").value = "";
      $("#parentSatisfaction").value = "";
    }

    /* ================= ุฅุฑุณุงู ูููุฐุฌ ููู ุงูุฃูุฑ ================= */
    $("#submitParentFeedback").onclick = ()=>{
      const name = $("#pName").textContent.trim();
      const cls = $("#pClass").textContent.trim();
      const trait = $("#parentTrait").value.trim();
      const skill = $("#parentSkill").value.trim();
      const strategy = $("#parentStrategy").value.trim();
      const awareness = $("#parentAwareness").value;
      const satisfaction = $("#parentSatisfaction").value;
      const additionalStrategy = $("#parentAdditionalStrategy").value;
      const additionalStrategyDetail = $("#parentAdditionalStrategyDetail").value.trim();

      if(!trait || !skill || !strategy || !awareness || !satisfaction || !additionalStrategy){
        showToast("โ๏ธ ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู");
        return;
      }

      if(additionalStrategy === "ูุนู" && !additionalStrategyDetail){
        showToast("โ๏ธ ูุฑุฌู ูุชุงุจุฉ ุงูุทุฑููุฉ ุงูุฅุถุงููุฉ");
        return;
      }

      // ุญูุธ ุงูุจูุงูุงุช ูู localStorage
      const feedbackKey = `feedback_${normalizeName(name)}_${cls}`;
      const feedbackData = {
        studentName: name,
        class: cls,
        trait,
        skill,
        strategy,
        awareness,
        satisfaction,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem(feedbackKey, JSON.stringify(feedbackData));

      // ุฑุณุงูุฉ ูุงุชุณุงุจ ูููุนููุฉ
      let msg = `๐ ุงุณุชุจูุงู ููู ุฃูุฑ\n\nุงูุทุงูุจุฉ: ${name}\nุงููุตู: ${cls}\n\nโจ ุตูุฉ ุชุชุญูู ุจูุง: ${trait}\n๐ฏ ููุงุฑุฉ ุชุชููุฒ ุจูุง: ${skill}\n๐ก ุงุณุชุฑุงุชูุฌูุฉ ุงูุชุนูู ุงูููุถูุฉ: ${strategy}\n\n๐ ุทุฑููุฉ ุฅุถุงููุฉ ุจุนุฏ ุงูุฎุทุฉ ุงูุนูุงุฌูุฉ/ุงูุฅุซุฑุงุฆูุฉ: ${additionalStrategy}`;
      
      if(additionalStrategy === "ูุนู"){
        msg += `\nโ๏ธ ุงูุทุฑููุฉ ุงูุฅุถุงููุฉ: ${additionalStrategyDetail}`;
      }
      
      msg += `\n\n๐ ุงูุงุณุชุจูุงู:\nโข ูู ุชูุทูุนูู ุจุชุญุตูููุงุ ${awareness}\nโข ูุฏู ุงูุฑุถุง ุนู ุงููุชุงุจุนุฉ: ${satisfaction}`;
      
      // ูุชุญ ุงููุงุชุณุงุจ ูุจุงุดุฑุฉ
      openWhatsApp(TEACHER_WHATSAPP, msg);
      showToast("โ ุชู ุฅุฑุณุงู ุงูุงุณุชุจูุงู ูููุนููุฉ");
      
      // ุชูุฑูุบ ุงูุญููู ุจุนุฏ ุงูุฅุฑุณุงู
      $("#parentTrait").value = "";
      $("#parentSkill").value = "";
      $("#parentStrategy").value = "";
      $("#parentAdditionalStrategy").value = "";
      $("#parentAdditionalStrategyDetail").value = "";
      $("#parentAdditionalStrategyText").classList.add("hidden");
      $("#parentAwareness").value = "";
      $("#parentSatisfaction").value = "";
    };

    /* ================= ูุงุชุณุงุจ - ุงูุชูุงุตู ูุน ุงููุนููุฉ ================= */
    const TEACHER_WHATSAPP = "+966555320501"; // ุนุฏููู ุงูุฑูู ุญุณุจ ุงูุญุงุฌุฉ
    
    function sanitizePhone(p){ return (p||"").replace(/[^\d]/g,""); }

    // ููุชุญ ูุงุชุณุงุจ ูุน ุจุฏุงุฆู ุชููุงุฆูุฉ
    function openWhatsApp(phone, text){
      const p = sanitizePhone(phone);
      const encoded = encodeURIComponent(text || "");
      const isMobile = /Android|iPhone|iPad|iPod|IEMobile|WPDesktop/i.test(navigator.userAgent);

      // 1) wa.me (ุงูุฃูุซุฑ ุชูุงูููุง)
      const waMe = `https://wa.me/${p}?text=${encoded}`;

      // 2) web.whatsapp.com (ุจุฏูู ุนูู ุงูููุจููุชุฑ)
      const waWeb = `https://web.whatsapp.com/send?phone=${p}&text=${encoded}`;

      // 3) ุจุฑูุชูููู ุงูุชุทุจูู ูุจุงุดุฑุฉ (ูููุฏ ููุฌูุงู)
      const waProtocol = `whatsapp://send?phone=${p}&text=${encoded}`;

      // ูุญุงูู ุญุณุจ ุงูุฌูุงุฒ
      const tryUrls = isMobile ? [waProtocol, waMe, waWeb] : [waMe, waWeb, waProtocol];

      // ููุชุญ ุฃูู ุฑุงุจุทุ ุฅู ูุดูุ ูุฌุฑุจ ุงูุชุงูู
      let opened = false;
      for (const url of tryUrls){
        const win = window.open(url, "_blank", "noopener,noreferrer");
        if (win) { opened = true; break; }
      }
      if (!opened){
        // ูุณููุท ุฅูู ูุณุฎ ุงูุฑุณุงูุฉ ูุฏูููุง ูุน ุชูุจูู ุงููุณุชุฎุฏู
        const fallbackDiv = document.createElement("div");
        fallbackDiv.className = "toast";
        fallbackDiv.innerHTML = `โ๏ธ ุชุนุฐุฑ ูุชุญ ูุงุชุณุงุจ. ุชู ูุณุฎ ุงูุฑุณุงูุฉ - ุงูุชุญู ูุงุชุณุงุจ ูุฏูููุง ูุงูุตูู ุงูุฑุณุงูุฉ.`;
        document.body.appendChild(fallbackDiv);
        setTimeout(()=> fallbackDiv.remove(), 5000);
        
        if(navigator.clipboard){
          navigator.clipboard.writeText(text || "").catch(()=>{});
        }
      }
    }
    
    const contactBtn = document.getElementById("contactTeacher");
    if (contactBtn){
      contactBtn.addEventListener("click", ()=>{
        const name = (document.getElementById("pName")?.textContent || "").trim();
        const cls  = (document.getElementById("pClass")?.textContent || "").trim();

        const summaryEl = document.getElementById("pSummary");
        let totalText = "";
        if(summaryEl){
          const m = summaryEl.textContent.match(/ุงููุฌููุน ุงูููู.*?(\d+)\s*\/\s*100/);
          if(m) totalText = ` | ุงููุฌููุน: ${m[1]}/100`;
        }

        const msg = `ุงูุณูุงู ุนูููู ุฃุณุชุงุฐุชูุ ุฃูุง ููู ุฃูุฑ ุงูุทุงูุจุฉ: ${name} (ูุตู: ${cls})${totalText}. ุฃูุฏ ุงูุงุณุชูุณุงุฑ ุนู ุฃุฏุงุก ุงุจูุชู.`;
        
        // ูุชุญ ุงููุงุชุณุงุจ ูุจุงุดุฑุฉ
        openWhatsApp(TEACHER_WHATSAPP, msg);
      });
    }

    /* ================= Element SDK ================= */
    const defaultConfig = {
      main_title: "ูุชุงุจุนุฉ ูุฃุฏุงุก ุงูุทุงูุจุฉ ูู ูุงุฏุฉ ุชูููุฉ ุฑูููุฉ _ ูุนุงู 1447 ูู",
      subtitle: "ูุนููุฉ ุงููุงุฏุฉ / ุดุฐุง ุงูุฑุฏุงุฏู",
      teacher_button: "ุฏุฎูู ุงููุนููุฉ",
      student_button: "ููุญุฉ ุงูุทุงูุจุฉ",
      parent_button: "ููุญุฉ ูููู ุงูุฃูุฑ"
    };

    async function onConfigChange(config) {
      $("#mainTitle").textContent = config.main_title || defaultConfig.main_title;
      $("#subtitle").textContent = config.subtitle || defaultConfig.subtitle;
      $("#teacherBtnText").textContent = config.teacher_button || defaultConfig.teacher_button;
      $("#studentBtnText").textContent = config.student_button || defaultConfig.student_button;
      $("#parentBtnText").textContent = config.parent_button || defaultConfig.parent_button;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["main_title", config.main_title || defaultConfig.main_title],
          ["subtitle", config.subtitle || defaultConfig.subtitle],
          ["teacher_button", config.teacher_button || defaultConfig.teacher_button],
          ["student_button", config.student_button || defaultConfig.student_button],
          ["parent_button", config.parent_button || defaultConfig.parent_button]
        ])
      });
    }

    onConfigChange(defaultConfig);

    /* ================= ุชุญุณููุงุช ูุณูุฑุฉ ================= */
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && document.activeElement?.getAttribute("contenteditable")==="true"){
        e.preventDefault();
        const td = document.activeElement;
        let next = td.nextElementSibling;
        if(!next){
          const tr = td.parentElement.nextElementSibling;
          if(tr) next = tr.children[2];
        }
        if(next){ next.focus(); document.getSelection().selectAllChildren(next); }
      }
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9abb1c4bc58fce00',t:'MTc2NTM1MjU5OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
